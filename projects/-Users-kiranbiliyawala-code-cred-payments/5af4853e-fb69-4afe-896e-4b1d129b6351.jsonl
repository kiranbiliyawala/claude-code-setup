{"type":"file-history-snapshot","messageId":"fbd6984c-bacd-49a3-9301-9a716a3b0e69","snapshot":{"messageId":"fbd6984c-bacd-49a3-9301-9a716a3b0e69","trackedFileBackups":{},"timestamp":"2025-12-31T07:40:43.400Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","type":"user","message":{"role":"user","content":"Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to."},"isMeta":true,"uuid":"bb22baf7-33c3-4ca8-a29f-b84aedcadfdc","timestamp":"2025-12-31T07:40:43.398Z"}
{"parentUuid":"bb22baf7-33c3-4ca8-a29f-b84aedcadfdc","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","type":"user","message":{"role":"user","content":"<command-name>/clear</command-name>\n            <command-message>clear</command-message>\n            <command-args></command-args>"},"uuid":"fbd6984c-bacd-49a3-9301-9a716a3b0e69","timestamp":"2025-12-31T07:40:43.393Z"}
{"parentUuid":"fbd6984c-bacd-49a3-9301-9a716a3b0e69","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","type":"user","message":{"role":"user","content":"<local-command-stdout></local-command-stdout>"},"uuid":"7ab8e2d5-a249-45de-9a68-33f26b88eeb5","timestamp":"2025-12-31T07:40:43.397Z"}
{"type":"file-history-snapshot","messageId":"c7ea6886-856e-450e-81ca-f552ba25e079","snapshot":{"messageId":"c7ea6886-856e-450e-81ca-f552ba25e079","trackedFileBackups":{},"timestamp":"2025-12-31T07:40:52.387Z"},"isSnapshotUpdate":false}
{"parentUuid":"7ab8e2d5-a249-45de-9a68-33f26b88eeb5","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","type":"user","message":{"role":"user","content":"what changed in https://github.com/dreamplug-tech/payment-webhook-worker/pull/68/changes"},"uuid":"c7ea6886-856e-450e-81ca-f552ba25e079","timestamp":"2025-12-31T07:40:52.380Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]}}
{"parentUuid":"c7ea6886-856e-450e-81ca-f552ba25e079","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","message":{"model":"claude-opus-4-5-20251101","id":"msg_bdrk_01Agpf7GybGv5fDQsqzWqaD1","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants to know what changed in a GitHub pull request. Let me fetch the PR details and the files changed.","signature":"EpsCCkgICxABGAIqQD5dZXLvC+fuucXwsL7GjSd8X6vw/Z1JKIlsFUQgT6QVTD/QwYzvVy9ePVpmvKPTZMFtahIo1KwrXmGztFRo1GcSDF1u4rcS0ryyXHEGgRoMbO5xPUYRkM3cxfGnIjBkexsdE2JePgXA1+N8RklNW/sZUs8b6sT4o0jD/lYavn4+iEA1VEtvdYAU9HLZhh8qgAHk4ASnaN8/xCMn8y9nvIpUHRYPwTYD/5mBBxmTCOsj6nh2z0bIUinMlk/MsgYfIEN+6h8l4Q7t6WzYn56PHiK8LkNBGx0PbMElP/aobQ7IPZWxpqNRhfWNc1X9JAGs9v0+LAGgFI5Tu7McapmeruoA44RqcDbLghXMsmMB/g80sBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":3641,"cache_read_input_tokens":46064,"cache_creation":{"ephemeral_5m_input_tokens":3641,"ephemeral_1h_input_tokens":0},"output_tokens":3}},"type":"assistant","uuid":"6d31bd96-3a52-4981-9c8c-01ddc43ed986","timestamp":"2025-12-31T07:40:58.304Z"}
{"parentUuid":"6d31bd96-3a52-4981-9c8c-01ddc43ed986","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","message":{"model":"claude-opus-4-5-20251101","id":"msg_bdrk_01Agpf7GybGv5fDQsqzWqaD1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_bdrk_01JV5rGRBeGtB38Lk39zSKEe","name":"mcp__github__get_pull_request","input":{"owner":"dreamplug-tech","repo":"payment-webhook-worker","pull_number":68}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":3641,"cache_read_input_tokens":46064,"cache_creation":{"ephemeral_5m_input_tokens":3641,"ephemeral_1h_input_tokens":0},"output_tokens":3}},"type":"assistant","uuid":"060201d5-3657-4f19-a4da-ed802c5ae3c2","timestamp":"2025-12-31T07:40:59.009Z"}
{"parentUuid":"060201d5-3657-4f19-a4da-ed802c5ae3c2","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","message":{"model":"claude-opus-4-5-20251101","id":"msg_bdrk_01Agpf7GybGv5fDQsqzWqaD1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_bdrk_012iy2PvqEYrv3CRwYzEU9cK","name":"mcp__github__get_pull_request_files","input":{"owner":"dreamplug-tech","repo":"payment-webhook-worker","pull_number":68}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":3641,"cache_read_input_tokens":46064,"cache_creation":{"ephemeral_5m_input_tokens":3641,"ephemeral_1h_input_tokens":0},"output_tokens":225}},"type":"assistant","uuid":"5eadc721-4e62-4ea5-bad1-30354652a422","timestamp":"2025-12-31T07:40:59.526Z"}
{"parentUuid":"5eadc721-4e62-4ea5-bad1-30354652a422","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"MCP error -32603: Authentication Failed: Bad credentials","is_error":true,"tool_use_id":"toolu_bdrk_01JV5rGRBeGtB38Lk39zSKEe"}]},"uuid":"45f7d6a3-8f18-460b-9e3b-8d1cd553b5ec","timestamp":"2025-12-31T07:41:00.058Z","toolUseResult":"Error: MCP error -32603: Authentication Failed: Bad credentials"}
{"parentUuid":"45f7d6a3-8f18-460b-9e3b-8d1cd553b5ec","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"MCP error -32603: Authentication Failed: Bad credentials","is_error":true,"tool_use_id":"toolu_bdrk_012iy2PvqEYrv3CRwYzEU9cK"}]},"uuid":"619928bb-6642-4d81-8d7a-514bd2f6cef6","timestamp":"2025-12-31T07:41:00.432Z","toolUseResult":"Error: MCP error -32603: Authentication Failed: Bad credentials"}
{"parentUuid":"619928bb-6642-4d81-8d7a-514bd2f6cef6","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","message":{"model":"claude-opus-4-5-20251101","id":"msg_bdrk_019g7BL2GEKAkmTF9s4wp4EW","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The GitHub MCP tool failed due to authentication issues. Let me try using the gh CLI instead which might have different credentials configured.","signature":"EroCCkgICxABGAIqQP1PpzWrsPv5Zo4sPAVGxjKShy8rYNlVKn3LoZ9zfP8dgoZEk7mqZ8g2PXkEI3fHNlDG3sF+Pu52cJsWMT19FSQSDANOqK209g8v/6XCCxoMYP6hsQ5Nn44OewQ4IjAhN/Eo/nsHfCZuaueVM6erTMepYT2SRGD9VF2nO/x9IL2SYo/PfAUoMsnnzbKQkMMqnwFv2H4XKvJCDDAt9bm/BM8IyejCMMAHwGqOmCbSdfDg1cU3EbEPE8MRvGg80H+EiXAGDZh7MxaSKTyOAPmgZHuX0fHiWIN3FFL+aLNKxJsMzRuRf87Wou7FKAIuJb9d19DcJ1HLa3xD86AeOdibhtJnqousPOT4MNfMnn2W2aep4vCQQF+q0Pb0RRkBjZCss16iC7sDG7OtWVxFWqYHAaAYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":337,"cache_read_input_tokens":49705,"cache_creation":{"ephemeral_5m_input_tokens":337,"ephemeral_1h_input_tokens":0},"output_tokens":2}},"type":"assistant","uuid":"4cde1c8f-abe8-4ca0-90cf-421de4b6640e","timestamp":"2025-12-31T07:41:09.244Z"}
{"parentUuid":"4cde1c8f-abe8-4ca0-90cf-421de4b6640e","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","message":{"model":"claude-opus-4-5-20251101","id":"msg_bdrk_019g7BL2GEKAkmTF9s4wp4EW","type":"message","role":"assistant","content":[{"type":"text","text":"Let me try using the GitHub CLI instead:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":337,"cache_read_input_tokens":49705,"cache_creation":{"ephemeral_5m_input_tokens":337,"ephemeral_1h_input_tokens":0},"output_tokens":2}},"type":"assistant","uuid":"b59544bd-ed7a-479d-9c16-0afe788b97b6","timestamp":"2025-12-31T07:41:09.349Z"}
{"parentUuid":"b59544bd-ed7a-479d-9c16-0afe788b97b6","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","message":{"model":"claude-opus-4-5-20251101","id":"msg_bdrk_019g7BL2GEKAkmTF9s4wp4EW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_bdrk_01Vbggtc27ozSmdFbeW4Frre","name":"Bash","input":{"command":"gh pr view 68 --repo dreamplug-tech/payment-webhook-worker","description":"View PR #68 details"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":337,"cache_read_input_tokens":49705,"cache_creation":{"ephemeral_5m_input_tokens":337,"ephemeral_1h_input_tokens":0},"output_tokens":2}},"type":"assistant","uuid":"03cc4750-db74-49ae-8f76-d37cd5bd6be8","timestamp":"2025-12-31T07:41:10.010Z"}
{"parentUuid":"03cc4750-db74-49ae-8f76-d37cd5bd6be8","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","message":{"model":"claude-opus-4-5-20251101","id":"msg_bdrk_019g7BL2GEKAkmTF9s4wp4EW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_bdrk_01Q9fdddexAjiGFV7xh2zrNf","name":"Bash","input":{"command":"gh pr diff 68 --repo dreamplug-tech/payment-webhook-worker","description":"Get PR #68 diff"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":337,"cache_read_input_tokens":49705,"cache_creation":{"ephemeral_5m_input_tokens":337,"ephemeral_1h_input_tokens":0},"output_tokens":211}},"type":"assistant","uuid":"71d28bcf-28a7-4727-97ec-21b861113e28","timestamp":"2025-12-31T07:41:10.490Z"}
{"parentUuid":"71d28bcf-28a7-4727-97ec-21b861113e28","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"Exit code 1\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n\r  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\r100   120    0   120    0     0    390      0 --:--:-- --:--:-- --:--:--   389\r100   120    0   120    0     0    386      0 --:--:-- --:--:-- --:--:--   385\nGraphQL: Projects (classic) is being deprecated in favor of the new Projects experience, see: https://github.blog/changelog/2024-05-23-sunset-notice-projects-classic/. (repository.pullRequest.projectCards)","is_error":true,"tool_use_id":"toolu_bdrk_01Vbggtc27ozSmdFbeW4Frre"}]},"uuid":"a2e7eb4f-18da-4fbc-81e3-1cf9441f2e18","timestamp":"2025-12-31T07:41:12.084Z","toolUseResult":"Error: Exit code 1\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n\r  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\r100   120    0   120    0     0    390      0 --:--:-- --:--:-- --:--:--   389\r100   120    0   120    0     0    386      0 --:--:-- --:--:-- --:--:--   385\nGraphQL: Projects (classic) is being deprecated in favor of the new Projects experience, see: https://github.blog/changelog/2024-05-23-sunset-notice-projects-classic/. (repository.pullRequest.projectCards)"}
{"parentUuid":"a2e7eb4f-18da-4fbc-81e3-1cf9441f2e18","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_bdrk_01Q9fdddexAjiGFV7xh2zrNf","type":"tool_result","content":"diff --git a/build.gradle b/build.gradle\nindex 5a0bf00..66ea1c0 100644\n--- a/build.gradle\n+++ b/build.gradle\n@@ -32,6 +32,7 @@ ext {\n dependencies {\n \timplementation 'org.springframework.boot:spring-boot-starter'\n \timplementation 'org.springframework.boot:spring-boot-starter-actuator'\n+\timplementation 'io.micrometer:micrometer-registry-prometheus'\n \timplementation group: 'com.datadoghq', name: 'dd-trace-api', version: '0.90.0'\n \tcompileOnly 'org.projectlombok:lombok'\n \tannotationProcessor 'org.projectlombok:lombok'\ndiff --git a/codepipeline/configs/common.yaml b/codepipeline/configs/common.yaml\nindex e826538..a326d6e 100644\n--- a/codepipeline/configs/common.yaml\n+++ b/codepipeline/configs/common.yaml\n@@ -3,6 +3,9 @@ path: \"/\"\n container_port: 6000\n alb_scheme: internal\n health_check_path: \"/payment-webhook-worker/actuator/health\"\n+service_metrics_enabled: true\n+metrics_path: \"/payment-webhook-worker/actuator/prometheus\"\n+metrics_port: 6000\n tags:\n   pod: cred_pay\n   sub_pod: consumer\n@@ -42,7 +45,8 @@ container_environment:\n               \"v1/MANDATE_SERVICE_URL\": {},\n               \"v1/MANDATE_SERVICE_TOKEN\": {},\n               \"v1/PAYMENT_SERVICE_TOKEN\": {},\n-              \"v1/BILLDESK_BASE_URL\": {}\n+              \"v1/BILLDESK_BASE_URL\": {},\n+              \"v1/METRICS_ENABLED\": {}\n             }\n           }\n         ]\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/constants/MetricsConstants.java b/src/main/java/in/dreamplug/paymentwebhookworker/constants/MetricsConstants.java\nnew file mode 100644\nindex 0000000..07b4d1e\n--- /dev/null\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/constants/MetricsConstants.java\n@@ -0,0 +1,28 @@\n+package in.dreamplug.paymentwebhookworker.constants;\n+\n+public class MetricsConstants {\n+\n+    private MetricsConstants() {\n+        // Private constructor to prevent instantiation\n+    }\n+\n+    public static final String SQS_PARK_TIME_METRIC = \"sqs.message.park_time\";\n+    public static final String SQS_PROCESSING_TIME_METRIC = \"sqs.message.processing_time\";\n+    public static final String SQS_MESSAGE_COUNT = \"sqs.message.count\";\n+\n+    public static final String TAG_QUEUE_NAME = \"queue_name\";\n+    public static final String TAG_STATUS = \"status\";\n+    public static final String TAG_RETRY_COUNT = \"retry_count\";\n+\n+    public static final String STATUS_RECEIVED = \"received\";\n+    public static final String STATUS_SUCCESS = \"success\";\n+    public static final String STATUS_FAILED = \"failed\";\n+\n+    public static final String QUEUE_WEBHOOK_PROCESSING = \"webhook-processing\";\n+    public static final String QUEUE_ASYNC_REGULATED_PROCESSING = \"async-regulated-processing\";\n+    public static final String QUEUE_UNKNOWN = \"unknown\";\n+    public static final String RETRY_COUNT_UNKNOWN = \"UNKNOWN\";\n+\n+    public static final String SQS_ATTR_SENT_TIMESTAMP = \"SentTimestamp\";\n+    public static final String SQS_ATTR_APPROXIMATE_RECEIVE_COUNT = \"ApproximateReceiveCount\";\n+}\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/metrics/MetricsCollector.java b/src/main/java/in/dreamplug/paymentwebhookworker/metrics/MetricsCollector.java\nnew file mode 100644\nindex 0000000..a4963d4\n--- /dev/null\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/metrics/MetricsCollector.java\n@@ -0,0 +1,105 @@\n+package in.dreamplug.paymentwebhookworker.metrics;\n+\n+import com.amazonaws.services.sqs.model.Message;\n+import in.dreamplug.commons.springboot.metrics.StatsDMetricAdapter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.Objects;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+\n+import static in.dreamplug.paymentwebhookworker.constants.MetricsConstants.*;\n+\n+@Slf4j\n+@Component\n+@RequiredArgsConstructor(onConstructor_ = {@Autowired})\n+public class MetricsCollector {\n+    private final StatsDMetricAdapter statsDMetricAdapter;\n+\n+    @Value(\"${metrics.enabled:false}\")\n+    private boolean metricsEnabled;\n+\n+    public void recordSQSMessageReceived(String queueName, Message message) {\n+        if (!metricsEnabled || message == null) {\n+            return;\n+        }\n+\n+        recordParkTime(queueName, message);\n+        recordMessageCount(queueName, STATUS_RECEIVED, message);\n+    }\n+\n+    public void recordSQSMessageCompleted(String queueName, long processingTimeMs, String status, Message message) {\n+        if (!metricsEnabled || message == null) {\n+            return;\n+        }\n+\n+        recordMessageCount(queueName, status, message);\n+        recordProcessingTime(queueName, processingTimeMs, status, message);\n+    }\n+\n+    private void recordParkTime(String queueName, Message message) {\n+        try {\n+            String timestamp = message.getAttributes().get(SQS_ATTR_SENT_TIMESTAMP);\n+            if (timestamp == null) {\n+                return;\n+            }\n+\n+            SortedMap<String, String> tags = createSQSTags(queueName, message);\n+            long parkTimeMs = System.currentTimeMillis() - Long.parseLong(timestamp);\n+            statsDMetricAdapter.gauge(SQS_PARK_TIME_METRIC, parkTimeMs, tags);\n+        } catch (Exception e) {\n+            log.warn(\"Error recording park time: {}\", e.getMessage());\n+        }\n+    }\n+\n+    private void recordMessageCount(String queueName, String status, Message message) {\n+        try {\n+            SortedMap<String, String> tags = createSQSTags(queueName, message, TAG_STATUS, status);\n+            statsDMetricAdapter.inc(SQS_MESSAGE_COUNT, tags);\n+        } catch (Exception e) {\n+            log.warn(\"Error recording message count: {}\", e.getMessage());\n+        }\n+    }\n+\n+    private void recordProcessingTime(String queueName, long processingTimeMs, String status, Message message) {\n+        try {\n+            SortedMap<String, String> tags = createSQSTags(queueName, message, TAG_STATUS, status);\n+            statsDMetricAdapter.gauge(SQS_PROCESSING_TIME_METRIC, processingTimeMs, tags);\n+        } catch (Exception e) {\n+            log.warn(\"Error recording processing time: {}\", e.getMessage());\n+        }\n+    }\n+\n+    private SortedMap<String, String> createTags(String... keyValuePairs) {\n+        SortedMap<String, String> tags = new TreeMap<>();\n+        if (keyValuePairs.length % 2 != 0) {\n+            throw new IllegalArgumentException(\"keyValuePairs must be even (key-value pairs)\");\n+        }\n+        for (int i = 0; i < keyValuePairs.length; i += 2) {\n+            tags.put(keyValuePairs[i], keyValuePairs[i + 1]);\n+        }\n+        return tags;\n+    }\n+\n+    private SortedMap<String, String> createSQSTags(String queueName, Message message, String... additionalKeyValuePairs) {\n+        String retryCount = message.getAttributes().get(SQS_ATTR_APPROXIMATE_RECEIVE_COUNT);\n+\n+        SortedMap<String, String> tags = new TreeMap<>();\n+        tags.put(TAG_QUEUE_NAME, Objects.requireNonNullElse(queueName, QUEUE_UNKNOWN));\n+        tags.put(TAG_RETRY_COUNT, Objects.requireNonNullElse(retryCount, RETRY_COUNT_UNKNOWN));\n+\n+        // Add any additional tags\n+        if (additionalKeyValuePairs.length % 2 != 0) {\n+            throw new IllegalArgumentException(\"additionalKeyValuePairs must be even (key-value pairs)\");\n+        }\n+        for (int i = 0; i < additionalKeyValuePairs.length; i += 2) {\n+            tags.put(additionalKeyValuePairs[i], additionalKeyValuePairs[i + 1]);\n+        }\n+\n+        return tags;\n+    }\n+}\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/AsyncRegulatedWebhookEventReceiver.java b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/AsyncRegulatedWebhookEventReceiver.java\nindex 269174e..092f7f0 100644\n--- a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/AsyncRegulatedWebhookEventReceiver.java\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/AsyncRegulatedWebhookEventReceiver.java\n@@ -7,6 +7,7 @@\n import in.dreamplug.commons.aws.sqs.exception.NonRetriableException;\n import in.dreamplug.commons.aws.sqs.exception.RetriableException;\n import in.dreamplug.paymentwebhookworker.constants.Constants;\n+import in.dreamplug.paymentwebhookworker.constants.MetricsConstants;\n import in.dreamplug.paymentwebhookworker.dto.WebhookEvent;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandler;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandlerFactory;\n@@ -24,7 +25,7 @@\n \n @Component\n @Slf4j\n-@RequiredArgsConstructor(onConstructor_ = { @Autowired })\n+@RequiredArgsConstructor(onConstructor_ = {@Autowired})\n public class AsyncRegulatedWebhookEventReceiver extends WebhookSQSMessageReceiver {\n \n     @NonNull\n@@ -33,13 +34,19 @@ public class AsyncRegulatedWebhookEventReceiver extends WebhookSQSMessageReceive\n     @NonNull\n     private final WebhookPublisher webhookRetryPublisher;\n \n+    @Override\n+    protected String getQueueName() {\n+        return MetricsConstants.QUEUE_ASYNC_REGULATED_PROCESSING;\n+    }\n+\n     @Override\n     @Trace(operationName = \"payment.webhook.asyncregulated.event\")\n-    void receive(Message message) throws RetriableException, NonRetriableException, JsonProcessingException {\n+    protected void receive(Message message) throws RetriableException, NonRetriableException, JsonProcessingException {\n         String event = message.getBody();\n \n-        log.info(\"Async regulated webhook event received : {}\", StringUtils.fromJson(event));\n-        WebhookEvent eventData = null;\n+        log.info(\"Async regulated webhook event received: {}\", StringUtils.fromJson(event));\n+\n+        WebhookEvent eventData;\n         try {\n             eventData = JacksonObjectMapper.getInstance().readValue(event, new TypeReference<WebhookEvent>() {\n             });\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookEventReceiver.java b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookEventReceiver.java\nindex 7d74b37..330bb0a 100644\n--- a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookEventReceiver.java\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookEventReceiver.java\n@@ -7,10 +7,10 @@\n import in.dreamplug.commons.aws.sqs.exception.RetriableException;\n import in.dreamplug.payments.domain.PaymentProviderKey;\n import in.dreamplug.paymentwebhookworker.constants.Constants;\n+import in.dreamplug.paymentwebhookworker.constants.MetricsConstants;\n import in.dreamplug.paymentwebhookworker.dto.WebhookEvent;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandler;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandlerFactory;\n-import in.dreamplug.paymentwebhookworker.handler.razorpay.RazorpayWebhookHandler;\n import in.dreamplug.paymentwebhookworker.queue.publisher.WebhookPublisher;\n import in.dreamplug.paymentwebhookworker.utils.StringUtils;\n import in.dreamplug.river.commons.utils.JacksonObjectMapper;\n@@ -24,7 +24,7 @@\n \n @Component\n @Slf4j\n-@RequiredArgsConstructor(onConstructor_ = { @Autowired })\n+@RequiredArgsConstructor(onConstructor_ = {@Autowired})\n public class WebhookEventReceiver extends WebhookSQSMessageReceiver {\n \n     @NonNull\n@@ -33,6 +33,11 @@ public class WebhookEventReceiver extends WebhookSQSMessageReceiver {\n     @NonNull\n     private final WebhookPublisher webhookRetryPublisher;\n \n+    @Override\n+    protected String getQueueName() {\n+        return MetricsConstants.QUEUE_WEBHOOK_PROCESSING;\n+    }\n+\n     @Override\n     @Trace(operationName = \"payment.webhook.event\")\n     public void receive(Message message) throws RetriableException, NonRetriableException {\n@@ -45,12 +50,12 @@ public void receive(Message message) throws RetriableException, NonRetriableExce\n             eventData = JacksonObjectMapper.getInstance().readValue(event, new TypeReference<WebhookEvent>() {\n             });\n         } catch (Exception e) {\n-            log.error(\"Exception is parsing webhook data\", e);\n+            log.error(\"Exception in parsing webhook data\", e);\n             webhookRetryPublisher.pushWebhookEventToRealtimeDLQ(event);\n             throw new NonRetriableException();\n         }\n \n-        if (Objects.isNull(eventData.getData())\n+        if (eventData == null || Objects.isNull(eventData.getData())\n                 || (eventData.getErrorMessage() != null && eventData.getErrorMessage().length > 0)\n                 || !Constants.ENTITY_TYPE.equals(eventData.getEntityType())) {\n             log.error(\"Invalid data received in webhook {}\", StringUtils.fromJson(eventData));\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookSQSMessageReceiver.java b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookSQSMessageReceiver.java\nindex 5f5b4d4..f2a8a26 100644\n--- a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookSQSMessageReceiver.java\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookSQSMessageReceiver.java\n@@ -2,27 +2,57 @@\n \n import com.amazonaws.services.sqs.model.Message;\n import com.fasterxml.jackson.core.JsonProcessingException;\n-import in.dreamplug.paymentwebhookworker.utils.MDCUtils;\n import in.dreamplug.commons.aws.sqs.exception.NonRetriableException;\n import in.dreamplug.commons.aws.sqs.exception.RetriableException;\n import in.dreamplug.commons.aws.sqs.receiver.SQSMessageReceiver;\n import in.dreamplug.paymentwebhookworker.constants.Constants;\n+import in.dreamplug.paymentwebhookworker.constants.MetricsConstants;\n+import in.dreamplug.paymentwebhookworker.metrics.MetricsCollector;\n+import in.dreamplug.paymentwebhookworker.utils.MDCUtils;\n+import lombok.extern.slf4j.Slf4j;\n import org.slf4j.MDC;\n+import org.springframework.beans.factory.annotation.Autowired;\n \n+@Slf4j\n public abstract class WebhookSQSMessageReceiver implements SQSMessageReceiver {\n \n+    @Autowired\n+    private MetricsCollector metricsCollector;\n+\n     @Override\n     public void receiveMessage(Message message) throws RetriableException, NonRetriableException {\n+        String queueName = getQueueName();\n+        metricsCollector.recordSQSMessageReceived(queueName, message);\n+\n+        String status = null;\n+        long processingStartTime = System.currentTimeMillis();\n+\n         try {\n             MDCUtils.addTraceIdsToMDC();\n             MDC.put(Constants.HEADER_SOURCE, \"SQS\");\n             this.receive(message);\n+            status = MetricsConstants.STATUS_SUCCESS;\n         } catch (JsonProcessingException e) {\n-            throw new RuntimeException(e);\n+            status = MetricsConstants.STATUS_FAILED;\n+            log.error(\"JSON processing failed for message\", e);\n+            throw new NonRetriableException(e);\n+        } catch (Exception e) {\n+            status = MetricsConstants.STATUS_FAILED;\n+            throw e;\n         } finally {\n+            if (status != null) {\n+                metricsCollector.recordSQSMessageCompleted(queueName,\n+                        System.currentTimeMillis() - processingStartTime, status, message);\n+            }\n             MDCUtils.clearMDCMap();\n         }\n     }\n \n+    /**\n+     * Get the queue name for this receiver\n+     */\n+    protected abstract String getQueueName();\n+\n+\n     abstract void receive(Message message) throws RetriableException, NonRetriableException, JsonProcessingException;\n }\n\\ No newline at end of file\ndiff --git a/src/main/resources/application.properties b/src/main/resources/application.properties\nindex cf25023..7dcb1a0 100644\n--- a/src/main/resources/application.properties\n+++ b/src/main/resources/application.properties\n@@ -3,7 +3,7 @@ server.servlet.context-path=/payment-webhook-worker\n \n management.endpoint.health.enabled=true\n management.endpoint.health.show-details=always\n-management.endpoints.web.exposure.include=${SPRINGBOOT_ACTUATOR_ENDPOINTS:info,health,metrics,mappings,scheduledtasks}\n+management.endpoints.web.exposure.include=${SPRINGBOOT_ACTUATOR_ENDPOINTS:info,health,metrics,prometheus,mappings,scheduledtasks}\n management.metrics.export.cloudwatch.namespace=${DP_SERVICE_NAME:payment-webhook-worker}\n management.metrics.export.cloudwatch.batchSize=20\n management.metrics.export.cloudwatch.enabled=true\n@@ -30,6 +30,8 @@ statsd.configuration.pushInterval=10\n statsd.configuration.enabled=${STATS_ENABLED:true}\n statsd.configuration.serviceName=payment-webhook-worker\n \n+metrics.enabled=${METRICS_ENABLED:false}\n+\n clients.paymentservice.configuration.url:${PAYMENT_SERVICE_URL:http://payment-service.stg.dreamplug.net/payments}\n clients.paymentservice.configuration.requestTimeoutInMs= 10000\n clients.paymentservice.configuration.client_token=${PAYMENT_SERVICE_TOKEN:dev}\ndiff --git a/src/test/java/queue/receiver/AsyncRegulatedWebhookEventReceiverTest.java b/src/test/java/queue/receiver/AsyncRegulatedWebhookEventReceiverTest.java\nindex 538effd..bd29be5 100644\n--- a/src/test/java/queue/receiver/AsyncRegulatedWebhookEventReceiverTest.java\n+++ b/src/test/java/queue/receiver/AsyncRegulatedWebhookEventReceiverTest.java\n@@ -9,6 +9,7 @@\n import in.dreamplug.paymentwebhookworker.dto.WebhookEvent;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandler;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandlerFactory;\n+import in.dreamplug.paymentwebhookworker.metrics.MetricsCollector;\n import in.dreamplug.paymentwebhookworker.queue.publisher.WebhookPublisher;\n import in.dreamplug.paymentwebhookworker.queue.receiver.AsyncRegulatedWebhookEventReceiver;\n import in.dreamplug.river.commons.utils.JacksonObjectMapper;\n@@ -17,6 +18,7 @@\n import org.junit.jupiter.api.extension.ExtendWith;\n import org.mockito.Mock;\n import org.mockito.junit.jupiter.MockitoExtension;\n+import org.springframework.test.util.ReflectionTestUtils;\n \n import static org.junit.jupiter.api.Assertions.assertThrows;\n import static org.mockito.ArgumentMatchers.any;\n@@ -37,6 +39,9 @@ public class AsyncRegulatedWebhookEventReceiverTest {\n     @Mock\n     private WebhookHandler webhookHandler;\n \n+    @Mock\n+    private MetricsCollector metricsCollector;\n+\n     private AsyncRegulatedWebhookEventReceiver asyncRegulatedWebhookEventReceiver;\n \n     @BeforeEach\n@@ -45,6 +50,8 @@ void setUp() {\n                 webhookHandlerFactory,\n                 webhookRetryPublisher\n         );\n+        // Inject the mock metrics collector into the parent class\n+        ReflectionTestUtils.setField(asyncRegulatedWebhookEventReceiver, \"metricsCollector\", metricsCollector);\n     }\n \n     @Test\ndiff --git a/src/test/java/queue/receiver/WebhookEventReceiverRoutingTest.java b/src/test/java/queue/receiver/WebhookEventReceiverRoutingTest.java\nindex 1df89e3..a259450 100644\n--- a/src/test/java/queue/receiver/WebhookEventReceiverRoutingTest.java\n+++ b/src/test/java/queue/receiver/WebhookEventReceiverRoutingTest.java\n@@ -8,6 +8,7 @@\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandler;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandlerFactory;\n import in.dreamplug.paymentwebhookworker.handler.razorpay.RazorpayWebhookHandler;\n+import in.dreamplug.paymentwebhookworker.metrics.MetricsCollector;\n import in.dreamplug.paymentwebhookworker.queue.publisher.WebhookPublisher;\n import in.dreamplug.paymentwebhookworker.queue.receiver.WebhookEventReceiver;\n import in.dreamplug.river.commons.utils.JacksonObjectMapper;\n@@ -16,6 +17,7 @@\n import org.junit.jupiter.api.extension.ExtendWith;\n import org.mockito.Mock;\n import org.mockito.junit.jupiter.MockitoExtension;\n+import org.springframework.test.util.ReflectionTestUtils;\n \n import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.ArgumentMatchers.eq;\n@@ -38,11 +40,16 @@ public class WebhookEventReceiverRoutingTest {\n     @Mock\n     private WebhookHandler otherWebhookHandler;\n \n+    @Mock\n+    private MetricsCollector metricsCollector;\n+\n     private WebhookEventReceiver webhookEventReceiver;\n \n     @BeforeEach\n     void setUp() {\n         webhookEventReceiver = new WebhookEventReceiver(webhookHandlerFactory, webhookRetryPublisher);\n+        // Inject the mock metrics collector into the parent class\n+        ReflectionTestUtils.setField(webhookEventReceiver, \"metricsCollector\", metricsCollector);\n     }\n \n     @Test\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n\r  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\r100   120    0   120    0     0    598      0 --:--:-- --:--:-- --:--:--   600","is_error":false}]},"uuid":"8895dd32-385d-45ae-a514-1b2f5c192aa5","timestamp":"2025-12-31T07:41:13.284Z","toolUseResult":{"stdout":"diff --git a/build.gradle b/build.gradle\nindex 5a0bf00..66ea1c0 100644\n--- a/build.gradle\n+++ b/build.gradle\n@@ -32,6 +32,7 @@ ext {\n dependencies {\n \timplementation 'org.springframework.boot:spring-boot-starter'\n \timplementation 'org.springframework.boot:spring-boot-starter-actuator'\n+\timplementation 'io.micrometer:micrometer-registry-prometheus'\n \timplementation group: 'com.datadoghq', name: 'dd-trace-api', version: '0.90.0'\n \tcompileOnly 'org.projectlombok:lombok'\n \tannotationProcessor 'org.projectlombok:lombok'\ndiff --git a/codepipeline/configs/common.yaml b/codepipeline/configs/common.yaml\nindex e826538..a326d6e 100644\n--- a/codepipeline/configs/common.yaml\n+++ b/codepipeline/configs/common.yaml\n@@ -3,6 +3,9 @@ path: \"/\"\n container_port: 6000\n alb_scheme: internal\n health_check_path: \"/payment-webhook-worker/actuator/health\"\n+service_metrics_enabled: true\n+metrics_path: \"/payment-webhook-worker/actuator/prometheus\"\n+metrics_port: 6000\n tags:\n   pod: cred_pay\n   sub_pod: consumer\n@@ -42,7 +45,8 @@ container_environment:\n               \"v1/MANDATE_SERVICE_URL\": {},\n               \"v1/MANDATE_SERVICE_TOKEN\": {},\n               \"v1/PAYMENT_SERVICE_TOKEN\": {},\n-              \"v1/BILLDESK_BASE_URL\": {}\n+              \"v1/BILLDESK_BASE_URL\": {},\n+              \"v1/METRICS_ENABLED\": {}\n             }\n           }\n         ]\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/constants/MetricsConstants.java b/src/main/java/in/dreamplug/paymentwebhookworker/constants/MetricsConstants.java\nnew file mode 100644\nindex 0000000..07b4d1e\n--- /dev/null\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/constants/MetricsConstants.java\n@@ -0,0 +1,28 @@\n+package in.dreamplug.paymentwebhookworker.constants;\n+\n+public class MetricsConstants {\n+\n+    private MetricsConstants() {\n+        // Private constructor to prevent instantiation\n+    }\n+\n+    public static final String SQS_PARK_TIME_METRIC = \"sqs.message.park_time\";\n+    public static final String SQS_PROCESSING_TIME_METRIC = \"sqs.message.processing_time\";\n+    public static final String SQS_MESSAGE_COUNT = \"sqs.message.count\";\n+\n+    public static final String TAG_QUEUE_NAME = \"queue_name\";\n+    public static final String TAG_STATUS = \"status\";\n+    public static final String TAG_RETRY_COUNT = \"retry_count\";\n+\n+    public static final String STATUS_RECEIVED = \"received\";\n+    public static final String STATUS_SUCCESS = \"success\";\n+    public static final String STATUS_FAILED = \"failed\";\n+\n+    public static final String QUEUE_WEBHOOK_PROCESSING = \"webhook-processing\";\n+    public static final String QUEUE_ASYNC_REGULATED_PROCESSING = \"async-regulated-processing\";\n+    public static final String QUEUE_UNKNOWN = \"unknown\";\n+    public static final String RETRY_COUNT_UNKNOWN = \"UNKNOWN\";\n+\n+    public static final String SQS_ATTR_SENT_TIMESTAMP = \"SentTimestamp\";\n+    public static final String SQS_ATTR_APPROXIMATE_RECEIVE_COUNT = \"ApproximateReceiveCount\";\n+}\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/metrics/MetricsCollector.java b/src/main/java/in/dreamplug/paymentwebhookworker/metrics/MetricsCollector.java\nnew file mode 100644\nindex 0000000..a4963d4\n--- /dev/null\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/metrics/MetricsCollector.java\n@@ -0,0 +1,105 @@\n+package in.dreamplug.paymentwebhookworker.metrics;\n+\n+import com.amazonaws.services.sqs.model.Message;\n+import in.dreamplug.commons.springboot.metrics.StatsDMetricAdapter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.Objects;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+\n+import static in.dreamplug.paymentwebhookworker.constants.MetricsConstants.*;\n+\n+@Slf4j\n+@Component\n+@RequiredArgsConstructor(onConstructor_ = {@Autowired})\n+public class MetricsCollector {\n+    private final StatsDMetricAdapter statsDMetricAdapter;\n+\n+    @Value(\"${metrics.enabled:false}\")\n+    private boolean metricsEnabled;\n+\n+    public void recordSQSMessageReceived(String queueName, Message message) {\n+        if (!metricsEnabled || message == null) {\n+            return;\n+        }\n+\n+        recordParkTime(queueName, message);\n+        recordMessageCount(queueName, STATUS_RECEIVED, message);\n+    }\n+\n+    public void recordSQSMessageCompleted(String queueName, long processingTimeMs, String status, Message message) {\n+        if (!metricsEnabled || message == null) {\n+            return;\n+        }\n+\n+        recordMessageCount(queueName, status, message);\n+        recordProcessingTime(queueName, processingTimeMs, status, message);\n+    }\n+\n+    private void recordParkTime(String queueName, Message message) {\n+        try {\n+            String timestamp = message.getAttributes().get(SQS_ATTR_SENT_TIMESTAMP);\n+            if (timestamp == null) {\n+                return;\n+            }\n+\n+            SortedMap<String, String> tags = createSQSTags(queueName, message);\n+            long parkTimeMs = System.currentTimeMillis() - Long.parseLong(timestamp);\n+            statsDMetricAdapter.gauge(SQS_PARK_TIME_METRIC, parkTimeMs, tags);\n+        } catch (Exception e) {\n+            log.warn(\"Error recording park time: {}\", e.getMessage());\n+        }\n+    }\n+\n+    private void recordMessageCount(String queueName, String status, Message message) {\n+        try {\n+            SortedMap<String, String> tags = createSQSTags(queueName, message, TAG_STATUS, status);\n+            statsDMetricAdapter.inc(SQS_MESSAGE_COUNT, tags);\n+        } catch (Exception e) {\n+            log.warn(\"Error recording message count: {}\", e.getMessage());\n+        }\n+    }\n+\n+    private void recordProcessingTime(String queueName, long processingTimeMs, String status, Message message) {\n+        try {\n+            SortedMap<String, String> tags = createSQSTags(queueName, message, TAG_STATUS, status);\n+            statsDMetricAdapter.gauge(SQS_PROCESSING_TIME_METRIC, processingTimeMs, tags);\n+        } catch (Exception e) {\n+            log.warn(\"Error recording processing time: {}\", e.getMessage());\n+        }\n+    }\n+\n+    private SortedMap<String, String> createTags(String... keyValuePairs) {\n+        SortedMap<String, String> tags = new TreeMap<>();\n+        if (keyValuePairs.length % 2 != 0) {\n+            throw new IllegalArgumentException(\"keyValuePairs must be even (key-value pairs)\");\n+        }\n+        for (int i = 0; i < keyValuePairs.length; i += 2) {\n+            tags.put(keyValuePairs[i], keyValuePairs[i + 1]);\n+        }\n+        return tags;\n+    }\n+\n+    private SortedMap<String, String> createSQSTags(String queueName, Message message, String... additionalKeyValuePairs) {\n+        String retryCount = message.getAttributes().get(SQS_ATTR_APPROXIMATE_RECEIVE_COUNT);\n+\n+        SortedMap<String, String> tags = new TreeMap<>();\n+        tags.put(TAG_QUEUE_NAME, Objects.requireNonNullElse(queueName, QUEUE_UNKNOWN));\n+        tags.put(TAG_RETRY_COUNT, Objects.requireNonNullElse(retryCount, RETRY_COUNT_UNKNOWN));\n+\n+        // Add any additional tags\n+        if (additionalKeyValuePairs.length % 2 != 0) {\n+            throw new IllegalArgumentException(\"additionalKeyValuePairs must be even (key-value pairs)\");\n+        }\n+        for (int i = 0; i < additionalKeyValuePairs.length; i += 2) {\n+            tags.put(additionalKeyValuePairs[i], additionalKeyValuePairs[i + 1]);\n+        }\n+\n+        return tags;\n+    }\n+}\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/AsyncRegulatedWebhookEventReceiver.java b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/AsyncRegulatedWebhookEventReceiver.java\nindex 269174e..092f7f0 100644\n--- a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/AsyncRegulatedWebhookEventReceiver.java\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/AsyncRegulatedWebhookEventReceiver.java\n@@ -7,6 +7,7 @@\n import in.dreamplug.commons.aws.sqs.exception.NonRetriableException;\n import in.dreamplug.commons.aws.sqs.exception.RetriableException;\n import in.dreamplug.paymentwebhookworker.constants.Constants;\n+import in.dreamplug.paymentwebhookworker.constants.MetricsConstants;\n import in.dreamplug.paymentwebhookworker.dto.WebhookEvent;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandler;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandlerFactory;\n@@ -24,7 +25,7 @@\n \n @Component\n @Slf4j\n-@RequiredArgsConstructor(onConstructor_ = { @Autowired })\n+@RequiredArgsConstructor(onConstructor_ = {@Autowired})\n public class AsyncRegulatedWebhookEventReceiver extends WebhookSQSMessageReceiver {\n \n     @NonNull\n@@ -33,13 +34,19 @@ public class AsyncRegulatedWebhookEventReceiver extends WebhookSQSMessageReceive\n     @NonNull\n     private final WebhookPublisher webhookRetryPublisher;\n \n+    @Override\n+    protected String getQueueName() {\n+        return MetricsConstants.QUEUE_ASYNC_REGULATED_PROCESSING;\n+    }\n+\n     @Override\n     @Trace(operationName = \"payment.webhook.asyncregulated.event\")\n-    void receive(Message message) throws RetriableException, NonRetriableException, JsonProcessingException {\n+    protected void receive(Message message) throws RetriableException, NonRetriableException, JsonProcessingException {\n         String event = message.getBody();\n \n-        log.info(\"Async regulated webhook event received : {}\", StringUtils.fromJson(event));\n-        WebhookEvent eventData = null;\n+        log.info(\"Async regulated webhook event received: {}\", StringUtils.fromJson(event));\n+\n+        WebhookEvent eventData;\n         try {\n             eventData = JacksonObjectMapper.getInstance().readValue(event, new TypeReference<WebhookEvent>() {\n             });\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookEventReceiver.java b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookEventReceiver.java\nindex 7d74b37..330bb0a 100644\n--- a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookEventReceiver.java\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookEventReceiver.java\n@@ -7,10 +7,10 @@\n import in.dreamplug.commons.aws.sqs.exception.RetriableException;\n import in.dreamplug.payments.domain.PaymentProviderKey;\n import in.dreamplug.paymentwebhookworker.constants.Constants;\n+import in.dreamplug.paymentwebhookworker.constants.MetricsConstants;\n import in.dreamplug.paymentwebhookworker.dto.WebhookEvent;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandler;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandlerFactory;\n-import in.dreamplug.paymentwebhookworker.handler.razorpay.RazorpayWebhookHandler;\n import in.dreamplug.paymentwebhookworker.queue.publisher.WebhookPublisher;\n import in.dreamplug.paymentwebhookworker.utils.StringUtils;\n import in.dreamplug.river.commons.utils.JacksonObjectMapper;\n@@ -24,7 +24,7 @@\n \n @Component\n @Slf4j\n-@RequiredArgsConstructor(onConstructor_ = { @Autowired })\n+@RequiredArgsConstructor(onConstructor_ = {@Autowired})\n public class WebhookEventReceiver extends WebhookSQSMessageReceiver {\n \n     @NonNull\n@@ -33,6 +33,11 @@ public class WebhookEventReceiver extends WebhookSQSMessageReceiver {\n     @NonNull\n     private final WebhookPublisher webhookRetryPublisher;\n \n+    @Override\n+    protected String getQueueName() {\n+        return MetricsConstants.QUEUE_WEBHOOK_PROCESSING;\n+    }\n+\n     @Override\n     @Trace(operationName = \"payment.webhook.event\")\n     public void receive(Message message) throws RetriableException, NonRetriableException {\n@@ -45,12 +50,12 @@ public void receive(Message message) throws RetriableException, NonRetriableExce\n             eventData = JacksonObjectMapper.getInstance().readValue(event, new TypeReference<WebhookEvent>() {\n             });\n         } catch (Exception e) {\n-            log.error(\"Exception is parsing webhook data\", e);\n+            log.error(\"Exception in parsing webhook data\", e);\n             webhookRetryPublisher.pushWebhookEventToRealtimeDLQ(event);\n             throw new NonRetriableException();\n         }\n \n-        if (Objects.isNull(eventData.getData())\n+        if (eventData == null || Objects.isNull(eventData.getData())\n                 || (eventData.getErrorMessage() != null && eventData.getErrorMessage().length > 0)\n                 || !Constants.ENTITY_TYPE.equals(eventData.getEntityType())) {\n             log.error(\"Invalid data received in webhook {}\", StringUtils.fromJson(eventData));\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookSQSMessageReceiver.java b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookSQSMessageReceiver.java\nindex 5f5b4d4..f2a8a26 100644\n--- a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookSQSMessageReceiver.java\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookSQSMessageReceiver.java\n@@ -2,27 +2,57 @@\n \n import com.amazonaws.services.sqs.model.Message;\n import com.fasterxml.jackson.core.JsonProcessingException;\n-import in.dreamplug.paymentwebhookworker.utils.MDCUtils;\n import in.dreamplug.commons.aws.sqs.exception.NonRetriableException;\n import in.dreamplug.commons.aws.sqs.exception.RetriableException;\n import in.dreamplug.commons.aws.sqs.receiver.SQSMessageReceiver;\n import in.dreamplug.paymentwebhookworker.constants.Constants;\n+import in.dreamplug.paymentwebhookworker.constants.MetricsConstants;\n+import in.dreamplug.paymentwebhookworker.metrics.MetricsCollector;\n+import in.dreamplug.paymentwebhookworker.utils.MDCUtils;\n+import lombok.extern.slf4j.Slf4j;\n import org.slf4j.MDC;\n+import org.springframework.beans.factory.annotation.Autowired;\n \n+@Slf4j\n public abstract class WebhookSQSMessageReceiver implements SQSMessageReceiver {\n \n+    @Autowired\n+    private MetricsCollector metricsCollector;\n+\n     @Override\n     public void receiveMessage(Message message) throws RetriableException, NonRetriableException {\n+        String queueName = getQueueName();\n+        metricsCollector.recordSQSMessageReceived(queueName, message);\n+\n+        String status = null;\n+        long processingStartTime = System.currentTimeMillis();\n+\n         try {\n             MDCUtils.addTraceIdsToMDC();\n             MDC.put(Constants.HEADER_SOURCE, \"SQS\");\n             this.receive(message);\n+            status = MetricsConstants.STATUS_SUCCESS;\n         } catch (JsonProcessingException e) {\n-            throw new RuntimeException(e);\n+            status = MetricsConstants.STATUS_FAILED;\n+            log.error(\"JSON processing failed for message\", e);\n+            throw new NonRetriableException(e);\n+        } catch (Exception e) {\n+            status = MetricsConstants.STATUS_FAILED;\n+            throw e;\n         } finally {\n+            if (status != null) {\n+                metricsCollector.recordSQSMessageCompleted(queueName,\n+                        System.currentTimeMillis() - processingStartTime, status, message);\n+            }\n             MDCUtils.clearMDCMap();\n         }\n     }\n \n+    /**\n+     * Get the queue name for this receiver\n+     */\n+    protected abstract String getQueueName();\n+\n+\n     abstract void receive(Message message) throws RetriableException, NonRetriableException, JsonProcessingException;\n }\n\\ No newline at end of file\ndiff --git a/src/main/resources/application.properties b/src/main/resources/application.properties\nindex cf25023..7dcb1a0 100644\n--- a/src/main/resources/application.properties\n+++ b/src/main/resources/application.properties\n@@ -3,7 +3,7 @@ server.servlet.context-path=/payment-webhook-worker\n \n management.endpoint.health.enabled=true\n management.endpoint.health.show-details=always\n-management.endpoints.web.exposure.include=${SPRINGBOOT_ACTUATOR_ENDPOINTS:info,health,metrics,mappings,scheduledtasks}\n+management.endpoints.web.exposure.include=${SPRINGBOOT_ACTUATOR_ENDPOINTS:info,health,metrics,prometheus,mappings,scheduledtasks}\n management.metrics.export.cloudwatch.namespace=${DP_SERVICE_NAME:payment-webhook-worker}\n management.metrics.export.cloudwatch.batchSize=20\n management.metrics.export.cloudwatch.enabled=true\n@@ -30,6 +30,8 @@ statsd.configuration.pushInterval=10\n statsd.configuration.enabled=${STATS_ENABLED:true}\n statsd.configuration.serviceName=payment-webhook-worker\n \n+metrics.enabled=${METRICS_ENABLED:false}\n+\n clients.paymentservice.configuration.url:${PAYMENT_SERVICE_URL:http://payment-service.stg.dreamplug.net/payments}\n clients.paymentservice.configuration.requestTimeoutInMs= 10000\n clients.paymentservice.configuration.client_token=${PAYMENT_SERVICE_TOKEN:dev}\ndiff --git a/src/test/java/queue/receiver/AsyncRegulatedWebhookEventReceiverTest.java b/src/test/java/queue/receiver/AsyncRegulatedWebhookEventReceiverTest.java\nindex 538effd..bd29be5 100644\n--- a/src/test/java/queue/receiver/AsyncRegulatedWebhookEventReceiverTest.java\n+++ b/src/test/java/queue/receiver/AsyncRegulatedWebhookEventReceiverTest.java\n@@ -9,6 +9,7 @@\n import in.dreamplug.paymentwebhookworker.dto.WebhookEvent;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandler;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandlerFactory;\n+import in.dreamplug.paymentwebhookworker.metrics.MetricsCollector;\n import in.dreamplug.paymentwebhookworker.queue.publisher.WebhookPublisher;\n import in.dreamplug.paymentwebhookworker.queue.receiver.AsyncRegulatedWebhookEventReceiver;\n import in.dreamplug.river.commons.utils.JacksonObjectMapper;\n@@ -17,6 +18,7 @@\n import org.junit.jupiter.api.extension.ExtendWith;\n import org.mockito.Mock;\n import org.mockito.junit.jupiter.MockitoExtension;\n+import org.springframework.test.util.ReflectionTestUtils;\n \n import static org.junit.jupiter.api.Assertions.assertThrows;\n import static org.mockito.ArgumentMatchers.any;\n@@ -37,6 +39,9 @@ public class AsyncRegulatedWebhookEventReceiverTest {\n     @Mock\n     private WebhookHandler webhookHandler;\n \n+    @Mock\n+    private MetricsCollector metricsCollector;\n+\n     private AsyncRegulatedWebhookEventReceiver asyncRegulatedWebhookEventReceiver;\n \n     @BeforeEach\n@@ -45,6 +50,8 @@ void setUp() {\n                 webhookHandlerFactory,\n                 webhookRetryPublisher\n         );\n+        // Inject the mock metrics collector into the parent class\n+        ReflectionTestUtils.setField(asyncRegulatedWebhookEventReceiver, \"metricsCollector\", metricsCollector);\n     }\n \n     @Test\ndiff --git a/src/test/java/queue/receiver/WebhookEventReceiverRoutingTest.java b/src/test/java/queue/receiver/WebhookEventReceiverRoutingTest.java\nindex 1df89e3..a259450 100644\n--- a/src/test/java/queue/receiver/WebhookEventReceiverRoutingTest.java\n+++ b/src/test/java/queue/receiver/WebhookEventReceiverRoutingTest.java\n@@ -8,6 +8,7 @@\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandler;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandlerFactory;\n import in.dreamplug.paymentwebhookworker.handler.razorpay.RazorpayWebhookHandler;\n+import in.dreamplug.paymentwebhookworker.metrics.MetricsCollector;\n import in.dreamplug.paymentwebhookworker.queue.publisher.WebhookPublisher;\n import in.dreamplug.paymentwebhookworker.queue.receiver.WebhookEventReceiver;\n import in.dreamplug.river.commons.utils.JacksonObjectMapper;\n@@ -16,6 +17,7 @@\n import org.junit.jupiter.api.extension.ExtendWith;\n import org.mockito.Mock;\n import org.mockito.junit.jupiter.MockitoExtension;\n+import org.springframework.test.util.ReflectionTestUtils;\n \n import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.ArgumentMatchers.eq;\n@@ -38,11 +40,16 @@ public class WebhookEventReceiverRoutingTest {\n     @Mock\n     private WebhookHandler otherWebhookHandler;\n \n+    @Mock\n+    private MetricsCollector metricsCollector;\n+\n     private WebhookEventReceiver webhookEventReceiver;\n \n     @BeforeEach\n     void setUp() {\n         webhookEventReceiver = new WebhookEventReceiver(webhookHandlerFactory, webhookRetryPublisher);\n+        // Inject the mock metrics collector into the parent class\n+        ReflectionTestUtils.setField(webhookEventReceiver, \"metricsCollector\", metricsCollector);\n     }\n \n     @Test\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n\r  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\r100   120    0   120    0     0    598      0 --:--:-- --:--:-- --:--:--   600","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"8895dd32-385d-45ae-a514-1b2f5c192aa5","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","message":{"model":"claude-opus-4-5-20251101","id":"msg_bdrk_01J8xaCsbK1nsBtAJ63Z6MUR","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The diff shows what changed in PR #68. Let me summarize the changes.","signature":"Eu4BCkgICxABGAIqQAYLzlGF++MEiIDJX6fLoLYUF1h6XecAQdF9pM5x083c1wPXGbmXXjLcajmEXHLDtXDh5bi59SShddp9nb+MH0QSDNUfaMbGKfAu+maZRhoMd8P3a53jv/ev90vsIjD/3+PaYn+1+FtLDrEFYp2xIWMhD2G3kYbFxdGFMSqZwIMGLxX/glt1mcKhHe/gQS8qVCJskoY+dnk9FG6vGfLChK40aZMJeaqp4dzg0rDkRvW0yzVarXN8yaqqxcaJx3vSu5c4VPIc8i0fR6pGKArQjpDyNUCayNYQRvb0FCa1FndZzmLBPxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":7354,"cache_read_input_tokens":50042,"cache_creation":{"ephemeral_5m_input_tokens":7354,"ephemeral_1h_input_tokens":0},"output_tokens":2}},"type":"assistant","uuid":"ceafdc96-1e55-4610-962a-eb068dc55b1a","timestamp":"2025-12-31T07:41:17.767Z"}
{"parentUuid":"ceafdc96-1e55-4610-962a-eb068dc55b1a","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","message":{"model":"claude-opus-4-5-20251101","id":"msg_bdrk_01J8xaCsbK1nsBtAJ63Z6MUR","type":"message","role":"assistant","content":[{"type":"text","text":"## PR #68 Changes Summary\n\nThis PR adds **SQS metrics collection** to the payment-webhook-worker service. Here's what changed:\n\n### New Files\n1. **`MetricsConstants.java`** - Constants for metric names and tags:\n   - `sqs.message.park_time` - time message waited in queue\n   - `sqs.message.processing_time` - processing duration\n   - `sqs.message.count` - message counts with status tags\n\n2. **`MetricsCollector.java`** - Component that records SQS metrics:\n   - `recordSQSMessageReceived()` - tracks park time and received count\n   - `recordSQSMessageCompleted()` - tracks processing time and success/failure\n\n### Modified Files\n\n| File | Changes |\n|------|---------|\n| `build.gradle` | Added `micrometer-registry-prometheus` dependency |\n| `codepipeline/configs/common.yaml` | Enabled service metrics, added Prometheus endpoint config, added `METRICS_ENABLED` env var |\n| `application.properties` | Added `prometheus` to actuator endpoints, added `metrics.enabled` property |\n| `WebhookSQSMessageReceiver.java` | Integrated MetricsCollector to record metrics on message receive/completion |\n| `WebhookEventReceiver.java` | Added `getQueueName()` method, improved null check on `eventData`, fixed typo in log message |\n| `AsyncRegulatedWebhookEventReceiver.java` | Added `getQueueName()` method, minor formatting changes |\n| Test files | Updated to mock the new `MetricsCollector` dependency |\n\n### Key Metrics Being Tracked\n- **Park time**: How long messages sit in the queue before processing\n- **Processing time**: How long it takes to process each message  \n- **Message count**: Counts tagged by queue name, status (received/success/failed), and retry count"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":7354,"cache_read_input_tokens":50042,"cache_creation":{"ephemeral_5m_input_tokens":7354,"ephemeral_1h_input_tokens":0},"output_tokens":481}},"type":"assistant","uuid":"b447a013-32b5-4143-8062-b244fc6e79c7","timestamp":"2025-12-31T07:41:25.240Z"}
{"type":"file-history-snapshot","messageId":"da7ad3d1-57b5-430f-ad48-cfd352cb1606","snapshot":{"messageId":"da7ad3d1-57b5-430f-ad48-cfd352cb1606","trackedFileBackups":{},"timestamp":"2025-12-31T07:41:38.149Z"},"isSnapshotUpdate":false}
{"parentUuid":"b447a013-32b5-4143-8062-b244fc6e79c7","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","type":"user","message":{"role":"user","content":"review the PR for any issues"},"uuid":"da7ad3d1-57b5-430f-ad48-cfd352cb1606","timestamp":"2025-12-31T07:41:38.142Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]}}
{"parentUuid":"da7ad3d1-57b5-430f-ad48-cfd352cb1606","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","message":{"model":"claude-opus-4-5-20251101","id":"msg_bdrk_01Jhgdkg3uBLafapWEHqiXUe","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to review the PR for any issues. I should launch the pr-reviewer agent to perform a comprehensive code review of this pull request.","signature":"EsACCkgICxABGAIqQKI0dSjjk85KDMxMqZEY1FHeUcJqTVuPibsp6/8wzTSdYY58BqqAMyPtf8wiQxlx5x0NxBx091J3Ic8A9oKyBTgSDNFNnCGQYRvjQOsyeBoMchKZaI1LeUYKQH8zIjA+2WXUgznZPCgAF9n7frc/baXXGhCG1XkfXo4d+TJALk+JuNcZ0fuKeSleDBkkTo0qpQG9v9/CEMfSAComEWb686hBIhTTpmch9ix3Igk9mjcmn7YQCwKtn2qSRKTlaGlGfQGLDL5Z2YrTDIoWVqfhyqVPkKIGp6M8oiGsvTb5SQqdCGBhvED1yPduM5cOQAJvaVzPF0n37iER+M8gHCWDxC5gkszSOn56h+lOI0dBNmeu/Cc11H04vGGozcb9BLRqeyXLTOqaOIEmTLa6zGeIqAvmwExBfQUYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":9,"cache_read_input_tokens":57882,"cache_creation":{"ephemeral_5m_input_tokens":9,"ephemeral_1h_input_tokens":0},"output_tokens":1}},"type":"assistant","uuid":"3fd3448f-65b9-4cf8-b947-138f2112efdf","timestamp":"2025-12-31T07:41:43.166Z"}
{"parentUuid":"3fd3448f-65b9-4cf8-b947-138f2112efdf","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","message":{"model":"claude-opus-4-5-20251101","id":"msg_bdrk_01Jhgdkg3uBLafapWEHqiXUe","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_bdrk_014XF7EThPot5WZZmvNSA13p","name":"Task","input":{"subagent_type":"pr-reviewer","prompt":"Review the GitHub pull request: https://github.com/dreamplug-tech/payment-webhook-worker/pull/68\n\nHere is the diff for the PR:\n\n```diff\ndiff --git a/build.gradle b/build.gradle\nindex 5a0bf00..66ea1c0 100644\n--- a/build.gradle\n+++ b/build.gradle\n@@ -32,6 +32,7 @@ ext {\n dependencies {\n \timplementation 'org.springframework.boot:spring-boot-starter'\n \timplementation 'org.springframework.boot:spring-boot-starter-actuator'\n+\timplementation 'io.micrometer:micrometer-registry-prometheus'\n \timplementation group: 'com.datadoghq', name: 'dd-trace-api', version: '0.90.0'\n \tcompileOnly 'org.projectlombok:lombok'\n \tannotationProcessor 'org.projectlombok:lombok'\ndiff --git a/codepipeline/configs/common.yaml b/codepipeline/configs/common.yaml\nindex e826538..a326d6e 100644\n--- a/codepipeline/configs/common.yaml\n+++ b/codepipeline/configs/common.yaml\n@@ -3,6 +3,9 @@ path: \"/\"\n container_port: 6000\n alb_scheme: internal\n health_check_path: \"/payment-webhook-worker/actuator/health\"\n+service_metrics_enabled: true\n+metrics_path: \"/payment-webhook-worker/actuator/prometheus\"\n+metrics_port: 6000\n tags:\n   pod: cred_pay\n   sub_pod: consumer\n@@ -42,7 +45,8 @@ container_environment:\n               \"v1/MANDATE_SERVICE_URL\": {},\n               \"v1/MANDATE_SERVICE_TOKEN\": {},\n               \"v1/PAYMENT_SERVICE_TOKEN\": {},\n-              \"v1/BILLDESK_BASE_URL\": {}\n+              \"v1/BILLDESK_BASE_URL\": {},\n+              \"v1/METRICS_ENABLED\": {}\n             }\n           }\n         ]\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/constants/MetricsConstants.java b/src/main/java/in/dreamplug/paymentwebhookworker/constants/MetricsConstants.java\nnew file mode 100644\nindex 0000000..07b4d1e\n--- /dev/null\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/constants/MetricsConstants.java\n@@ -0,0 +1,28 @@\n+package in.dreamplug.paymentwebhookworker.constants;\n+\n+public class MetricsConstants {\n+\n+    private MetricsConstants() {\n+        // Private constructor to prevent instantiation\n+    }\n+\n+    public static final String SQS_PARK_TIME_METRIC = \"sqs.message.park_time\";\n+    public static final String SQS_PROCESSING_TIME_METRIC = \"sqs.message.processing_time\";\n+    public static final String SQS_MESSAGE_COUNT = \"sqs.message.count\";\n+\n+    public static final String TAG_QUEUE_NAME = \"queue_name\";\n+    public static final String TAG_STATUS = \"status\";\n+    public static final String TAG_RETRY_COUNT = \"retry_count\";\n+\n+    public static final String STATUS_RECEIVED = \"received\";\n+    public static final String STATUS_SUCCESS = \"success\";\n+    public static final String STATUS_FAILED = \"failed\";\n+\n+    public static final String QUEUE_WEBHOOK_PROCESSING = \"webhook-processing\";\n+    public static final String QUEUE_ASYNC_REGULATED_PROCESSING = \"async-regulated-processing\";\n+    public static final String QUEUE_UNKNOWN = \"unknown\";\n+    public static final String RETRY_COUNT_UNKNOWN = \"UNKNOWN\";\n+\n+    public static final String SQS_ATTR_SENT_TIMESTAMP = \"SentTimestamp\";\n+    public static final String SQS_ATTR_APPROXIMATE_RECEIVE_COUNT = \"ApproximateReceiveCount\";\n+}\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/metrics/MetricsCollector.java b/src/main/java/in/dreamplug/paymentwebhookworker/metrics/MetricsCollector.java\nnew file mode 100644\nindex 0000000..a4963d4\n--- /dev/null\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/metrics/MetricsCollector.java\n@@ -0,0 +1,105 @@\n+package in.dreamplug.paymentwebhookworker.metrics;\n+\n+import com.amazonaws.services.sqs.model.Message;\n+import in.dreamplug.commons.springboot.metrics.StatsDMetricAdapter;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.Objects;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+\n+import static in.dreamplug.paymentwebhookworker.constants.MetricsConstants.*;\n+\n+@Slf4j\n+@Component\n+@RequiredArgsConstructor(onConstructor_ = {@Autowired})\n+public class MetricsCollector {\n+    private final StatsDMetricAdapter statsDMetricAdapter;\n+\n+    @Value(\"${metrics.enabled:false}\")\n+    private boolean metricsEnabled;\n+\n+    public void recordSQSMessageReceived(String queueName, Message message) {\n+        if (!metricsEnabled || message == null) {\n+            return;\n+        }\n+\n+        recordParkTime(queueName, message);\n+        recordMessageCount(queueName, STATUS_RECEIVED, message);\n+    }\n+\n+    public void recordSQSMessageCompleted(String queueName, long processingTimeMs, String status, Message message) {\n+        if (!metricsEnabled || message == null) {\n+            return;\n+        }\n+\n+        recordMessageCount(queueName, status, message);\n+        recordProcessingTime(queueName, processingTimeMs, status, message);\n+    }\n+\n+    private void recordParkTime(String queueName, Message message) {\n+        try {\n+            String timestamp = message.getAttributes().get(SQS_ATTR_SENT_TIMESTAMP);\n+            if (timestamp == null) {\n+                return;\n+            }\n+\n+            SortedMap<String, String> tags = createSQSTags(queueName, message);\n+            long parkTimeMs = System.currentTimeMillis() - Long.parseLong(timestamp);\n+            statsDMetricAdapter.gauge(SQS_PARK_TIME_METRIC, parkTimeMs, tags);\n+        } catch (Exception e) {\n+            log.warn(\"Error recording park time: {}\", e.getMessage());\n+        }\n+    }\n+\n+    private void recordMessageCount(String queueName, String status, Message message) {\n+        try {\n+            SortedMap<String, String> tags = createSQSTags(queueName, message, TAG_STATUS, status);\n+            statsDMetricAdapter.inc(SQS_MESSAGE_COUNT, tags);\n+        } catch (Exception e) {\n+            log.warn(\"Error recording message count: {}\", e.getMessage());\n+        }\n+    }\n+\n+    private void recordProcessingTime(String queueName, long processingTimeMs, String status, Message message) {\n+        try {\n+            SortedMap<String, String> tags = createSQSTags(queueName, message, TAG_STATUS, status);\n+            statsDMetricAdapter.gauge(SQS_PROCESSING_TIME_METRIC, processingTimeMs, tags);\n+        } catch (Exception e) {\n+            log.warn(\"Error recording processing time: {}\", e.getMessage());\n+        }\n+    }\n+\n+    private SortedMap<String, String> createTags(String... keyValuePairs) {\n+        SortedMap<String, String> tags = new TreeMap<>();\n+        if (keyValuePairs.length % 2 != 0) {\n+            throw new IllegalArgumentException(\"keyValuePairs must be even (key-value pairs)\");\n+        }\n+        for (int i = 0; i < keyValuePairs.length; i += 2) {\n+            tags.put(keyValuePairs[i], keyValuePairs[i + 1]);\n+        }\n+        return tags;\n+    }\n+\n+    private SortedMap<String, String> createSQSTags(String queueName, Message message, String... additionalKeyValuePairs) {\n+        String retryCount = message.getAttributes().get(SQS_ATTR_APPROXIMATE_RECEIVE_COUNT);\n+\n+        SortedMap<String, String> tags = new TreeMap<>();\n+        tags.put(TAG_QUEUE_NAME, Objects.requireNonNullElse(queueName, QUEUE_UNKNOWN));\n+        tags.put(TAG_RETRY_COUNT, Objects.requireNonNullElse(retryCount, RETRY_COUNT_UNKNOWN));\n+\n+        // Add any additional tags\n+        if (additionalKeyValuePairs.length % 2 != 0) {\n+            throw new IllegalArgumentException(\"additionalKeyValuePairs must be even (key-value pairs)\");\n+        }\n+        for (int i = 0; i < additionalKeyValuePairs.length; i += 2) {\n+            tags.put(additionalKeyValuePairs[i], additionalKeyValuePairs[i + 1]);\n+        }\n+\n+        return tags;\n+    }\n+}\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/AsyncRegulatedWebhookEventReceiver.java b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/AsyncRegulatedWebhookEventReceiver.java\nindex 269174e..092f7f0 100644\n--- a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/AsyncRegulatedWebhookEventReceiver.java\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/AsyncRegulatedWebhookEventReceiver.java\n@@ -7,6 +7,7 @@\n import in.dreamplug.commons.aws.sqs.exception.NonRetriableException;\n import in.dreamplug.commons.aws.sqs.exception.RetriableException;\n import in.dreamplug.paymentwebhookworker.constants.Constants;\n+import in.dreamplug.paymentwebhookworker.constants.MetricsConstants;\n import in.dreamplug.paymentwebhookworker.dto.WebhookEvent;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandler;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandlerFactory;\n@@ -24,7 +25,7 @@\n \n @Component\n @Slf4j\n-@RequiredArgsConstructor(onConstructor_ = { @Autowired })\n+@RequiredArgsConstructor(onConstructor_ = {@Autowired})\n public class AsyncRegulatedWebhookEventReceiver extends WebhookSQSMessageReceiver {\n \n     @NonNull\n@@ -33,13 +34,19 @@ public class AsyncRegulatedWebhookEventReceiver extends WebhookSQSMessageReceive\n     @NonNull\n     private final WebhookPublisher webhookRetryPublisher;\n \n+    @Override\n+    protected String getQueueName() {\n+        return MetricsConstants.QUEUE_ASYNC_REGULATED_PROCESSING;\n+    }\n+\n     @Override\n     @Trace(operationName = \"payment.webhook.asyncregulated.event\")\n-    void receive(Message message) throws RetriableException, NonRetriableException, JsonProcessingException {\n+    protected void receive(Message message) throws RetriableException, NonRetriableException, JsonProcessingException {\n         String event = message.getBody();\n \n-        log.info(\"Async regulated webhook event received : {}\", StringUtils.fromJson(event));\n-        WebhookEvent eventData = null;\n+        log.info(\"Async regulated webhook event received: {}\", StringUtils.fromJson(event));\n+\n+        WebhookEvent eventData;\n         try {\n             eventData = JacksonObjectMapper.getInstance().readValue(event, new TypeReference<WebhookEvent>() {\n             });\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookEventReceiver.java b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookEventReceiver.java\nindex 7d74b37..330bb0a 100644\n--- a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookEventReceiver.java\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookEventReceiver.java\n@@ -7,10 +7,10 @@\n import in.dreamplug.commons.aws.sqs.exception.RetriableException;\n import in.dreamplug.payments.domain.PaymentProviderKey;\n import in.dreamplug.paymentwebhookworker.constants.Constants;\n+import in.dreamplug.paymentwebhookworker.constants.MetricsConstants;\n import in.dreamplug.paymentwebhookworker.dto.WebhookEvent;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandler;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandlerFactory;\n-import in.dreamplug.paymentwebhookworker.handler.razorpay.RazorpayWebhookHandler;\n import in.dreamplug.paymentwebhookworker.queue.publisher.WebhookPublisher;\n import in.dreamplug.paymentwebhookworker.utils.StringUtils;\n import in.dreamplug.river.commons.utils.JacksonObjectMapper;\n@@ -24,7 +24,7 @@\n \n @Component\n @Slf4j\n-@RequiredArgsConstructor(onConstructor_ = { @Autowired })\n+@RequiredArgsConstructor(onConstructor_ = {@Autowired})\n public class WebhookEventReceiver extends WebhookSQSMessageReceiver {\n \n     @NonNull\n@@ -33,6 +33,11 @@ public class WebhookEventReceiver extends WebhookSQSMessageReceiver {\n     @NonNull\n     private final WebhookPublisher webhookRetryPublisher;\n \n+    @Override\n+    protected String getQueueName() {\n+        return MetricsConstants.QUEUE_WEBHOOK_PROCESSING;\n+    }\n+\n     @Override\n     @Trace(operationName = \"payment.webhook.event\")\n     public void receive(Message message) throws RetriableException, NonRetriableException {\n@@ -45,12 +50,12 @@ public void receive(Message message) throws RetriableException, NonRetriableExce\n             eventData = JacksonObjectMapper.getInstance().readValue(event, new TypeReference<WebhookEvent>() {\n             });\n         } catch (Exception e) {\n-            log.error(\"Exception is parsing webhook data\", e);\n+            log.error(\"Exception in parsing webhook data\", e);\n             webhookRetryPublisher.pushWebhookEventToRealtimeDLQ(event);\n             throw new NonRetriableException();\n         }\n \n-        if (Objects.isNull(eventData.getData())\n+        if (eventData == null || Objects.isNull(eventData.getData())\n                 || (eventData.getErrorMessage() != null && eventData.getErrorMessage().length > 0)\n                 || !Constants.ENTITY_TYPE.equals(eventData.getEntityType())) {\n             log.error(\"Invalid data received in webhook {}\", StringUtils.fromJson(eventData));\ndiff --git a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookSQSMessageReceiver.java b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookSQSMessageReceiver.java\nindex 5f5b4d4..f2a8a26 100644\n--- a/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookSQSMessageReceiver.java\n+++ b/src/main/java/in/dreamplug/paymentwebhookworker/queue/receiver/WebhookSQSMessageReceiver.java\n@@ -2,27 +2,57 @@\n \n import com.amazonaws.services.sqs.model.Message;\n import com.fasterxml.jackson.core.JsonProcessingException;\n-import in.dreamplug.paymentwebhookworker.utils.MDCUtils;\n import in.dreamplug.commons.aws.sqs.exception.NonRetriableException;\n import in.dreamplug.commons.aws.sqs.exception.RetriableException;\n import in.dreamplug.commons.aws.sqs.receiver.SQSMessageReceiver;\n import in.dreamplug.paymentwebhookworker.constants.Constants;\n+import in.dreamplug.paymentwebhookworker.constants.MetricsConstants;\n+import in.dreamplug.paymentwebhookworker.metrics.MetricsCollector;\n+import in.dreamplug.paymentwebhookworker.utils.MDCUtils;\n+import lombok.extern.slf4j.Slf4j;\n import org.slf4j.MDC;\n+import org.springframework.beans.factory.annotation.Autowired;\n \n+@Slf4j\n public abstract class WebhookSQSMessageReceiver implements SQSMessageReceiver {\n \n+    @Autowired\n+    private MetricsCollector metricsCollector;\n+\n     @Override\n     public void receiveMessage(Message message) throws RetriableException, NonRetriableException {\n+        String queueName = getQueueName();\n+        metricsCollector.recordSQSMessageReceived(queueName, message);\n+\n+        String status = null;\n+        long processingStartTime = System.currentTimeMillis();\n+\n         try {\n             MDCUtils.addTraceIdsToMDC();\n             MDC.put(Constants.HEADER_SOURCE, \"SQS\");\n             this.receive(message);\n+            status = MetricsConstants.STATUS_SUCCESS;\n         } catch (JsonProcessingException e) {\n-            throw new RuntimeException(e);\n+            status = MetricsConstants.STATUS_FAILED;\n+            log.error(\"JSON processing failed for message\", e);\n+            throw new NonRetriableException(e);\n+        } catch (Exception e) {\n+            status = MetricsConstants.STATUS_FAILED;\n+            throw e;\n         } finally {\n+            if (status != null) {\n+                metricsCollector.recordSQSMessageCompleted(queueName,\n+                        System.currentTimeMillis() - processingStartTime, status, message);\n+            }\n             MDCUtils.clearMDCMap();\n         }\n     }\n \n+    /**\n+     * Get the queue name for this receiver\n+     */\n+    protected abstract String getQueueName();\n+\n+\n     abstract void receive(Message message) throws RetriableException, NonRetriableException, JsonProcessingException;\n }\ndiff --git a/src/main/resources/application.properties b/src/main/resources/application.properties\nindex cf25023..7dcb1a0 100644\n--- a/src/main/resources/application.properties\n+++ b/src/main/resources/application.properties\n@@ -3,7 +3,7 @@ server.servlet.context-path=/payment-webhook-worker\n \n management.endpoint.health.enabled=true\n management.endpoint.health.show-details=always\n-management.endpoints.web.exposure.include=${SPRINGBOOT_ACTUATOR_ENDPOINTS:info,health,metrics,mappings,scheduledtasks}\n+management.endpoints.web.exposure.include=${SPRINGBOOT_ACTUATOR_ENDPOINTS:info,health,metrics,prometheus,mappings,scheduledtasks}\n management.metrics.export.cloudwatch.namespace=${DP_SERVICE_NAME:payment-webhook-worker}\n management.metrics.export.cloudwatch.batchSize=20\n management.metrics.export.cloudwatch.enabled=true\n@@ -30,6 +30,8 @@ statsd.configuration.pushInterval=10\n statsd.configuration.enabled=${STATS_ENABLED:true}\n statsd.configuration.serviceName=payment-webhook-worker\n \n+metrics.enabled=${METRICS_ENABLED:false}\n+\n clients.paymentservice.configuration.url:${PAYMENT_SERVICE_URL:http://payment-service.stg.dreamplug.net/payments}\n clients.paymentservice.configuration.requestTimeoutInMs= 10000\n clients.paymentservice.configuration.client_token=${PAYMENT_SERVICE_TOKEN:dev}\ndiff --git a/src/test/java/queue/receiver/AsyncRegulatedWebhookEventReceiverTest.java b/src/test/java/queue/receiver/AsyncRegulatedWebhookEventReceiverTest.java\nindex 538effd..bd29be5 100644\n--- a/src/test/java/queue/receiver/AsyncRegulatedWebhookEventReceiverTest.java\n+++ b/src/test/java/queue/receiver/AsyncRegulatedWebhookEventReceiverTest.java\n@@ -9,6 +9,7 @@\n import in.dreamplug.paymentwebhookworker.dto.WebhookEvent;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandler;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandlerFactory;\n+import in.dreamplug.paymentwebhookworker.metrics.MetricsCollector;\n import in.dreamplug.paymentwebhookworker.queue.publisher.WebhookPublisher;\n import in.dreamplug.paymentwebhookworker.queue.receiver.AsyncRegulatedWebhookEventReceiver;\n import in.dreamplug.river.commons.utils.JacksonObjectMapper;\n@@ -17,6 +18,7 @@\n import org.junit.jupiter.api.extension.ExtendWith;\n import org.mockito.Mock;\n import org.mockito.junit.jupiter.MockitoExtension;\n+import org.springframework.test.util.ReflectionTestUtils;\n \n import static org.junit.jupiter.api.Assertions.assertThrows;\n import static org.mockito.ArgumentMatchers.any;\n@@ -37,6 +39,9 @@ public class AsyncRegulatedWebhookEventReceiverTest {\n     @Mock\n     private WebhookHandler webhookHandler;\n \n+    @Mock\n+    private MetricsCollector metricsCollector;\n+\n     private AsyncRegulatedWebhookEventReceiver asyncRegulatedWebhookEventReceiver;\n \n     @BeforeEach\n@@ -45,6 +50,8 @@ void setUp() {\n                 webhookHandlerFactory,\n                 webhookRetryPublisher\n         );\n+        // Inject the mock metrics collector into the parent class\n+        ReflectionTestUtils.setField(asyncRegulatedWebhookEventReceiver, \"metricsCollector\", metricsCollector);\n     }\n \n     @Test\ndiff --git a/src/test/java/queue/receiver/WebhookEventReceiverRoutingTest.java b/src/test/java/queue/receiver/WebhookEventReceiverRoutingTest.java\nindex 1df89e3..a259450 100644\n--- a/src/test/java/queue/receiver/WebhookEventReceiverRoutingTest.java\n+++ b/src/test/java/queue/receiver/WebhookEventReceiverRoutingTest.java\n@@ -8,6 +8,7 @@\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandler;\n import in.dreamplug.paymentwebhookworker.handler.WebhookHandlerFactory;\n import in.dreamplug.paymentwebhookworker.handler.razorpay.RazorpayWebhookHandler;\n+import in.dreamplug.paymentwebhookworker.metrics.MetricsCollector;\n import in.dreamplug.paymentwebhookworker.queue.publisher.WebhookPublisher;\n import in.dreamplug.paymentwebhookworker.queue.receiver.WebhookEventReceiver;\n import in.dreamplug.river.commons.utils.JacksonObjectMapper;\n@@ -16,6 +17,7 @@\n import org.junit.jupiter.api.extension.ExtendWith;\n import org.mockito.Mock;\n import org.mockito.junit.jupiter.MockitoExtension;\n+import org.springframework.test.util.ReflectionTestUtils;\n \n import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.ArgumentMatchers.eq;\n@@ -38,11 +40,16 @@ public class WebhookEventReceiverRoutingTest {\n     @Mock\n     private WebhookHandler otherWebhookHandler;\n \n+    @Mock\n+    private MetricsCollector metricsCollector;\n+\n     private WebhookEventReceiver webhookEventReceiver;\n \n     @BeforeEach\n     void setUp() {\n         webhookEventReceiver = new WebhookEventReceiver(webhookHandlerFactory, webhookRetryPublisher);\n+        // Inject the mock metrics collector into the parent class\n+        ReflectionTestUtils.setField(webhookEventReceiver, \"metricsCollector\", metricsCollector);\n     }\n \n     @Test\n```\n\nThe PR adds SQS metrics collection (park time, processing time, message counts) to the payment-webhook-worker service using Micrometer/Prometheus and StatsD.\n\nPerform a comprehensive code review covering:\n1. Security issues\n2. Bugs and logic errors\n3. Code quality and best practices\n4. Performance concerns\n5. Test coverage gaps","description":"Review PR #68 for issues"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":9,"cache_read_input_tokens":57882,"cache_creation":{"ephemeral_5m_input_tokens":9,"ephemeral_1h_input_tokens":0},"output_tokens":7014}},"type":"assistant","uuid":"8d4cdc6b-8efb-4fe2-82c4-51346d01c528","timestamp":"2025-12-31T07:42:47.388Z"}
{"parentUuid":"8d4cdc6b-8efb-4fe2-82c4-51346d01c528","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"[Request interrupted by user for tool use]","is_error":true,"tool_use_id":"toolu_bdrk_014XF7EThPot5WZZmvNSA13p"}]},"uuid":"49ba3ae3-7fd4-4f9f-b1a5-7c06a40ede18","timestamp":"2025-12-31T07:46:56.349Z","toolUseResult":"Error: [Request interrupted by user for tool use]"}
{"parentUuid":"49ba3ae3-7fd4-4f9f-b1a5-7c06a40ede18","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","type":"user","message":{"role":"user","content":[{"type":"text","text":"[Request interrupted by user for tool use]"}]},"uuid":"a2adda44-c724-45cb-a686-ffb22ac3a95c","timestamp":"2025-12-31T07:46:56.349Z"}
{"type":"file-history-snapshot","messageId":"dde9b0f4-1de1-4fdf-96a7-3bb12191a263","snapshot":{"messageId":"dde9b0f4-1de1-4fdf-96a7-3bb12191a263","trackedFileBackups":{},"timestamp":"2025-12-31T07:47:08.198Z"},"isSnapshotUpdate":false}
{"parentUuid":"a2adda44-c724-45cb-a686-ffb22ac3a95c","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","type":"user","message":{"role":"user","content":"tell me the comments, rather than adding it in PR directly"},"uuid":"dde9b0f4-1de1-4fdf-96a7-3bb12191a263","timestamp":"2025-12-31T07:47:08.187Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]}}
{"parentUuid":"dde9b0f4-1de1-4fdf-96a7-3bb12191a263","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","message":{"model":"claude-opus-4-5-20251101","id":"msg_bdrk_01DRnPkLSs48RLG3ugsSzzSJ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user wants me to review the PR and tell them the comments/issues directly rather than posting them to the PR. Let me analyze the diff and provide a comprehensive code review.","signature":"Et0CCkgICxABGAIqQF4bJ70slgFHHemGxSoKfOgISN1eEpzy7tUB3SHOvZNqGThcn2/MDkR/FCHXp/G8tqJT8wOLtYrahzfLi24QQZMSDJGpg4gmU64xXL/sPRoM8sWgDFhdvzN/QFkZIjCch6vd726Z/qQYUWx6umIbXEopjEIKWAd6RRDgFlrntU+AzeK9w15X614m9HKoMAMqwgFO1ecs6hySjOQebGU4Sg/2MAQGJU6Fcq2hU5UpWsgVt6M8q//hxMkWousJGeIloNAe9W1dDFKTF2drIOh24L0rPPoZyUd3UsclDsMX/3tPT1k7JJIdHf1GMhy9dbRMfIh1xVa8dhk8wh+sKv9F8xplALn6o9eL0EopZEp3k+/aub/39079bYLVQu8KVv/8lr+xtOfl83G9i2JaOxLVOkI15ALE0IuKLnOOwrW2PxuIvCViau+XNFjPQiZzwnHQCSlvIRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":65080,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":65080,"ephemeral_1h_input_tokens":0},"output_tokens":3}},"type":"assistant","uuid":"5f85a77d-17e6-4471-86e1-299bca575317","timestamp":"2025-12-31T07:47:14.527Z"}
{"parentUuid":"5f85a77d-17e6-4471-86e1-299bca575317","isSidechain":false,"userType":"external","cwd":"/Users/kiranbiliyawala/code/cred/payments","sessionId":"5af4853e-fb69-4afe-896e-4b1d129b6351","version":"2.0.76","gitBranch":"","message":{"model":"claude-opus-4-5-20251101","id":"msg_bdrk_01DRnPkLSs48RLG3ugsSzzSJ","type":"message","role":"assistant","content":[{"type":"text","text":"## PR #68 Code Review\n\n###  MEDIUM - Potential Bug\n\n**`WebhookSQSMessageReceiver.java`** - Status not recorded when `RetriableException` is thrown\n\n```java\n} catch (Exception e) {\n    status = MetricsConstants.STATUS_FAILED;\n    throw e;\n}\n```\n\nThe issue is that `RetriableException` will be caught here and marked as `FAILED`, but retriable exceptions aren't really failures - they're expected to be retried. Consider distinguishing between retriable and non-retriable failures:\n\n```java\n} catch (RetriableException e) {\n    status = \"retried\";  // or don't record as failed\n    throw e;\n} catch (Exception e) {\n    status = MetricsConstants.STATUS_FAILED;\n    throw e;\n}\n```\n\n---\n\n###  MEDIUM - Unused Method\n\n**`MetricsCollector.java:79-88`** - `createTags()` method is never used\n\n```java\nprivate SortedMap<String, String> createTags(String... keyValuePairs) {\n    // This entire method is dead code\n}\n```\n\nRemove this unused method.\n\n---\n\n###  LOW - Inconsistent Metric Types\n\n**`MetricsCollector.java`** - Using `gauge` for timing metrics\n\n```java\nstatsDMetricAdapter.gauge(SQS_PARK_TIME_METRIC, parkTimeMs, tags);\nstatsDMetricAdapter.gauge(SQS_PROCESSING_TIME_METRIC, processingTimeMs, tags);\n```\n\nFor timing metrics, `histogram` or `timer` is typically more appropriate than `gauge`. Gauges represent a point-in-time value, while histograms/timers provide percentiles, counts, and averages. Check if `StatsDMetricAdapter` has a `timer()` or `histogram()` method.\n\n---\n\n###  LOW - Missing Null Safety\n\n**`WebhookSQSMessageReceiver.java:18`** - No null check on `metricsCollector`\n\n```java\n@Autowired\nprivate MetricsCollector metricsCollector;\n```\n\nField injection with `@Autowired` could result in NPE if Spring context isn't properly initialized. The tests use `ReflectionTestUtils` to inject mocks, which is a code smell. Consider constructor injection instead:\n\n```java\npublic abstract class WebhookSQSMessageReceiver implements SQSMessageReceiver {\n    protected final MetricsCollector metricsCollector;\n    \n    protected WebhookSQSMessageReceiver(MetricsCollector metricsCollector) {\n        this.metricsCollector = metricsCollector;\n    }\n}\n```\n\n---\n\n###  LOW - Visibility Modifier Change\n\n**`AsyncRegulatedWebhookEventReceiver.java:42`** - Method visibility changed from package-private to `protected`\n\n```java\n-    void receive(Message message) ...\n+    protected void receive(Message message) ...\n```\n\nBut in `WebhookEventReceiver.java:38`, it remains `public`:\n```java\npublic void receive(Message message) ...\n```\n\nThe abstract method in base class is still package-private:\n```java\nabstract void receive(Message message) ...\n```\n\nThis inconsistency should be fixed - make all implementations consistent.\n\n---\n\n###  LOW - Double Counting Messages\n\n**`MetricsCollector.java`** - Messages are counted twice on completion\n\nWhen a message completes:\n1. `recordSQSMessageReceived()` counts with `STATUS_RECEIVED`\n2. `recordSQSMessageCompleted()` counts again with `STATUS_SUCCESS` or `STATUS_FAILED`\n\nThis means every message is counted twice in `sqs.message.count`. If intentional, document it. If not, remove the count from `recordSQSMessageReceived()`.\n\n---\n\n###  SUGGESTION - Test Coverage\n\nThe tests mock `MetricsCollector` but don't verify:\n- That metrics are actually recorded\n- Correct tags are passed\n- Error scenarios in metrics recording\n\nConsider adding tests for `MetricsCollector` itself and verifying mock interactions:\n```java\nverify(metricsCollector).recordSQSMessageReceived(eq(\"webhook-processing\"), any(Message.class));\n```\n\n---\n\n###  SUGGESTION - Negative Park Time\n\n**`MetricsCollector.java:53`** - No validation for negative park time\n\n```java\nlong parkTimeMs = System.currentTimeMillis() - Long.parseLong(timestamp);\n```\n\nIf there's clock skew between SQS and the worker, this could be negative. Consider:\n```java\nlong parkTimeMs = Math.max(0, System.currentTimeMillis() - Long.parseLong(timestamp));\n```\n\n---\n\n### Summary\n\n| Severity | Count |\n|----------|-------|\n| Medium | 2 |\n| Low | 4 |\n| Suggestions | 2 |\n\nThe PR is generally well-structured. The main concerns are the unused code, potential double-counting of metrics, and the handling of retriable vs non-retriable exceptions in failure tracking."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":9,"cache_creation_input_tokens":65080,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":65080,"ephemeral_1h_input_tokens":0},"output_tokens":1294}},"type":"assistant","uuid":"80922d5c-40be-465f-b094-e0e966b7050f","timestamp":"2025-12-31T07:47:33.444Z"}
{"type":"summary","summary":"SQS Metrics Collection PR Review Issues","leafUuid":"80922d5c-40be-465f-b094-e0e966b7050f"}
