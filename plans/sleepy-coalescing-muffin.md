# Pre-Processing Validations Flow - Detailed Explanation

## Overview

Pre-Processing Validations is **Step 1** in the Main Settlement Flow. These validations occur **before** the settlement workflow is initiated to ensure the settlement operation is safe to proceed. All validations happen in the `settleViaWorkflowPreProcess` method in `/internal/settlement/service.go`.

---

## Entry Point

The flow begins when `SettleViaWorkflow` API is called:

**File:** `/internal/settlement/server.go` (Lines 60-96)

```
SettleViaWorkflow API
       │
       ▼
validateSettleViaWorkflowRequest()  ──► Basic request validation (scheduleId, dbkAccountNumber)
       │
       ▼
settleViaWorkflowPreProcess()  ──► Pre-Processing Validations (5 checks)
       │
       ▼
ExecuteWorkflow()  ──► Start settlement workflow
```

---

## The 5 Pre-Processing Validations

### 1. Lock Check
**Purpose:** Ensures no settlement operation is already in progress for the partner.

**File:** `/internal/settlement/service.go` (Lines 345-357)

**Logic:**
- Calls `operationlock.IsLocked()` with partner ID
- If locked, returns error: `"settlement operation is in progress for the partner"`
- Prevents concurrent settlement operations on the same partner

#### Lock Mechanism - Deep Dive

**Key Files:**
| File | Purpose |
|------|---------|
| `/internal/operationlock/service.go` | Lock/Unlock/IsLocked operations |
| `/internal/operationlock/helper.go` | Lock ID generation |
| `/internal/operationlock/model.go` | Database model |
| `/cmd/db/migrate/migrations/00001_init.sql` | Database schema |

**Lock Key Format:**
```
{partnerID}-settlement
```
- Generated by `LockIDForSettlement(partnerID)` in `/internal/operationlock/helper.go`
- Example: `partner_123-settlement`

**Storage:** MySQL Database (NOT Redis)
- Table: `operation_locks`
- No automatic TTL - locks are explicitly released

**Database Schema:**
```sql
CREATE TABLE operation_locks (
    id BIGINT UNSIGNED AUTO_INCREMENT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at_unix INT(10) DEFAULT 0,
    tenant_id VARCHAR(64) NOT NULL,
    lock_id VARCHAR(64) NOT NULL,
    locked_by VARCHAR(64) NOT NULL,
    PRIMARY KEY (id),
    UNIQUE KEY idx_operation_locks_tenant_id_lock_id (tenant_id, lock_id, deleted_at_unix)
) ENGINE = InnoDB;
```

**Uniqueness Constraint:** `(tenant_id, lock_id, deleted_at_unix)`
- Prevents duplicate locks via MySQL error code 1062 (duplicate key)

**Lock Lifecycle:**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           LOCK LIFECYCLE                                         │
└─────────────────────────────────────────────────────────────────────────────────┘

PHASE 1: Pre-Check (Before Workflow)
──────────────────────────────────────
     ┌──────────────────┐
     │SettleViaWorkflow │
     │     API Call     │
     └────────┬─────────┘
              │
              ▼
     ┌──────────────────┐
     │  IsLocked()      │──► SELECT COUNT(*) FROM operation_locks
     │  (Read Check)    │    WHERE tenant_id=? AND lock_id=?
     └────────┬─────────┘
              │
        ┌─────┴─────┐
        │           │
     Locked      Not Locked
        │           │
        ▼           ▼
   Return Error   Continue to workflow


PHASE 2: Lock Acquisition (First Workflow Activity)
───────────────────────────────────────────────────
     ┌──────────────────────────────┐
     │ AcquireOperationLock         │
     │ (Workflow Activity #0)       │
     └────────────┬─────────────────┘
                  │
                  ▼
     ┌──────────────────────────────┐
     │ operationlock.Lock()         │──► INSERT INTO operation_locks
     │                              │    (tenant_id, lock_id, locked_by)
     └────────────┬─────────────────┘    VALUES (?, ?, workflow_id)
                  │
            ┌─────┴─────┐
            │           │
      Success (true)  MySQL Error 1062
            │           (Duplicate Key)
            │           │
            ▼           ▼
      Continue      Return Error
      Workflow      "failed to acquire lock!"


PHASE 3: Lock Release (Cleanup Activity)
───────────────────────────────────────
     ┌──────────────────────────────┐
     │ Cleanup Activity             │
     │ (End of Workflow)            │
     └────────────┬─────────────────┘
                  │
                  ▼
     ┌──────────────────────────────┐
     │ operationlock.Unlock()       │──► DELETE FROM operation_locks
     │                              │    WHERE tenant_id=? AND lock_id=?
     └────────────┬─────────────────┘    AND locked_by=workflow_id
                  │
                  ▼
          Lock Released
```

**Lock Data Structure:**
| Field | Type | Description |
|-------|------|-------------|
| `tenant_id` | VARCHAR(64) | Tenant identifier |
| `lock_id` | VARCHAR(64) | Format: `{partnerID}-settlement` |
| `locked_by` | VARCHAR(64) | Workflow ID that holds the lock |
| `deleted_at_unix` | INT(10) | Soft delete timestamp (0 = active) |

**TTL:** **None** (Database-based, no automatic expiration)
- Locks are explicitly released by the `Cleanup` activity
- If workflow crashes, lock remains until manually cleared or workflow is cancelled

**Lock Operations:**

| Operation | Method | SQL | When Called |
|-----------|--------|-----|-------------|
| **Check** | `IsLocked()` | `SELECT COUNT(*) WHERE tenant_id=? AND lock_id=?` | Pre-processing validation |
| **Acquire** | `Lock()` | `INSERT INTO operation_locks (...)` | First workflow activity |
| **Release** | `Unlock()` | `DELETE FROM operation_locks WHERE ... AND locked_by=?` | Cleanup activity |

**Code References:**

```go
// Lock ID Generation - /internal/operationlock/helper.go:7-9
func LockIDForSettlement(partnerID string) string {
    return fmt.Sprintf("%s-settlement", partnerID)
}

// Lock Acquisition - /internal/operationlock/service.go:14-28
func (s Service) Lock(ctx context.Context, tenantID, lockID, lockedBy string) (bool, error) {
    lock := &OperationLock{TenantID: tenantID, LockID: lockID, LockedBy: lockedBy}
    err := s.repo.DB.WithContext(ctx).Create(lock).Error
    if err != nil {
        var mysqlerr *mysql.MySQLError
        if errors.As(err, &mysqlerr) && mysqlerr.Number == 1062 {
            return false, nil  // Lock already exists
        }
        return false, err
    }
    return true, nil
}

// Lock Release - /internal/operationlock/service.go:30-46
func (s Service) Unlock(ctx context.Context, tenantID, lockID, lockedBy string) (bool, error) {
    result := s.repo.DB.WithContext(ctx).
        Where("tenant_id = ?", tenantID).
        Where("lock_id = ?", lockID).
        Where("locked_by = ?", lockedBy).
        Delete(&OperationLock{})
    return result.RowsAffected > 0, result.Error
}
```

**Why No TTL?**
- Settlement workflows can run for extended periods (Databricks queries, payouts)
- Lock tied to specific workflow ID (`locked_by`)
- Only the workflow that acquired the lock can release it
- Manual intervention possible via Admin API if workflow gets stuck

---

### 2. Settlement Allowed Check (Holiday Check)
**Purpose:** Verifies settlement is allowed on the current day (checks bank holidays).

**File:** `/internal/settlement/service.go` (Lines 359-373, 415-427)

**Logic:**
1. Calls `calendar.IsBankHoliday()` with current date (IST timezone)
2. If it's a bank holiday:
   - Fetches `CONFIG_TYPE_ALLOW_ON_BANK_HOLIDAY` config for the partner
   - If config is `false` or not set → returns error: `"settlement is not allowed today"`
   - If config is `true` → allows settlement to proceed
3. If not a holiday → allows settlement to proceed

**External Dependency:** Calendar Service

---

### 3. Mode Enabled Check
**Purpose:** Verifies that settlement mode is enabled for the partner.

**File:** `/internal/settlement/service.go` (Lines 375-391)

**Logic:**
- Fetches `CONFIG_TYPE_MODE` config for the partner
- Checks `modeConfig.Enabled` field
- If `false` → returns error: `"settlement is not enabled for this partner"`
- Must be explicitly enabled for settlements to work

**Config Location:** `/internal/config/service.go` (Lines 136-149)

---

### 4. On-Hold Check
**Purpose:** Verifies that settlement for the partner is not on hold.

**File:** `/internal/settlement/service.go` (Lines 393-408)

**Logic:**
- Fetches `CONFIG_TYPE_ON_HOLD_FLAG` config for the partner
- If config not found → defaults to `false` (not on hold)
- If `onHold = true` → returns error: `"settlement for this partner is on hold"`
- If `onHold = false` → allows settlement to proceed

**Config Location:** `/internal/config/service.go` (Lines 161-173)

---

### 5. Request Validation
**Purpose:** Validates the incoming API request structure.

**File:** `/internal/settlement/validator.go` (Lines 210-223)

**Validates:**
- `ScheduleId` - Required, must match `ScheduleIDRegex`
- `DbkAccountNumber` - Required, must match `DBKAccountNumberRegex`, length constraints

---

## Sequence Diagram

```
┌──────────┐     ┌──────────────┐     ┌─────────────┐     ┌─────────────┐     ┌──────────────┐
│  Client  │     │Settlement    │     │Operation    │     │Calendar     │     │Config        │
│          │     │Server        │     │Lock Service │     │Service      │     │Service       │
└────┬─────┘     └──────┬───────┘     └──────┬──────┘     └──────┬──────┘     └──────┬───────┘
     │                  │                    │                   │                   │
     │ SettleViaWorkflow│                    │                   │                   │
     │─────────────────>│                    │                   │                   │
     │                  │                    │                   │                   │
     │                  │ validateRequest()  │                   │                   │
     │                  │────────┐           │                   │                   │
     │                  │        │           │                   │                   │
     │                  │<───────┘           │                   │                   │
     │                  │                    │                   │                   │
     │                  │ ┌──────────────────────────────────────────────────────────┐
     │                  │ │           settleViaWorkflowPreProcess()                  │
     │                  │ └──────────────────────────────────────────────────────────┘
     │                  │                    │                   │                   │
     │                  │ 1. IsLocked()      │                   │                   │
     │                  │───────────────────>│                   │                   │
     │                  │                    │                   │                   │
     │                  │    locked=false    │                   │                   │
     │                  │<───────────────────│                   │                   │
     │                  │                    │                   │                   │
     │                  │ 2. IsBankHoliday() │                   │                   │
     │                  │───────────────────────────────────────>│                   │
     │                  │                    │                   │                   │
     │                  │    holiday=true/false                  │                   │
     │                  │<───────────────────────────────────────│                   │
     │                  │                    │                   │                   │
     │                  │ 2a. GetAllowOnBankHolidayConfig() (if holiday=true)        │
     │                  │──────────────────────────────────────────────────────────> │
     │                  │                    │                   │                   │
     │                  │    allowOnHoliday=true/false                               │
     │                  │<──────────────────────────────────────────────────────────│
     │                  │                    │                   │                   │
     │                  │ 3. GetModeConfig() │                   │                   │
     │                  │──────────────────────────────────────────────────────────> │
     │                  │                    │                   │                   │
     │                  │    modeConfig.Enabled=true/false                           │
     │                  │<──────────────────────────────────────────────────────────│
     │                  │                    │                   │                   │
     │                  │ 4. GetOnHoldConfigElseDefault()        │                   │
     │                  │──────────────────────────────────────────────────────────> │
     │                  │                    │                   │                   │
     │                  │    onHold=true/false                                       │
     │                  │<──────────────────────────────────────────────────────────│
     │                  │                    │                   │                   │
     │                  │ ┌──────────────────────────────────────────────────────────┐
     │                  │ │         All validations passed                           │
     │                  │ └──────────────────────────────────────────────────────────┘
     │                  │                    │                   │                   │
     │                  │ ExecuteWorkflow()  │                   │                   │
     │                  │────────┐           │                   │                   │
     │                  │        │ Start     │                   │                   │
     │                  │<───────┘ workflow  │                   │                   │
     │                  │                    │                   │                   │
     │  WorkflowId,     │                    │                   │                   │
     │  WorkflowRunId   │                    │                   │                   │
     │<─────────────────│                    │                   │                   │
     │                  │                    │                   │                   │
```

---

## Validation Flow Decision Tree

```
                         ┌─────────────────────┐
                         │  SettleViaWorkflow  │
                         │      Request        │
                         └──────────┬──────────┘
                                    │
                         ┌──────────▼──────────┐
                         │ Validate Request    │
                         │ (ScheduleId, DBK#)  │
                         └──────────┬──────────┘
                                    │
                              Valid? ├───No───► Return Validation Error
                                    │
                                   Yes
                                    │
                         ┌──────────▼──────────┐
                         │  1. Lock Check      │
                         │    IsLocked()?      │
                         └──────────┬──────────┘
                                    │
                             Locked? ├───Yes──► Return "operation in progress"
                                    │
                                   No
                                    │
                         ┌──────────▼──────────┐
                         │  2. Holiday Check   │
                         │  IsBankHoliday()?   │
                         └──────────┬──────────┘
                                    │
                        ┌───────────┴───────────┐
                       Yes                      No
                        │                       │
            ┌───────────▼───────────┐           │
            │ AllowOnBankHoliday    │           │
            │     Config?           │           │
            └───────────┬───────────┘           │
                        │                       │
              ┌─────────┴─────────┐             │
             No                  Yes            │
              │                   │             │
              ▼                   └─────────────┤
      Return "not                               │
      allowed today"                            │
                                                │
                         ┌──────────────────────┘
                         │
                         ▼
                ┌────────────────────┐
                │  3. Mode Check     │
                │ ModeConfig.Enabled?│
                └────────┬───────────┘
                         │
                Enabled? ├───No───► Return "not enabled for partner"
                         │
                        Yes
                         │
                ┌────────▼───────────┐
                │  4. On-Hold Check  │
                │    OnHold flag?    │
                └────────┬───────────┘
                         │
                OnHold?  ├───Yes──► Return "partner is on hold"
                         │
                        No
                         │
                ┌────────▼───────────┐
                │  All Validations   │
                │      Passed        │
                └────────┬───────────┘
                         │
                         ▼
                ┌────────────────────┐
                │  Execute Workflow  │
                │  (Start Settlement)│
                └────────────────────┘
```

---

## Summary Table

| # | Validation | Service | Method | Config Type | Default | Error Message |
|---|------------|---------|--------|-------------|---------|---------------|
| 1 | Lock Check | OperationLock | `IsLocked()` | N/A | Blocks if locked | "settlement operation is in progress for the partner" |
| 2 | Holiday Check | Calendar + Config | `IsBankHoliday()` + `GetAllowOnBankHolidayConfigElseDefault()` | `CONFIG_TYPE_ALLOW_ON_BANK_HOLIDAY` | false (block on holidays) | "settlement is not allowed today" |
| 3 | Mode Enabled | Config | `GetModeConfig()` | `CONFIG_TYPE_MODE` | Must be enabled | "settlement is not enabled for this partner" |
| 4 | On-Hold | Config | `GetOnHoldConfigElseDefault()` | `CONFIG_TYPE_ON_HOLD_FLAG` | false (not on hold) | "settlement for this partner is on hold" |

---

## Key Files

| File | Purpose |
|------|---------|
| `/internal/settlement/server.go` | API entry point (`SettleViaWorkflow`) |
| `/internal/settlement/service.go` | Pre-processing logic (`settleViaWorkflowPreProcess`, `isSettlementAllowed`) |
| `/internal/settlement/validator.go` | Request validation |
| `/internal/config/service.go` | Config service for mode, holiday, on-hold checks |
| `/internal/operationlock/service.go` | Operation lock service |

---

## Error Response Format

All validation failures return the same response structure:

```go
&settlementpb.SettleViaWorkflowResponse{
    Status: &bankstack_commons.ResponseStatus{
        Success:   false,
        Message:   map[string]string{"reason": "<error message>"},
        ErrorType: "NOT_ALLOWED",
    },
}
```
