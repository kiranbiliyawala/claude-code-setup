# Architecture Overview

## What is finhq-verse?

finhq-verse is a **microservices platform for financial operations** built as a monorepo. It provides core infrastructure for:

- **Multi-tenant** financial data management
- **Double-entry bookkeeping** and ledger operations
- **Calendar and scheduling** for financial events
- **Settlement processing** for transactions
- **Configuration management** across tenants

---

## Technology Stack

| Layer | Technology | Version |
|-------|------------|---------|
| **Language** | Java (Amazon Corretto) | 21 |
| **Framework** | Spring Boot | 3.5.0 |
| **Build** | Gradle | 8.4 |
| **Monorepo** | Nx | 21.0.3 |
| **Database** | MySQL | 8.0 |
| **Cache** | Redis | 7.2 |
| **Workflow** | Temporal | 1.29 |
| **Tracing** | Jaeger (OpenTelemetry) | 1.47 |
| **API Spec** | OpenAPI | 3.0.3 |

---

## System Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API Gateway                                      │
│                    (Routes requests, adds headers)                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
            ┌───────────┐   ┌───────────┐   ┌───────────┐
            │Foundation │   │Bookkeeping│   │ Calendar  │
            │  :7080    │   │  :7081    │   │  :7085    │
            └─────┬─────┘   └─────┬─────┘   └─────┬─────┘
                  │               │               │
                  │               │               │
            ┌─────┴───────────────┴───────────────┴─────┐
            │                                           │
            ▼                                           ▼
    ┌───────────────┐                           ┌───────────────┐
    │Configuration  │                           │  Settlement   │
    │    :7084      │                           │    :7086      │
    └───────┬───────┘                           └───────┬───────┘
            │                                           │
            └─────────────────┬─────────────────────────┘
                              │
                              ▼
                    ┌───────────────┐
                    │   Consumer    │
                    │    :7082      │
                    └───────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│  MySQL 8.0    │     │  Redis 7.2    │     │   Temporal    │
│    :3306      │     │    :6379      │     │    :8080      │
└───────────────┘     └───────────────┘     └───────────────┘
```

---

## Core Architectural Principles

### 1. Multi-Tenancy by Default

Every piece of data is scoped to:
- **Organization (orgId)** - The top-level tenant (a customer)
- **Namespace (namespaceId)** - Sub-division within an org

This scoping is enforced at the repository layer via `RepositoryScope`.

### 2. API-First Development

All APIs are defined in OpenAPI 3.0 specifications first:
```
OpenAPI YAML → Code Generation → Service Implementation
```

This ensures:
- Consistent API contracts
- Auto-generated documentation
- Type-safe client/server code

### 3. Audit Everything

Every entity change is tracked via Hibernate Envers:
- All entities marked with `@Audited`
- Changes stored in `*_aud` tables
- Full history queryable via `findRevision()`

### 4. Dual Environment Support

Each tenant can operate in two modes:
- **LIVE** - Production data
- **SANDBOX** - Test/staging data

Data is routed to separate databases based on the mode.

### 5. Cursor-Based Pagination

All list endpoints use cursor pagination instead of offset:
- More stable (inserts don't shift pages)
- Better performance on large datasets
- Bidirectional navigation support

---

## Request Flow

```
1. HTTP Request arrives with headers:
   - X-Finhq-Mode: LIVE
   - X-Finhq-Org-Id: org_123
   - X-Finhq-Namespace-Id: ns_456

2. PassportContextFilter extracts headers → builds Passport → stores in ThreadLocal

3. Controller (generated from OpenAPI) receives request

4. Service creates RepositoryScope from PassportContext

5. Repository applies scope to all queries automatically

6. DataSourceRouter selects correct database based on mode

7. Response returned with consistent format
```

---

## Module Dependencies

```
finhq-commons-java (no Spring dependency)
├── finhq-context      ← Thread-local context
├── finhq-errors       ← Exception handling
└── finhq-helpers      ← Utilities (ULID, Date, etc.)
        │
        ▼
finhq-commons-spring (Spring-integrated)
├── finhq-entity       ← Entity framework, Repository
├── finhq-spring       ← Web filters, exception handler
└── finhq-slt          ← System-level testing
        │
        ▼
finhq-openapi-java (Generated from OpenAPI)
        │
        ▼
Services (Foundation, Bookkeeping, Calendar, etc.)
```

---

## Database Design Principles

### Naming Conventions
- Tables: `snake_case` (e.g., `bookkeeping_accounts`)
- Audit tables: `*_aud` suffix
- Revision info: `revinfo` table

### Standard Columns (All Tables)
```sql
id              BIGINT AUTO_INCREMENT PRIMARY KEY
external_id     VARCHAR(36) UNIQUE          -- ULID for API
org_id          VARCHAR(36)                 -- Tenant scoping
namespace_id    VARCHAR(36)                 -- Sub-tenant scoping
version         INT                         -- Optimistic locking
created_at      DATETIME
updated_at      DATETIME
created_by      VARCHAR(36)
updated_by      VARCHAR(36)
```

### Partitioning Strategy
High-volume tables (bookkeeping_transactions) use quarterly range partitioning on date columns for performance.

---

## Next Steps

- [Monorepo Structure](./02-monorepo-structure.md) - Understand how the code is organized
- [Service Topology](./03-service-topology.md) - Learn about each service and their relationships
