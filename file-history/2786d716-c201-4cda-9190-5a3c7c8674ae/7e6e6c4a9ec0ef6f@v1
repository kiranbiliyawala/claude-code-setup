# Service Topology

## Service Overview

| Service | Port | Purpose | Key Entities |
|---------|------|---------|--------------|
| **Foundation** | 7080 | Core tenant management | Organization, Namespace, Partner, Module |
| **Bookkeeping** | 7081 | Ledger and transactions | Account, Transaction, TransactionLeg, Spec |
| **Consumer** | 7082 | Event consumption | Consumer, ConsumerEventHandler |
| **Configuration** | 7084 | Config management | ConfigurationType, Configuration, Profile |
| **Calendar** | 7085 | Events and scheduling | Calendar, CalendarEvent, CalendarEventType |
| **Settlement** | 7086 | Settlement processing | Settlement, SettlementConfig |
| **OpenAPI** | 7090 | API documentation | N/A (Node.js) |

---

## Service Dependencies

```
                    ┌─────────────────┐
                    │   Foundation    │
                    │   (Core/Base)   │
                    └────────┬────────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   Bookkeeping   │ │    Calendar     │ │  Configuration  │
└────────┬────────┘ └────────┬────────┘ └────────┬────────┘
         │                   │                   │
         └───────────────────┼───────────────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │   Settlement    │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │    Consumer     │
                    │ (Event Handler) │
                    └─────────────────┘
```

---

## Foundation Service (Port 7080)

**The core service that all others depend on.**

### Purpose
- Manage organizations (tenants)
- Manage namespaces (sub-tenants)
- Manage partners (business entities)
- Manage modules (feature flags)

### Key Entities

| Entity | Scoping | Description |
|--------|---------|-------------|
| Organization | System | Top-level tenant |
| Namespace | Org-scoped | Sub-division within org |
| Partner | Org+Namespace | Business partner entity |
| Module | Org+Namespace | Feature/module registration |

### API Endpoints
```
POST   /v1/organizations
GET    /v1/organizations
GET    /v1/organizations/{id}
PATCH  /v1/organizations/{id}

POST   /v1/namespaces
GET    /v1/namespaces
GET    /v1/namespaces/{id}
PATCH  /v1/namespaces/{id}
```

### Key Files
```
finhq-foundation/src/main/java/io/finhq/foundation/
├── organization/
│   ├── OrganizationEntity.java
│   ├── OrganizationService.java
│   └── ...
├── namespace/
├── partner/
└── module/
```

---

## Bookkeeping Service (Port 7081)

**Double-entry ledger system for financial transactions.**

### Purpose
- Manage bookkeeping accounts
- Post multi-leg transactions
- Track account balances
- Maintain transaction history

### Key Entities

| Entity | Scoping | Description |
|--------|---------|-------------|
| BookkeepingAccount | Org+Namespace | Account with currency and normal balance |
| BookkeepingTransaction | Org+Namespace | Transaction header (partitioned) |
| BookkeepingTransactionLeg | Org+Namespace | Individual debit/credit leg |
| BookkeepingSpec | Org+Namespace | Schema definition for accounts/transactions |

### Special Features
- **Quarterly Partitioning**: Transactions partitioned by date for performance
- **Multi-Leg Transactions**: Support for complex accounting entries
- **Spec Versioning**: Account/transaction schemas are versioned

### Database Tables
```sql
bookkeeping_accounts           -- Account definitions
bookkeeping_accounts_aud       -- Audit trail
bookkeeping_transactions       -- Transaction headers (partitioned)
bookkeeping_transactions_aud   -- Audit trail
bookkeeping_transaction_legs   -- Debit/credit entries
bookkeeping_specs              -- Schema definitions
bookkeeping_tags               -- Flexible tagging
bookkeeping_link_types         -- Relationship types
revinfo                        -- Revision metadata (partitioned)
```

---

## Calendar Service (Port 7085)

**Time-bound rules and event management.**

### Purpose
- Manage multiple calendars
- Define event types
- Track calendar events (holidays, blackouts, etc.)
- Query availability

### Key Entities

| Entity | Scoping | Description |
|--------|---------|-------------|
| Calendar | Org+Namespace | Calendar definition |
| CalendarEventType | Org+Namespace | Event type template |
| CalendarEvent | Org+Namespace | Actual event instance |

### Event Types
- `HOLIDAY` - Public holidays
- `BLACKOUT` - No-processing periods
- `MAINTENANCE` - Scheduled maintenance
- `CUSTOM` - User-defined events

### Features
- **Overlap Validation**: Prevents conflicting events
- **Multi-Calendar**: Each entity can have multiple calendars

---

## Configuration Service (Port 7084)

**Centralized configuration with schema validation.**

### Purpose
- Define configuration types (with JSON Schema)
- Store configuration values
- Profile-based resolution
- Target-specific overrides

### Key Entities

| Entity | Scoping | Description |
|--------|---------|-------------|
| ConfigurationType | Org+Namespace | Schema definition |
| Configuration | Org+Namespace | Configuration instance |
| Profile | Org+Namespace | Configuration profile |
| ProfileTarget | Org+Namespace | Target-specific override |

### Features
- **JSON Schema Validation**: All configs validated against schema
- **Profile Resolution**: Hierarchical config resolution
- **Foundation Integration**: Calls Foundation for org context

---

## Consumer Service (Port 7082)

**Event consumption and handling framework.**

### Purpose
- Register event consumers
- Define event handlers
- Process events from queues
- Resilient event processing

### Key Entities

| Entity | Scoping | Description |
|--------|---------|-------------|
| Consumer | Org+Namespace | Consumer instance |
| ConsumerEventHandler | Org+Namespace | Event handler definition |

### Features
- **Kafka Support**: Optional Kafka integration
- **AWS SQS Support**: Queue-based processing
- **Resilience4j**: Retry and circuit breaker patterns
- **WebFlux**: Reactive event processing
- **Scheduling**: Scheduled task execution

### Dependencies
```groovy
implementation 'org.springframework.kafka:spring-kafka'
implementation 'software.amazon.awssdk:sqs'
implementation 'io.github.resilience4j:resilience4j-retry'
implementation 'io.github.resilience4j:resilience4j-circuitbreaker'
```

---

## Settlement Service (Port 7086)

**Settlement processing for transactions.**

### Purpose
- Configure settlement rules
- Assign transactions to settlements
- Process settlement payouts
- Track settlement status

### Key Entities

| Entity | Scoping | Description |
|--------|---------|-------------|
| Settlement | Org+Namespace | Settlement batch |
| SettlementConfig | Org+Namespace | Settlement rules |

---

## Inter-Service Communication

### HTTP REST (Primary)
Services communicate via REST APIs with standard headers:
```
X-Finhq-Mode: LIVE
X-Finhq-Org-Id: <org-external-id>
X-Finhq-Namespace-Id: <namespace-external-id>
X-Finhq-Request-Id: <correlation-id>
```

### Kafka Events (Optional)
```yaml
EVENTS_KAFKA_PUBLISHER_ENABLED: false  # Enable for Kafka
```

When enabled:
- Services publish events to Kafka topics
- Consumer service subscribes and processes

### Temporal Workflows
For long-running orchestrated processes:
- Settlement batching
- Multi-step validations
- Retry handling

---

## Infrastructure Services

| Service | Port | Purpose |
|---------|------|---------|
| MySQL 8.0 | 3306 | Primary database |
| Redis 7.2 | 6379 | Caching layer |
| Temporal | 8080 | Workflow orchestration |
| Temporal UI | 8080 | Workflow visualization |
| Jaeger | 16686 | Distributed tracing |

---

## Next Steps

- [Foundation Service Deep-Dive](../services/01-foundation.md)
- [Passport Pattern](../patterns/01-passport-pattern.md) - How multi-tenancy works
