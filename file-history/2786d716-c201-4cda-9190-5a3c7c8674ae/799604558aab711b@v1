# Foundation Service Deep-Dive

## Overview

**Port:** 7080
**Purpose:** Core tenant management - the foundation that all other services depend on

---

## Domain Model

```
┌─────────────────────────────────────────────────────────────────┐
│                         Organization                             │
│  - Top-level tenant (customer)                                  │
│  - Contains: name, country, timezone, support info              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                          Namespace                               │
│  - Sub-division within org                                      │
│  - Contains: name, description, status                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
                    ▼                   ▼
┌─────────────────────────┐   ┌─────────────────────────┐
│        Partner          │   │         Module          │
│  - Business partner     │   │  - Feature module       │
│  - Within namespace     │   │  - Within namespace     │
└─────────────────────────┘   └─────────────────────────┘
```

---

## Entities

### OrganizationEntity

**Scope:** System-level (no org/namespace scoping)

```java
@Entity
@Audited
@Table(name = "organizations")
public class OrganizationEntity extends AbstractEntity implements Auditable {
    private Status status;      // ACTIVE, INACTIVE
    private String name;        // Organization name
    private String country;     // ISO country code (2 chars)
    private String timezone;    // e.g., "Asia/Kolkata"
    private String supportEmail;
    private String supportPhone;
}
```

**Database:**
```sql
CREATE TABLE organizations (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    external_id     VARCHAR(36) NOT NULL UNIQUE,
    version         INT NOT NULL DEFAULT 0,
    status          VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    name            VARCHAR(255) NOT NULL,
    country         VARCHAR(2) NOT NULL,
    timezone        VARCHAR(50) NOT NULL,
    support_email   VARCHAR(255),
    support_phone   VARCHAR(20),
    created_at      DATETIME NOT NULL,
    updated_at      DATETIME NOT NULL,
    created_by      VARCHAR(36) NOT NULL DEFAULT 'SYSTEM',
    updated_by      VARCHAR(36) NOT NULL DEFAULT 'SYSTEM'
);
```

### NamespaceEntity

**Scope:** Organization-level

```java
@Entity
@Audited
@Table(name = "namespaces")
public class NamespaceEntity extends AbstractOrgScopedEntity implements Auditable {
    private Status status;
    private String name;
    private String description;
}
```

### PartnerEntity

**Scope:** Namespace-level

```java
@Entity
@Audited
@Table(name = "partners")
public class PartnerEntity extends AbstractNamespaceScopedEntity implements Auditable {
    private Status status;
    private String name;
    private PartnerType type;
    // ...
}
```

### ModuleEntity

**Scope:** Namespace-level

```java
@Entity
@Audited
@Table(name = "modules")
public class ModuleEntity extends AbstractNamespaceScopedEntity implements Auditable {
    private String name;
    private String code;
    private Boolean enabled;
    // ...
}
```

---

## API Endpoints

### Organizations

```yaml
POST   /v1/organizations              # Create organization
GET    /v1/organizations              # List organizations
GET    /v1/organizations/{id}         # Get organization
PATCH  /v1/organizations/{id}         # Update organization
```

### Namespaces

```yaml
POST   /v1/namespaces                 # Create namespace
GET    /v1/namespaces                 # List namespaces
GET    /v1/namespaces/{id}            # Get namespace
PATCH  /v1/namespaces/{id}            # Update namespace
```

### Partners

```yaml
POST   /v1/partners                   # Create partner
GET    /v1/partners                   # List partners
GET    /v1/partners/{id}              # Get partner
PATCH  /v1/partners/{id}              # Update partner
```

---

## Service Implementation

### OrganizationService

**File:** `finhq-foundation/src/main/java/io/finhq/foundation/organization/OrganizationService.java`

```java
@Service
@Validated
public class OrganizationService
        extends AbstractService<
                OrganizationEntity,
                OrganizationRepository,
                Organization,
                CreateOrganizationRequest,
                UpdateOrganizationRequest,
                OrganizationListResponse>
        implements OrganizationApiDelegate {

    public OrganizationService(
            OrganizationRepository repository,
            OrganizationMapper mapper,
            OrganizationValidator validator) {
        super(repository, mapper, validator);
    }

    @Override
    public Organization createOrganization(CreateOrganizationRequest request) {
        return createEntity(request);
    }

    @Override
    public Organization getOrganization(String id) {
        return getEntity(id);
    }

    @Override
    public OrganizationListResponse listOrganizations(
            Optional<String> pageAfter,
            Optional<String> pageBefore,
            Optional<Integer> pageSize) {
        return listEntities(pageAfter, pageBefore, pageSize, null,
                OrganizationListResponse::new);
    }

    @Override
    public Organization updateOrganization(String id, UpdateOrganizationRequest request) {
        return updateEntity(id, request);
    }
}
```

---

## File Structure

```
finhq-foundation/
├── src/main/java/io/finhq/foundation/
│   ├── FoundationApplication.java      # Spring Boot entry
│   ├── organization/
│   │   ├── OrganizationEntity.java
│   │   ├── OrganizationRepository.java
│   │   ├── OrganizationRepositoryImpl.java
│   │   ├── OrganizationJpaRepository.java
│   │   ├── OrganizationMapper.java
│   │   ├── OrganizationValidator.java
│   │   ├── OrganizationService.java
│   │   └── OrganizationSpecification.java
│   ├── namespace/
│   │   └── ... (same pattern)
│   ├── partner/
│   │   └── ... (same pattern)
│   └── module/
│       └── ... (same pattern)
├── src/main/resources/
│   ├── application.yml
│   └── db/migration/
│       ├── V1__create_organizations.sql
│       ├── V2__create_namespaces.sql
│       └── ...
└── src/test/java/io/finhq/foundation/
    └── ... (tests)
```

---

## Key Patterns Demonstrated

### 1. System-Level vs Scoped Entities

```java
// Organization - No scoping (it IS the scope)
OrganizationEntity extends AbstractEntity

// Namespace - Scoped to organization
NamespaceEntity extends AbstractOrgScopedEntity

// Partner - Scoped to namespace
PartnerEntity extends AbstractNamespaceScopedEntity
```

### 2. Repository Scope Usage

```java
// For Organization (system-level)
RepositoryScope scope = RepositoryScope.empty();

// For Namespace (needs org context)
RepositoryScope scope = RepositoryScope.builder()
    .orgId(orgId)
    .build();

// For Partner (needs full context)
RepositoryScope scope = RepositoryScope.create(); // From PassportContext
```

### 3. Validation Example

```java
@Component
public class OrganizationValidator
        implements EntityRequestValidator<CreateOrganizationRequest, UpdateOrganizationRequest> {

    @Override
    public void validateCreateRequest(CreateOrganizationRequest request) {
        // Validate timezone
        if (!ZoneId.getAvailableZoneIds().contains(request.getTimezone())) {
            throw new ApplicationException(GenericErrorCode.BAD_REQUEST)
                .withDetail("field", "timezone")
                .withDetail("value", request.getTimezone());
        }
    }
}
```

---

## Running Locally

```bash
# Start infrastructure
make up

# Build foundation service
npx nx build finhq-foundation

# Run foundation service
npx nx serve finhq-foundation

# Test API
curl -X POST http://localhost:7080/v1/organizations \
  -H "Content-Type: application/json" \
  -H "X-Finhq-Mode: LIVE" \
  -d '{
    "name": "Test Org",
    "country": "IN",
    "timezone": "Asia/Kolkata"
  }'
```

---

## Study Exercises

1. **Read the OrganizationService** - Understand how it delegates to AbstractService
2. **Trace a create request** - Follow from controller → service → repository → entity
3. **Study the Mapper** - See how DTOs convert to entities and back
4. **Review Flyway migrations** - Understand the database schema
5. **Write a test** - Create an integration test for organization CRUD

---

## Next Steps

- [Bookkeeping Service](./02-bookkeeping.md) - More complex domain
- [Creating an Entity](../examples/01-creating-entity.md) - Hands-on practice
