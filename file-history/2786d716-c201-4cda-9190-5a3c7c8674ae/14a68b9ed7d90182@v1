# Service Pattern

## Overview

finhq-verse uses an **AbstractService** base class that provides standardized CRUD operations. Services extend this class and implement OpenAPI-generated delegate interfaces.

---

## The Service Template

**Location:** `finhq-commons-spring/finhq-entity/src/main/java/io/finhq/commons/spring/entity/AbstractService.java`

```java
public abstract class AbstractService<
    E extends AbstractEntity,    // Entity type
    R extends Repository<E>,     // Repository type
    M,                           // API Model (response DTO)
    C,                           // Create Request DTO
    U,                           // Update Request DTO
    L                            // List Response type
> {
    protected static final int DEFAULT_PAGE_SIZE = 10;

    protected final R repository;
    protected final EntityMapper<E, M, C, U> mapper;
    protected final EntityRequestValidator<C, U> validator;

    protected AbstractService(R repository,
                             EntityMapper<E, M, C, U> mapper,
                             EntityRequestValidator<C, U> validator) {
        this.repository = repository;
        this.mapper = mapper;
        this.validator = validator;
    }

    // ═══════════════════════════════════════════════════════════════════
    // PROTECTED CRUD METHODS (for subclasses to call)
    // ═══════════════════════════════════════════════════════════════════

    @ResponseStatus(HttpStatus.CREATED)
    protected M createEntity(C request) {
        validator.validateCreateRequest(request);
        E entity = mapper.mapCreateRequestToEntity(request);
        E saved = repository.create(RepositoryScope.create(), entity);
        return mapper.mapEntityToApiModel(saved);
    }

    protected M getEntity(String id) {
        E entity = repository.findByExternalIdOrFail(RepositoryScope.create(), id);
        return mapper.mapEntityToApiModel(entity);
    }

    protected M getEntityByExternalReference(String externalReference) {
        E entity = repository.findByExternalReferenceOrFail(
            RepositoryScope.create(), externalReference);
        return mapper.mapEntityToApiModel(entity);
    }

    protected L listEntities(
            Optional<String> pageAfter,
            Optional<String> pageBefore,
            Optional<Integer> pageSize,
            Specification<E> specification,
            BiFunction<ListResponseMeta, List<M>, L> responseConstructor) {

        CursorPageRequest pageRequest = createCursorPageRequest(
            pageAfter, pageBefore, pageSize);
        CursorPage<E> page = repository.findAll(
            RepositoryScope.create(), specification, pageRequest);

        List<M> models = page.getContent().stream()
                .map(mapper::mapEntityToApiModel)
                .toList();

        ListResponseMeta meta = new ListResponseMeta(page.getSize());
        meta.pageAfter(page.getNextCursor());
        meta.pageBefore(page.getPreviousCursor());

        return responseConstructor.apply(meta, models);
    }

    protected M updateEntity(String id, U request) {
        validator.validateUpdateRequest(id, request);
        E entity = repository.findByExternalIdOrFail(RepositoryScope.create(), id);
        EntityUpdates<E> updates = mapper.mapUpdateRequestToEntityUpdates(entity, request);
        E updated = repository.update(RepositoryScope.create(), entity, updates);
        return mapper.mapEntityToApiModel(updated);
    }
}
```

---

## Implementing a Service

### Step 1: Define the Service Class

```java
@Service
@Validated
public class OrganizationService
        extends AbstractService<
                OrganizationEntity,          // E - Entity
                OrganizationRepository,      // R - Repository
                Organization,                // M - API Model
                CreateOrganizationRequest,   // C - Create DTO
                UpdateOrganizationRequest,   // U - Update DTO
                OrganizationListResponse>    // L - List Response
        implements OrganizationApiDelegate { // Generated from OpenAPI

    public OrganizationService(
            OrganizationRepository repository,
            OrganizationMapper mapper,
            OrganizationValidator validator) {
        super(repository, mapper, validator);
    }

    // ═══════════════════════════════════════════════════════════════════
    // IMPLEMENT OpenAPI DELEGATE METHODS
    // ═══════════════════════════════════════════════════════════════════

    @Override
    public Organization createOrganization(CreateOrganizationRequest request) {
        return createEntity(request);
    }

    @Override
    public Organization getOrganization(String id) {
        return getEntity(id);
    }

    @Override
    public OrganizationListResponse listOrganizations(
            Optional<String> pageAfter,
            Optional<String> pageBefore,
            Optional<Integer> pageSize) {
        return listEntities(pageAfter, pageBefore, pageSize, null,
                OrganizationListResponse::new);
    }

    @Override
    public Organization updateOrganization(String id, UpdateOrganizationRequest request) {
        return updateEntity(id, request);
    }
}
```

### Step 2: Implement the Mapper

```java
@Component
public class OrganizationMapper
        implements EntityMapper<OrganizationEntity, Organization,
                CreateOrganizationRequest, UpdateOrganizationRequest> {

    @Override
    public OrganizationEntity mapCreateRequestToEntity(CreateOrganizationRequest request) {
        return OrganizationEntity.builder()
                .name(request.getName())
                .country(request.getCountry())
                .timezone(request.getTimezone())
                .supportEmail(request.getSupportEmail())
                .supportPhone(request.getSupportPhone())
                .status(Status.ACTIVE)
                .build();
    }

    @Override
    public EntityUpdates<OrganizationEntity> mapUpdateRequestToEntityUpdates(
            OrganizationEntity entity,
            UpdateOrganizationRequest request) {

        Set<String> nullableProperties = new HashSet<>();

        if (request.getName() != null) {
            entity.setName(request.getName());
        }
        if (request.getCountry() != null) {
            entity.setCountry(request.getCountry());
        }
        // Handle nullable field
        if (request.isSupportEmailPresent()) {
            entity.setSupportEmail(request.getSupportEmail());
            if (request.getSupportEmail() == null) {
                nullableProperties.add("supportEmail");
            }
        }

        return new EntityUpdates<>(entity, nullableProperties);
    }

    @Override
    public Organization mapEntityToApiModel(OrganizationEntity entity) {
        return new Organization()
                .id(entity.getExternalId())
                .name(entity.getName())
                .country(entity.getCountry())
                .timezone(entity.getTimezone())
                .supportEmail(entity.getSupportEmail())
                .supportPhone(entity.getSupportPhone())
                .status(Organization.StatusEnum.valueOf(entity.getStatus().name()))
                .createdAt(entity.getCreatedAt())
                .updatedAt(entity.getUpdatedAt());
    }
}
```

### Step 3: Implement the Validator

```java
@Component
public class OrganizationValidator
        implements EntityRequestValidator<CreateOrganizationRequest, UpdateOrganizationRequest> {

    private final OrganizationRepository repository;

    public OrganizationValidator(OrganizationRepository repository) {
        this.repository = repository;
    }

    @Override
    public void validateCreateRequest(CreateOrganizationRequest request) {
        // Check for duplicates
        repository.failIfExists(
            RepositoryScope.empty(),  // Org-level check
            OrganizationSpecification.hasName(request.getName())
        );

        // Validate timezone
        if (!isValidTimezone(request.getTimezone())) {
            throw new ApplicationException(GenericErrorCode.BAD_REQUEST)
                .withDetail("field", "timezone")
                .withDetail("message", "Invalid timezone");
        }
    }

    @Override
    public void validateUpdateRequest(String id, UpdateOrganizationRequest request) {
        // Validate if name is being changed to existing name
        if (request.getName() != null) {
            // ... validation logic
        }
    }
}
```

---

## The 4 Required Components

For each domain entity, you need these components:

| Component | Interface | Purpose |
|-----------|-----------|---------|
| **Entity** | Extends `AbstractEntity` | JPA entity class |
| **Repository** | Extends `Repository<E>` | Data access |
| **Mapper** | Implements `EntityMapper` | DTO ↔ Entity conversion |
| **Validator** | Implements `EntityRequestValidator` | Business validation |

```
┌────────────────┐     ┌────────────────┐     ┌────────────────┐
│    Service     │────▶│   Repository   │────▶│    Entity      │
└───────┬────────┘     └────────────────┘     └────────────────┘
        │
        │ uses
        ▼
┌────────────────┐     ┌────────────────┐
│    Mapper      │     │   Validator    │
└────────────────┘     └────────────────┘
```

---

## EntityMapper Interface

```java
public interface EntityMapper<E, M, C, U> {

    /**
     * Convert create request to entity.
     */
    E mapCreateRequestToEntity(C createRequest);

    /**
     * Convert update request to EntityUpdates.
     * This handles partial updates where null might mean "no change" or "set to null".
     */
    EntityUpdates<E> mapUpdateRequestToEntityUpdates(E entity, U updateRequest);

    /**
     * Convert entity to API model.
     */
    M mapEntityToApiModel(E entity);
}
```

---

## EntityUpdates for Partial Updates

The challenge with PATCH updates:
- `null` could mean "don't change this field"
- `null` could mean "set this field to null"

Solution: `EntityUpdates` tracks which null values are intentional:

```java
public class EntityUpdates<E> {
    private final E entity;                           // Entity with new values
    private final Set<String> presentNullableProperties; // Fields explicitly set to null

    public EntityUpdates(E entity, Set<String> presentNullableProperties) {
        this.entity = entity;
        this.presentNullableProperties = presentNullableProperties;
    }

    public boolean isPropertyPresentAndNull(String propertyName) {
        return presentNullableProperties.contains(propertyName);
    }
}
```

In mapper:

```java
@Override
public EntityUpdates<E> mapUpdateRequestToEntityUpdates(E entity, U request) {
    Set<String> nullableProps = new HashSet<>();

    // Regular field - null means "no change"
    if (request.getName() != null) {
        entity.setName(request.getName());
    }

    // Nullable field - check if explicitly provided
    if (request.isDescriptionPresent()) {  // Generated by OpenAPI
        entity.setDescription(request.getDescription());
        if (request.getDescription() == null) {
            nullableProps.add("description");  // Track intentional null
        }
    }

    return new EntityUpdates<>(entity, nullableProps);
}
```

---

## EntityRequestValidator Interface

```java
public interface EntityRequestValidator<C, U> {

    /**
     * Validate create request.
     * Throw ApplicationException if invalid.
     */
    void validateCreateRequest(C request);

    /**
     * Validate update request.
     * Throw ApplicationException if invalid.
     */
    void validateUpdateRequest(String id, U request);
}
```

Common validation patterns:

```java
@Override
public void validateCreateRequest(CreateRequest request) {
    // Uniqueness check
    repository.failIfExists(scope, hasName(request.getName()));

    // Business rule validation
    if (!isValidFormat(request.getCode())) {
        throw new ApplicationException(MyErrorCode.INVALID_CODE_FORMAT)
            .withDetail("code", request.getCode());
    }

    // Reference validation
    if (request.getParentId() != null) {
        parentRepository.findByExternalIdOrFail(scope, request.getParentId());
    }
}
```

---

## Adding Custom Methods

Override or add methods as needed:

```java
@Service
public class OrganizationService extends AbstractService<...> {

    // ... standard methods ...

    /**
     * Custom method: Deactivate organization.
     */
    public Organization deactivateOrganization(String id) {
        OrganizationEntity entity = repository.findByExternalIdOrFail(
            RepositoryScope.create(), id);

        entity.setStatus(Status.INACTIVE);
        OrganizationEntity updated = repository.update(
            RepositoryScope.create(), entity, entity);

        return mapper.mapEntityToApiModel(updated);
    }

    /**
     * Custom method: Find by country.
     */
    public OrganizationListResponse findByCountry(
            String country,
            Optional<String> pageAfter,
            Optional<Integer> pageSize) {

        Specification<OrganizationEntity> spec =
            OrganizationSpecification.hasCountry(country);

        return listEntities(pageAfter, Optional.empty(), pageSize, spec,
                OrganizationListResponse::new);
    }
}
```

---

## OpenAPI Delegate Pattern

Services implement generated `*ApiDelegate` interfaces:

```java
// Generated by openapi-generator
public interface OrganizationApiDelegate {
    Organization createOrganization(CreateOrganizationRequest request);
    Organization getOrganization(String id);
    OrganizationListResponse listOrganizations(
        Optional<String> pageAfter,
        Optional<String> pageBefore,
        Optional<Integer> pageSize);
    Organization updateOrganization(String id, UpdateOrganizationRequest request);
}
```

The generated controller calls the delegate:

```java
// Generated controller
@RestController
public class OrganizationApiController implements OrganizationApi {

    private final OrganizationApiDelegate delegate;

    @Override
    public ResponseEntity<Organization> createOrganization(
            CreateOrganizationRequest request) {
        return ResponseEntity.status(HttpStatus.CREATED)
                .body(delegate.createOrganization(request));
    }
}
```

---

## Key Takeaways

1. **Extend AbstractService** - Get CRUD for free
2. **Implement ApiDelegate** - Connect to OpenAPI-generated controllers
3. **Use EntityMapper** - Clean DTO ↔ Entity conversion
4. **Use EntityRequestValidator** - Centralized validation
5. **EntityUpdates for PATCH** - Handle partial updates correctly
6. **Override as needed** - Add custom business logic

---

## Next Steps

- [Entity Pattern](./04-entity-pattern.md) - Entity hierarchy and auditing
- [Error Handling](./05-error-handling.md) - ApplicationException pattern
