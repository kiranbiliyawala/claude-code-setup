# Monorepo Structure

## Overview

finhq-verse uses **Nx** for monorepo management with **Gradle** as the Java build system. This hybrid approach provides:

- Nx for dependency graph and affected builds
- Gradle for Java compilation and testing
- Shared configuration across projects

---

## Directory Layout

```
finhq-verse/
│
├── finhq-foundation/              # Core service
│   ├── src/main/java/             # Java source
│   ├── src/main/resources/        # Config, migrations
│   ├── src/test/java/             # Tests
│   └── build.gradle               # Gradle build file
│
├── finhq-bookkeeping/             # Bookkeeping service
├── finhq-calendar/                # Calendar service
├── finhq-settlement/              # Settlement service
├── finhq-configuration/           # Configuration service
├── finhq-consumer/                # Event consumer service
│
├── finhq-commons-java/            # Pure Java libraries
│   ├── finhq-context/             # Thread-local context
│   ├── finhq-errors/              # Error handling
│   └── finhq-helpers/             # Utilities
│
├── finhq-commons-spring/          # Spring libraries
│   ├── finhq-entity/              # Entity framework
│   ├── finhq-spring/              # Web infrastructure
│   └── finhq-slt/                 # Testing utilities
│
├── finhq-openapi/                 # OpenAPI specs (Node.js)
│   ├── specs/                     # YAML specifications
│   └── package.json               # Node dependencies
│
├── finhq-openapi-java/            # Generated Java models
│
├── nx.json                        # Nx configuration
├── workspace.json                 # Nx workspace definition
├── docker-compose.yml             # Infrastructure stack
├── Makefile                       # Development commands
└── README_LLM.md                  # Development guide
```

---

## Service Structure (Standard Layout)

Each service follows this structure:

```
finhq-<service>/
├── src/
│   ├── main/
│   │   ├── java/io/finhq/<service>/
│   │   │   ├── <Service>Application.java     # Spring Boot entry point
│   │   │   ├── <domain>/                     # Domain packages
│   │   │   │   ├── <Entity>Entity.java
│   │   │   │   ├── <Entity>Repository.java
│   │   │   │   ├── <Entity>RepositoryImpl.java
│   │   │   │   ├── <Entity>Mapper.java
│   │   │   │   ├── <Entity>Validator.java
│   │   │   │   ├── <Entity>Service.java
│   │   │   │   └── <Entity>Specification.java
│   │   │   └── config/                       # Service-specific config
│   │   └── resources/
│   │       ├── application.yml               # Spring config
│   │       └── db/migration/                 # Flyway migrations
│   └── test/
│       └── java/io/finhq/<service>/          # Tests
├── build.gradle                              # Gradle build
└── README.md                                 # Service documentation
```

---

## Key Configuration Files

### nx.json
```json
{
  "defaultBase": "master",
  "namedInputs": {
    "default": ["{projectRoot}/**/*"],
    "production": ["default", "!{projectRoot}/**/*.spec.ts"]
  },
  "targetDefaults": {
    "build": { "cache": true, "dependsOn": ["^build"] },
    "test": { "cache": true },
    "lint": { "cache": true }
  },
  "implicitDependencies": {
    "finhq-bookkeeping": ["finhq-foundation"],
    "finhq-calendar": ["finhq-foundation"],
    "finhq-settlement": ["finhq-foundation"],
    "finhq-consumer": ["finhq-foundation"]
  }
}
```

**Key Points:**
- All services depend on `finhq-foundation`
- Build/test/lint are cached
- Uses `master` as the default base branch

### workspace.json
```json
{
  "version": 2,
  "projects": {
    "finhq-foundation": { "root": "finhq-foundation", "sourceRoot": "finhq-foundation/src" },
    "finhq-bookkeeping": { "root": "finhq-bookkeeping", "sourceRoot": "finhq-bookkeeping/src" },
    ...
  }
}
```

### Typical build.gradle
```groovy
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.5.0'
    id 'io.spring.dependency-management' version '1.1.7'
    id 'com.diffplug.spotless' version '7.0.4'
    id 'org.openapi.generator' version '7.13.0'
    id 'pmd'
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
        vendor = JvmVendorSpec.AMAZON
    }
}

dependencies {
    implementation project(':finhq-commons-spring:finhq-spring')
    implementation project(':finhq-commons-spring:finhq-entity')
    implementation project(':finhq-openapi-java')
    // ... other dependencies
}

spotless {
    java {
        palantirJavaFormat('2.40.0')
    }
}
```

---

## Nx Commands Reference

### Build Commands
```bash
# Build a specific project
npx nx build finhq-foundation

# Build all projects
npx nx run-many --target=build --all

# Build only affected projects (since last commit)
npx nx affected --target=build

# Build with verbose output
npx nx build finhq-foundation --verbose
```

### Test Commands
```bash
# Test a specific project
npx nx test finhq-foundation

# Test all projects
npx nx run-many --target=test --all

# Test only affected projects
npx nx affected --target=test
```

### Utility Commands
```bash
# Visualize dependency graph (opens browser)
npx nx graph

# List all projects
npx nx show projects

# Show project details
npx nx show project finhq-foundation

# Reset Nx cache
npx nx reset
```

---

## Makefile Commands

```bash
# Install dependencies (Mac)
make install

# Start Docker infrastructure
make up

# Stop Docker infrastructure
make down

# Build affected projects
make refresh

# Full rebuild and restart
make restart

# View logs
make logs
```

---

## Project Tags

Projects are tagged in `nx.json` for filtering:

| Tag | Projects |
|-----|----------|
| `service` | finhq-foundation, finhq-bookkeeping, finhq-calendar, etc. |
| `library` | finhq-commons-java/*, finhq-commons-spring/* |
| `openapi` | finhq-openapi, finhq-openapi-java |

Example: Build only services
```bash
npx nx run-many --target=build --projects=tag:service
```

---

## Adding a New Project

1. Create directory structure following the standard layout
2. Add `build.gradle` with appropriate dependencies
3. Register in `workspace.json`
4. Add dependencies in `nx.json` if needed
5. Run `npx nx reset` to refresh the graph

---

## Next Steps

- [Service Topology](./03-service-topology.md) - Learn about each service
- [Passport Pattern](../patterns/01-passport-pattern.md) - Understand multi-tenancy
