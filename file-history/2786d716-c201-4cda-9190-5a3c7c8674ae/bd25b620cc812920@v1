# Creating a New Entity (Step-by-Step)

This guide walks through creating a new entity from scratch, demonstrating all the patterns in finhq-verse.

---

## Scenario

We'll create a **Tag** entity in the Foundation service for categorizing resources.

Requirements:
- Namespace-scoped (org + namespace)
- Fields: name, color, description
- Standard CRUD operations
- Auditable

---

## Step 1: Define OpenAPI Specification

**File:** `finhq-openapi/specs/foundation.yaml`

```yaml
# Add to paths section
paths:
  /v1/tags:
    post:
      summary: Create a new tag
      operationId: createTag
      tags: [Tag]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTagRequest'
      responses:
        '201':
          description: Tag created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'

    get:
      summary: List tags
      operationId: listTags
      tags: [Tag]
      parameters:
        - $ref: './shared.yaml#/components/parameters/PageAfter'
        - $ref: './shared.yaml#/components/parameters/PageBefore'
        - $ref: './shared.yaml#/components/parameters/PageSize'
      responses:
        '200':
          description: List of tags
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagListResponse'

  /v1/tags/{id}:
    get:
      summary: Get a tag
      operationId: getTag
      tags: [Tag]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Tag details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'

    patch:
      summary: Update a tag
      operationId: updateTag
      tags: [Tag]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTagRequest'
      responses:
        '200':
          description: Tag updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'

# Add to components/schemas section
components:
  schemas:
    Tag:
      type: object
      required: [id, name, color, status]
      properties:
        id:
          type: string
        name:
          type: string
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
        description:
          type: string
          nullable: true
        status:
          type: string
          enum: [ACTIVE, INACTIVE]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateTagRequest:
      type: object
      required: [name, color]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
        description:
          type: string
          maxLength: 500

    UpdateTagRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
        description:
          type: string
          maxLength: 500
          nullable: true
        status:
          type: string
          enum: [ACTIVE, INACTIVE]

    TagListResponse:
      type: object
      required: [meta, data]
      properties:
        meta:
          $ref: './shared.yaml#/components/schemas/ListResponseMeta'
        data:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
```

---

## Step 2: Regenerate Code

```bash
npx nx build finhq-openapi-java
```

This generates:
- `Tag.java` - API model
- `CreateTagRequest.java` - Create DTO
- `UpdateTagRequest.java` - Update DTO
- `TagListResponse.java` - List response
- `TagApiDelegate.java` - Interface to implement

---

## Step 3: Create Database Migration

**File:** `finhq-foundation/src/main/resources/db/migration/V10__create_tags.sql`

```sql
CREATE TABLE tags (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    external_id     VARCHAR(36) NOT NULL,
    org_id          VARCHAR(36) NOT NULL,
    namespace_id    VARCHAR(36) NOT NULL,
    version         INT NOT NULL DEFAULT 0,
    status          VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    name            VARCHAR(100) NOT NULL,
    color           VARCHAR(7) NOT NULL,
    description     VARCHAR(500),
    created_at      DATETIME NOT NULL,
    updated_at      DATETIME NOT NULL,
    modified_at     DATETIME,
    created_by      VARCHAR(36) NOT NULL DEFAULT 'SYSTEM',
    updated_by      VARCHAR(36) NOT NULL DEFAULT 'SYSTEM',

    UNIQUE INDEX idx_external_id (external_id),
    INDEX idx_org_namespace (org_id, namespace_id),
    UNIQUE INDEX idx_org_ns_name (org_id, namespace_id, name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Audit table
CREATE TABLE tags_aud (
    id              BIGINT NOT NULL,
    rev             INT NOT NULL,
    revtype         TINYINT,
    external_id     VARCHAR(36),
    org_id          VARCHAR(36),
    namespace_id    VARCHAR(36),
    version         INT,
    status          VARCHAR(20),
    name            VARCHAR(100),
    color           VARCHAR(7),
    description     VARCHAR(500),
    created_at      DATETIME,
    updated_at      DATETIME,
    modified_at     DATETIME,
    created_by      VARCHAR(36),
    updated_by      VARCHAR(36),

    PRIMARY KEY (id, rev)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## Step 4: Create Entity

**File:** `finhq-foundation/src/main/java/io/finhq/foundation/tag/TagEntity.java`

```java
package io.finhq.foundation.tag;

import io.finhq.commons.spring.entity.entity.AbstractNamespaceScopedEntity;
import io.finhq.commons.spring.entity.entity.Auditable;
import jakarta.persistence.*;
import lombok.*;
import lombok.experimental.SuperBuilder;
import org.hibernate.envers.Audited;

/**
 * Entity representing a tag for categorizing resources.
 */
@Entity
@Audited
@Table(name = "tags")
@Getter
@Setter
@SuperBuilder
@EqualsAndHashCode(callSuper = true)
public class TagEntity extends AbstractNamespaceScopedEntity implements Auditable {

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private Status status;

    @Column(nullable = false, length = 100)
    private String name;

    @Column(nullable = false, length = 7)
    private String color;

    @Column(length = 500)
    private String description;

    /**
     * Protected no-args constructor for JPA.
     */
    protected TagEntity() {
        super();
    }

    /**
     * Status enum for tag lifecycle.
     */
    public enum Status {
        ACTIVE,
        INACTIVE
    }
}
```

---

## Step 5: Create Repository Interface

**File:** `finhq-foundation/src/main/java/io/finhq/foundation/tag/TagRepository.java`

```java
package io.finhq.foundation.tag;

import io.finhq.commons.spring.entity.repository.Repository;

/**
 * Repository for tag entities.
 */
public interface TagRepository extends Repository<TagEntity> {
    // Custom methods if needed
}
```

---

## Step 6: Create Repository Implementation

**File:** `finhq-foundation/src/main/java/io/finhq/foundation/tag/TagRepositoryImpl.java`

```java
package io.finhq.foundation.tag;

import io.finhq.commons.spring.entity.repository.AbstractRepositoryImpl;
import jakarta.persistence.EntityManager;
import org.springframework.stereotype.Component;

/**
 * Repository implementation for tag entities.
 */
@Component
public class TagRepositoryImpl
        extends AbstractRepositoryImpl<TagEntity>
        implements TagRepository {

    public TagRepositoryImpl(
            TagJpaRepository jpaRepository,
            EntityManager entityManager) {
        super(jpaRepository, entityManager, TagEntity.class);
    }
}
```

---

## Step 7: Create JPA Repository

**File:** `finhq-foundation/src/main/java/io/finhq/foundation/tag/TagJpaRepository.java`

```java
package io.finhq.foundation.tag;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.stereotype.Repository;

/**
 * Spring Data JPA repository for tags.
 */
@Repository
public interface TagJpaRepository
        extends JpaRepository<TagEntity, Long>,
                JpaSpecificationExecutor<TagEntity> {
}
```

---

## Step 8: Create Mapper

**File:** `finhq-foundation/src/main/java/io/finhq/foundation/tag/TagMapper.java`

```java
package io.finhq.foundation.tag;

import io.finhq.commons.spring.entity.EntityMapper;
import io.finhq.commons.spring.entity.EntityUpdates;
import io.finhq.openapi.model.CreateTagRequest;
import io.finhq.openapi.model.Tag;
import io.finhq.openapi.model.UpdateTagRequest;
import org.springframework.stereotype.Component;

import java.util.HashSet;
import java.util.Set;

/**
 * Mapper for converting between Tag DTOs and entities.
 */
@Component
public class TagMapper implements EntityMapper<TagEntity, Tag, CreateTagRequest, UpdateTagRequest> {

    @Override
    public TagEntity mapCreateRequestToEntity(CreateTagRequest request) {
        return TagEntity.builder()
                .name(request.getName())
                .color(request.getColor())
                .description(request.getDescription())
                .status(TagEntity.Status.ACTIVE)
                .build();
    }

    @Override
    public EntityUpdates<TagEntity> mapUpdateRequestToEntityUpdates(
            TagEntity entity,
            UpdateTagRequest request) {

        Set<String> nullableProperties = new HashSet<>();

        if (request.getName() != null) {
            entity.setName(request.getName());
        }

        if (request.getColor() != null) {
            entity.setColor(request.getColor());
        }

        // Handle nullable description
        if (request.isDescriptionPresent()) {
            entity.setDescription(request.getDescription());
            if (request.getDescription() == null) {
                nullableProperties.add("description");
            }
        }

        if (request.getStatus() != null) {
            entity.setStatus(TagEntity.Status.valueOf(request.getStatus().name()));
        }

        return new EntityUpdates<>(entity, nullableProperties);
    }

    @Override
    public Tag mapEntityToApiModel(TagEntity entity) {
        return new Tag()
                .id(entity.getExternalId())
                .name(entity.getName())
                .color(entity.getColor())
                .description(entity.getDescription())
                .status(Tag.StatusEnum.valueOf(entity.getStatus().name()))
                .createdAt(entity.getCreatedAt())
                .updatedAt(entity.getUpdatedAt());
    }
}
```

---

## Step 9: Create Validator

**File:** `finhq-foundation/src/main/java/io/finhq/foundation/tag/TagValidator.java`

```java
package io.finhq.foundation.tag;

import io.finhq.commons.errors.ApplicationException;
import io.finhq.commons.errors.GenericErrorCode;
import io.finhq.commons.spring.entity.EntityRequestValidator;
import io.finhq.commons.spring.entity.repository.RepositoryScope;
import io.finhq.openapi.model.CreateTagRequest;
import io.finhq.openapi.model.UpdateTagRequest;
import org.springframework.stereotype.Component;

/**
 * Validator for tag requests.
 */
@Component
public class TagValidator implements EntityRequestValidator<CreateTagRequest, UpdateTagRequest> {

    private final TagRepository repository;

    public TagValidator(TagRepository repository) {
        this.repository = repository;
    }

    @Override
    public void validateCreateRequest(CreateTagRequest request) {
        // Validate color format
        validateColorFormat(request.getColor());

        // Check for duplicate name
        repository.failIfExists(
                RepositoryScope.create(),
                TagSpecification.hasName(request.getName())
        );
    }

    @Override
    public void validateUpdateRequest(String id, UpdateTagRequest request) {
        if (request.getColor() != null) {
            validateColorFormat(request.getColor());
        }

        // If name is being updated, check for duplicates
        if (request.getName() != null) {
            TagEntity existing = repository.findByExternalIdOrFail(
                    RepositoryScope.create(), id);

            if (!existing.getName().equals(request.getName())) {
                repository.failIfExists(
                        RepositoryScope.create(),
                        TagSpecification.hasName(request.getName())
                );
            }
        }
    }

    private void validateColorFormat(String color) {
        if (!color.matches("^#[0-9A-Fa-f]{6}$")) {
            throw new ApplicationException(GenericErrorCode.BAD_REQUEST)
                    .withDetail("field", "color")
                    .withDetail("message", "Color must be a valid hex color (e.g., #FF5733)");
        }
    }
}
```

---

## Step 10: Create Specification

**File:** `finhq-foundation/src/main/java/io/finhq/foundation/tag/TagSpecification.java`

```java
package io.finhq.foundation.tag;

import org.springframework.data.jpa.domain.Specification;

/**
 * JPA Specifications for tag queries.
 */
public final class TagSpecification {

    private TagSpecification() {
        // Utility class
    }

    public static Specification<TagEntity> hasName(String name) {
        return (root, query, cb) -> cb.equal(root.get("name"), name);
    }

    public static Specification<TagEntity> hasStatus(TagEntity.Status status) {
        return (root, query, cb) -> cb.equal(root.get("status"), status);
    }

    public static Specification<TagEntity> hasColor(String color) {
        return (root, query, cb) -> cb.equal(root.get("color"), color);
    }
}
```

---

## Step 11: Create Service

**File:** `finhq-foundation/src/main/java/io/finhq/foundation/tag/TagService.java`

```java
package io.finhq.foundation.tag;

import io.finhq.commons.spring.entity.AbstractService;
import io.finhq.foundation.openapi.api.TagApiDelegate;
import io.finhq.openapi.model.CreateTagRequest;
import io.finhq.openapi.model.Tag;
import io.finhq.openapi.model.TagListResponse;
import io.finhq.openapi.model.UpdateTagRequest;
import org.springframework.stereotype.Service;
import org.springframework.validation.annotation.Validated;

import java.util.Optional;

/**
 * Service for managing tags.
 */
@Service
@Validated
public class TagService
        extends AbstractService<
                TagEntity,
                TagRepository,
                Tag,
                CreateTagRequest,
                UpdateTagRequest,
                TagListResponse>
        implements TagApiDelegate {

    public TagService(
            TagRepository repository,
            TagMapper mapper,
            TagValidator validator) {
        super(repository, mapper, validator);
    }

    @Override
    public Tag createTag(CreateTagRequest request) {
        return createEntity(request);
    }

    @Override
    public Tag getTag(String id) {
        return getEntity(id);
    }

    @Override
    public TagListResponse listTags(
            Optional<String> pageAfter,
            Optional<String> pageBefore,
            Optional<Integer> pageSize) {
        return listEntities(pageAfter, pageBefore, pageSize, null, TagListResponse::new);
    }

    @Override
    public Tag updateTag(String id, UpdateTagRequest request) {
        return updateEntity(id, request);
    }
}
```

---

## Step 12: Build and Test

```bash
# Build the service
npx nx build finhq-foundation

# Run tests
npx nx test finhq-foundation

# Start the service
npx nx serve finhq-foundation

# Test the API
curl -X POST http://localhost:7080/v1/tags \
  -H "Content-Type: application/json" \
  -H "X-Finhq-Mode: LIVE" \
  -H "X-Finhq-Org-Id: org_test" \
  -H "X-Finhq-Namespace-Id: ns_test" \
  -d '{
    "name": "Important",
    "color": "#FF5733",
    "description": "High priority items"
  }'
```

---

## Summary: Files Created

| File | Purpose |
|------|---------|
| `foundation.yaml` | OpenAPI specification |
| `V10__create_tags.sql` | Database migration |
| `TagEntity.java` | JPA entity |
| `TagRepository.java` | Repository interface |
| `TagRepositoryImpl.java` | Repository implementation |
| `TagJpaRepository.java` | Spring Data interface |
| `TagMapper.java` | DTO â†” Entity conversion |
| `TagValidator.java` | Business validation |
| `TagSpecification.java` | Query specifications |
| `TagService.java` | Service layer |

---

## Key Patterns Used

1. **Entity extends AbstractNamespaceScopedEntity** - Automatic org/namespace scoping
2. **Repository extends Repository<T>** - Custom repository with scoping
3. **Mapper implements EntityMapper** - Clean DTO conversion
4. **Validator implements EntityRequestValidator** - Centralized validation
5. **Service extends AbstractService** - Standard CRUD operations
6. **Service implements *ApiDelegate** - OpenAPI integration
