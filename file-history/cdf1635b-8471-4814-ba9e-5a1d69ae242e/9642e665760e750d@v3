# CCBP Settlement Flow - Sequence Diagrams

---

## Current Settlement Flow (Existing - Non-Compliant)

```mermaid
sequenceDiagram
    participant User
    participant CRED as CRED App<br/>(Agent/DTPL)
    participant CCBP as CCBP LOB System<br/>(DTPL)
    participant PA_Darwin as PA Darwin System<br/>(DPSPL)
    participant PA_Escrow as PA Escrow<br/>(Axis/Stanc)
    participant OU_Escrow as OU Escrow<br/>(Stanc)
    participant OD as Stanc OD<br/>(Overdraft)
    participant NBBL as NBBL
    participant Biller as Biller

    %% Payment Initiation
    rect rgb(255, 248, 220)
        Note over User, PA_Darwin: Step 1 & 2: Payment Initiation & Registration
        User->>CRED: Initiate credit card bill payment
        CRED->>PA_Darwin: Register transaction
        PA_Darwin-->>CCBP: Send response
        PA_Darwin->>PA_Darwin: Log transaction
        CCBP->>CCBP: Record transaction for reference
    end

    %% Post-Transaction Logic (CCBP/DTPL)
    rect rgb(255, 200, 200)
        Note over CCBP, OU_Escrow: Step 3: Post-Transaction Logic (DTPL Controls)
        CCBP->>CCBP: Execute Routing Logic<br/>(Determine PA escrow → OU account)
        CCBP->>CCBP: Execute Settlement Logic<br/>(UPI: 8x/day, NB: T+1)
        CCBP->>CCBP: Agent Institution Bookkeeping
    end

    %% Payout Execution (Non-Compliant - DTPL directly debits PA escrow)
    rect rgb(255, 180, 180)
        Note over CCBP, OU_Escrow: Step 4: Payout Execution (NON-COMPLIANT)

        alt UPI Transactions (8 times/day)
            CCBP->>PA_Escrow: Direct Payout API call<br/>(BYPASSES PA settlement system)
            PA_Escrow->>OU_Escrow: Transfer ₹1,000<br/>(Full amount)
        else Net Banking Transactions (T+1)
            Note over OD, OU_Escrow: OD prefunds OU escrow (T+0)
            OD->>OU_Escrow: Prefund for NBBL debit

            Note over CCBP, OU_Escrow: PA settles to OU (T+1)
            CCBP->>PA_Escrow: Direct Payout API call<br/>(BYPASSES PA settlement system)
            PA_Escrow->>OU_Escrow: Transfer ₹1,000

            Note over OD, OU_Escrow: Return funds to OD
            OU_Escrow->>OD: Return prefunded amount
        end
    end

    %% NBBL Settlement
    rect rgb(240, 240, 255)
        Note over OU_Escrow, Biller: NBBL Settlement to Biller
        NBBL->>OU_Escrow: Debit ₹998<br/>(after switching fee)
        NBBL->>Biller: Settle to biller
    end
```

### Issues with Current Flow

| Issue | Description | Impact |
|-------|-------------|--------|
| **#1: Non-Compliant Settlement** | DTPL (merchant) directly calls Payout API to debit PA escrow | Debits not accounted in PA books; violates compliance |
| **#2: PA Settles More Than Received** | PA settles ₹1,000 but receives only ₹985 (after provider fee) | ₹15 shortfall covered by DTPL prefunding with no accounting |
| **#3: No OU Bookkeeping** | No tracking of fund "colour" in OU escrow | Cannot identify OU revenue; relies on approximations |

### Sample Transaction (Current Issues Illustrated)

| Step | Amount | Problem |
|------|--------|---------|
| Transaction Amount | ₹1,000 | - |
| Amount received from provider | ₹985 | Provider deducts ₹15 fee |
| PA settles to OU escrow | ₹1,000 | PA settling MORE than received |
| NBBL debits from OU escrow | ₹998 | - |
| **Unaccounted shortfall** | **₹15** | Covered by DTPL prefunding (no audit trail) |

---

## Proposed Solution 2 (Selected Approach)

```mermaid
sequenceDiagram
    participant User
    participant CRED as CRED App<br/>(Agent/DTPL)
    participant COU as COU System<br/>(Bill Fetch)
    participant PA as PA System<br/>(DPSPL Darwin)
    participant PA_Escrow as PA Escrow<br/>(Axis/Stanc)
    participant OU_Escrow as OU Escrow<br/>(Axis/Stanc)
    participant OD as Stanc OD<br/>(Overdraft)
    participant NBBL as NBBL
    participant Biller as Biller

    %% Bill Fetch & Display
    rect rgb(240, 248, 255)
        Note over User, COU: Bill Fetch Phase
        User->>CRED: Open bill payment
        CRED->>COU: Fetch bill for user
        COU-->>CRED: Return bill details
        CRED-->>User: Display bill
    end

    %% Payment Initiation
    rect rgb(255, 248, 220)
        Note over User, PA: Payment Initiation Phase
        User->>CRED: Initiate bill payment
        CRED->>PA: Execute payment transaction
        PA->>PA: Log transaction in Darwin
        PA-->>CRED: Transaction registered
    end

    %% Account Routing (DTPL as TSP)
    rect rgb(220, 255, 220)
        Note over CRED, PA: Account Routing Phase (DTPL as TSP)
        PA->>CRED: Trigger event (transaction context)
        CRED->>CRED: Determine source PA escrow<br/>& destination OU escrow
        CRED->>PA: Call Transfer API<br/>(source & destination accounts)
        PA->>PA: Lock transfer entity<br/>Store destination info
        PA-->>CRED: Transfer locked
    end

    %% Settlement Execution
    rect rgb(255, 230, 230)
        Note over PA, OU_Escrow: Settlement Phase

        alt UPI Transactions
            Note over PA, OU_Escrow: Settled 8 times per day
            PA->>PA_Escrow: Initiate payout
            PA_Escrow->>OU_Escrow: Transfer funds<br/>(Net settlement amount)
        else Net Banking/DC Transactions
            Note over PA, OU_Escrow: Settled at T+1
            PA->>PA_Escrow: Initiate payout
            PA_Escrow->>OU_Escrow: Transfer funds<br/>(Net settlement amount)
        end
    end

    %% OD Management (for NB/DC)
    rect rgb(230, 230, 255)
        Note over OD, OU_Escrow: OD Management (NB/DC only)

        Note right of OD: Before PA settlement (T+0)
        OD->>OU_Escrow: Prefund (cover NBBL debit)

        Note right of OD: After PA settlement (T+1)
        OU_Escrow->>OD: Return funds after<br/>PA settlement received
    end

    %% NBBL Settlement to Biller
    rect rgb(255, 240, 245)
        Note over OU_Escrow, Biller: NBBL Settlement Phase
        NBBL->>OU_Escrow: Debit settlement amount
        NBBL->>Biller: Settle to biller
    end
```

## Key Entities & Responsibilities

| Entity | Role |
|--------|------|
| **CRED (DTPL)** | Agent Institution - Displays bills, collects payments, acts as TSP for account routing between PA & OU escrows |
| **PA System (DPSPL)** | Logs transactions, collects into PA escrow, settles to OU escrow based on Agent instructions |
| **COU System** | Fetches bills from BBPS, ensures settlement to NBBL |
| **NBBL** | Debits OU escrow, settles to billers |

## Settlement Cycles

| Payment Method | Settlement Frequency | Notes |
|----------------|---------------------|-------|
| UPI | 8 times per day | Same-day settlement |
| Net Banking | T+1 | OD prefunding required |
| Debit Card | T+1 | OD prefunding required |

## Net Settlement Formula

```
Settlement Amount = (Transaction Amount - PA MDR) - (OU Revenue - Switching Fee)

Where:
- PA MDR = Provider Fee + 10% of Provider Fee
- OU Revenue = Interchange income from NBBL
- Switching Fee = NBBL flat fee
```

## Sample Calculation

| Item | Amount |
|------|--------|
| Transaction Amount (A) | ₹1,000 |
| Provider Fee + GST | ₹9.44 |
| PA MDR (1.1 × Provider Fee) | ₹10.384 |
| OU Interchange Income | ₹2.25 |
| NBBL Switching Fee | ₹0.25 |
| **Net Settlement (PA → OU)** | **₹987.616** |

---

## Current vs Proposed: Key Differences

| Aspect | Current Flow | Proposed Flow (Solution 2) |
|--------|--------------|---------------------------|
| **Who initiates payout?** | DTPL (merchant) directly calls Payout API | PA system initiates based on DTPL instructions |
| **PA system involvement** | Bypassed during settlement | Fully involved - logs, locks, and executes settlement |
| **Bookkeeping** | Not maintained in PA books | Proper GL entries at PA level |
| **Account routing decision** | Made by DTPL | Made by DTPL (as TSP), communicated via Transfer API |
| **Compliance** | Non-compliant (merchant debits PA escrow) | Compliant (PA controls its own escrow) |
| **Settlement amount** | Full transaction amount (₹1,000) | Net amount after PA MDR & OU adjustments (₹987.62) |
| **Shortfall handling** | DTPL prefunding with no accounting | Properly accounted via PA MDR deduction |
| **DTPL role** | Direct escrow access | TSP for account orchestration only |
