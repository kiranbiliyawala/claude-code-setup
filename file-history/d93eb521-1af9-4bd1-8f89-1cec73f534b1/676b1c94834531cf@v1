# 01 - Overview & Architecture

> **Reading Time:** 45 minutes
> **Prerequisites:** None
> **Next:** [02-data-layer.md](./02-data-layer.md)

---

## Table of Contents
1. [Technology Stack](#technology-stack)
2. [Project Structure](#project-structure)
3. [Core Concepts](#core-concepts)
4. [API Endpoints](#api-endpoints)
5. [Authentication & Security](#authentication--security)
6. [Internal Service Dependencies](#internal-service-dependencies)
7. [Configuration](#configuration)

---

## Technology Stack

### Core Technologies

| Technology | Version | Purpose |
|------------|---------|---------|
| **Java** | 17 | Runtime (Amazon Corretto) |
| **Spring Boot** | 2.7.14 | Application framework |
| **Gradle** | 7.6 | Build tool |
| **MySQL** | - | Primary database |
| **DynamoDB** | - | Workflow state storage |
| **Redis (Redisson)** | 3.19.1 | Distributed cache & locks |
| **Kafka** | - | Event streaming |
| **AWS SQS** | - | Async task processing |
| **Hibernate** | 5.x | ORM |
| **HikariCP** | - | Connection pooling |

### Key Libraries

| Library | Version | Purpose |
|---------|---------|---------|
| Lombok | - | Boilerplate reduction |
| MapStruct | 1.4.2 | Object mapping |
| Guava | - | EventBus, collections |
| Jackson | - | JSON processing |
| JaCoCo | - | Code coverage |
| Caffeine | - | In-memory caching |

### Server Configuration

```properties
server.port=9010
server.servlet.context-path=/payments
```

---

## Project Structure

### Root Directory
```
payment-service/
├── src/
│   ├── main/
│   │   ├── java/in/dreamplug/darwin/    # Main source code
│   │   └── resources/
│   │       └── application.properties    # Main config (1300+ lines)
│   └── test/                             # Test code
├── codepipeline/                         # CI/CD configs
├── build.gradle                          # Dependencies
├── Dockerfile                            # Container setup
├── README.md                             # Project readme
└── settings.gradle                       # Gradle settings
```

### Source Code Structure

```
src/main/java/in/dreamplug/darwin/
│
├── DarwinApplication.java           # Entry point
│
├── controller/                      # REST Controllers
│   ├── v2/                          # V2 API (Primary)
│   │   ├── order/                   # Order endpoints
│   │   ├── payment/                 # Payment endpoints
│   │   └── paymentattempt/          # Payment attempt endpoints
│   ├── WebhookController.java       # Generic webhooks
│   └── admin/                       # Admin endpoints
│
├── service/                         # Business logic
│   ├── PaymentProviderService.java
│   ├── WebhookService.java
│   └── ...
│
├── v2/                              # V2 Implementation
│   ├── service/                     # V2 services
│   └── workflow/                    # CRITICAL: Workflows
│       └── create/
│           ├── Workflow.java             # Base workflow
│           ├── payments/                 # Payment workflows
│           ├── paymentattempts/          # Attempt workflows
│           └── providers/                # 24+ provider adapters
│
├── entity/                          # JPA Entities
│   ├── commons/                     # Base entities
│   │   └── BaseEntity.java
│   ├── provider/                    # Provider entities
│   │   └── BaseExternalEntity.java
│   ├── v2/                          # V2 entities (Primary)
│   │   ├── PaymentV2Entity.java
│   │   ├── PaymentAttemptV2Entity.java
│   │   ├── RefundEntity.java
│   │   └── FeeEntity.java
│   ├── OrderEntity.java
│   ├── ClientEntity.java
│   ├── CustomerEntity.java
│   └── ProviderAccountEntity.java
│
├── repository/                      # Data access layer
│   ├── OrderRepository.java
│   ├── PaymentRepository.java
│   ├── PaymentAttemptRepository.java
│   └── read_only_repository/        # Replica repositories
│
├── statemachine/                    # State machines
│   ├── payment/                     # Payment state machine
│   │   └── PaymentStateMachine.java
│   ├── order/                       # Order state machine
│   │   └── OrderStateMachine.java
│   └── RefundStateMachine.java
│
├── planner/                         # Decision tree routing
│   └── providerdecider/
│       ├── ProviderDeciderRouter.java
│       ├── ProviderDeciderV2.java
│       └── ProviderDeciderViaLCM.java
│
├── cache/                           # Caching layer
│   ├── ClientConfigurationCache.java
│   ├── PaymentProviderCache.java
│   ├── DecisionTreeObjectCache.java
│   └── ...
│
├── client/                          # External service clients
│   ├── arsenal/                     # Instrument vault
│   ├── fee/                         # Fee service
│   ├── lcm/                         # Lending cloud manager
│   └── ...
│
├── configuration/                   # Spring configs
│   ├── database/                    # Database configs
│   │   ├── MasterDataSourceConfiguration.java
│   │   └── ReplicaDataSourceConfiguration.java
│   ├── CacheConfig.java
│   └── RedissonAutoConfiguration.java
│
├── kafka/                           # Kafka integration
│   ├── MessagingConfigs.java
│   └── dto/                         # Kafka event DTOs
│
├── sqs/                             # SQS integration
│   ├── DarwinSQSMessageProcessor.java
│   └── ...
│
├── dynamo/                          # DynamoDB integration
│   ├── dao/                         # DynamoDB DAOs
│   └── domain/                      # DynamoDB entities
│
├── error/                           # Error handling
│   ├── Error.java                   # Error enum
│   └── ProviderException.java
│
├── dto/                             # Data transfer objects
│
├── commons/spring/filters/          # Request filters
│   ├── ApplicationContextBuilderFilter.java
│   └── PAMerchantAuthenticationFilter.java
│
└── processors/                      # Processors
    └── instrumenttype/              # Instrument processors
        ├── InstrumentTypeProcessorManager.java
        ├── CardInstrumentTypeProcessor.java
        └── UPIPayInstrumentTypeProcessor.java
```

---

## Core Concepts

### 1. Payment Hierarchy

```
Order (1)
    └── Payment (M)
            └── PaymentAttempt (M)
                    └── RefundAttempt (M via Refund)
```

- **Order:** Top-level transaction container
- **Payment:** Represents a payment mode (card, UPI, etc.)
- **PaymentAttempt:** Actual provider call
- **Refund:** Reversal of a payment attempt

### 2. Entity Lifecycle (State Machine)

```
CREATED → PROCESSING → AUTHORIZED → COMPLETED
                   ↘ FAILED
                   ↘ BLOCKED
```

### 3. Workflow Pattern

All creation operations follow a 7-step workflow:

```java
1. validateAndEnrichContext()    // Validate & enrich data
2. persistIntent()               // Save to MySQL (transactional)
3. publishEntityPrePersistEvents() // Pre-persist hooks
4. persistNonRelationalIntent()  // Save to DynamoDB
5. process()                     // Provider API call
6. postProcess()                 // Update with response (transactional)
7. publishEntityChangeEvents()   // Trigger state machines
```

### 4. Provider Routing

```
Request → ProviderDeciderRouter
              │
              ├── LCM (Lending Cloud Manager) - if supported
              │
              └── Decision Tree - JSON rules
                      │
                      └── Provider Adapter Selection
```

### 5. Event-Driven Architecture

```
Workflow completes
    │
    └── EventBus.post(PaymentAttemptEvent)
            │
            ├── PaymentStateMachine.onEvent()
            │       └── Updates Payment status
            │               │
            │               └── EventBus.post(PaymentEvent)
            │                       │
            │                       └── OrderStateMachine.onEvent()
            │                               └── Updates Order status
            │
            └── EventiService.publishEvent()
                    └── External notifications
```

---

## API Endpoints

### Primary Endpoints (V2)

| Method | Endpoint | Controller | Purpose |
|--------|----------|------------|---------|
| POST | `/v2/orders` | OrderV2Controller | Create order |
| GET | `/v2/orders/{orderId}` | OrderV2Controller | Get order |
| POST | `/v2/orders/{orderId}/payments` | PaymentV2Controller | Bulk create payments |
| POST | `/v2/payments/{paymentId}/attempts` | PaymentAttemptV2Controller | Create payment attempt |
| POST | `/v2/payments/by-order-id/{orderId}/attempts` | PaymentAttemptV2Controller | Create attempt by order |
| POST | `/v1/webhooks` | WebhookController | Generic webhook |

### Provider Webhook Endpoints

| Endpoint | Controller | Provider |
|----------|------------|----------|
| `/webhooks/v2/cashfree` | CashfreeWebhookController | Cashfree |
| `/webhooks/v2/razorpay` | RazorpayWebhookController | Razorpay |
| `/webhooks/v2/payu` | PayuWebhookController | PayU |
| `/webhooks/v2/juspay` | JuspayWebhookController | Juspay |
| `/webhooks/v2/cybersource` | CybersourceWebhookController | Cybersource |
| `/webhooks/v2/ybl` | YBLWebhookController | Yes Bank UPI |
| `/webhooks/v2/icici` | ICICIWebhookController | ICICI UPI |
| `/webhooks/v2/rbl-upi` | RBLUpiWebhookController | RBL UPI |
| `/webhooks/v2/digio` | DigioWebhookController | Digio (eMandate) |

### Admin Endpoints

| Endpoint | Purpose |
|----------|---------|
| `/v1/admin/orders/*` | Order management |
| `/v1/admin/payment-attempts/*` | Payment attempt management |
| `/v1/admin/refunds/*` | Refund management |

---

## Authentication & Security

### Request Filters (Execution Order)

1. **ApplicationContextBuilderFilter**
   - Builds application context from headers
   - Validates Client ID or Merchant ID
   - Enriches with device info

2. **PAMerchantAuthenticationFilter**
   - Partner merchant authentication
   - Validates access token with Syndicate service

3. **PAPartnerAuthorizationFilter**
   - Partner authorization validation

### Required Headers

| Header | Purpose | Required |
|--------|---------|----------|
| `${CLIENT_HEADER_KEY}` | Client identifier | Yes (or Merchant) |
| `${MERCHANT_HEADER_KEY}` | Merchant identifier | Yes (or Client) |
| `DEVICE_ID` | Device identifier | Optional |
| `OS` | Operating system | Optional |
| `OS_VERSION` | OS version | Optional |
| `APP_VERSION` | App version | Optional |

### Rate Limiting

- Redisson-based distributed rate limiting
- Configuration in `ClientRateLimiter.java`
- Stored in `ProviderRateLimitConfigRepository`

---

## Internal Service Dependencies

| Service | Client Library | Purpose |
|---------|---------------|---------|
| **User Service** | `user-service-client:4.0.1` | User data retrieval |
| **Merchant Service** | `merchant-service-client:1.0.3` | Merchant info |
| **Mandate Service** | `mandate-java-client:1.0.4` | Recurring payments |
| **Arsenal** | Custom client | Instrument vault (tokenization) |
| **Falcon** | Custom client | Offers/promotions |
| **Genie** | `genie-java-client` | Configuration service |
| **Syndicate** | Custom client | Authentication |
| **LCM** | Custom client | Terminal resolution |
| **Fee Service** | `fees:0.18.0` | Fee calculation |
| **Narad** | Custom client | Dynamic routing |
| **Invoker** | Custom client | Task invocation |
| **Leia** | Custom client | ID generation |
| **Vault** | Custom client | Token vaulting |

---

## Configuration

### Main Configuration File

**Location:** `src/main/resources/application.properties` (1300+ lines)

### Key Configuration Sections

```properties
# Server
server.port=9010
server.servlet.context-path=/payments

# Database - Master
spring.datasource.url=jdbc:mysql://${DB_HOST}:3306/${DB_NAME}
spring.datasource.username=${DB_USER}
spring.datasource.password=${DB_PASSWORD}

# Database - Replica
replica.datasource.url=jdbc:mysql://${REPLICA_DB_HOST}:3306/${REPLICA_DB_NAME}

# Redis
aws.elastiCache.url=${REDIS_ADDRESS:127.0.0.1}
aws.elastiCache.port=${REDIS_PORT:6379}

# Kafka
messaging.kafka.enabled=true
messaging.kafka.topic=payment-attempt-platform-metrics-pinot-out-new-1

# SQS Queues
sqs.force-payment-failure-queue=...
sqs.mandate-expiry-cron-queue=...
sqs.refund-reschedule-queue=...
sqs.order-expiry-queue=...
```

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `DB_HOST` | MySQL master host | stage-master-db.stg.dreamplug.net |
| `DB_NAME` | Database name | payments_multi_tenancy |
| `REPLICA_DB_HOST` | MySQL replica host | - |
| `REDIS_ADDRESS` | Redis address | 127.0.0.1 |
| `REDIS_PORT` | Redis port | 6379 |
| `DP_RUN_ENV` | Deployment environment | - |

---

## Entry Point

**File:** `src/main/java/in/dreamplug/darwin/DarwinApplication.java`

```java
@SpringBootApplication
@EnableRetry
@EntityScan(basePackages = {"in.dreamplug"})
@EnableAspectJAutoProxy(exposeProxy = true)
@EnableScheduling
@ComponentScan(basePackages = {"in.dreamplug"})
public class DarwinApplication {
    public static void main(String[] args) {
        TimeZone.setDefault(TimeZone.getTimeZone("UTC"));
        SpringApplication.run(DarwinApplication.class, args);
    }
}
```

**Key Annotations:**
- `@EnableRetry` - Spring Retry support
- `@EnableAspectJAutoProxy` - AOP proxying (for self-referencing beans)
- `@EnableScheduling` - Scheduled tasks
- `@EntityScan` - JPA entity scanning

---

## Quick Reference: First Files to Study

1. **Entry Point:** `DarwinApplication.java`
2. **Base Workflow:** `v2/workflow/create/Workflow.java`
3. **Payment Attempt:** `v2/workflow/create/paymentattempts/PaymentAttemptCreateWorkflow.java`
4. **State Machine:** `statemachine/payment/PaymentStateMachine.java`
5. **Provider Routing:** `planner/providerdecider/ProviderDeciderRouter.java`
6. **Config:** `application.properties` (scan first 200 lines)

---

## Next Steps

After completing this overview:
1. [ ] Explore `DarwinApplication.java`
2. [ ] Run `./gradlew build` to ensure the project compiles
3. [ ] Review `application.properties` structure
4. [ ] Proceed to [02-data-layer.md](./02-data-layer.md)

---

*Next: [02 - Data Layer Deep-Dive](./02-data-layer.md)*
