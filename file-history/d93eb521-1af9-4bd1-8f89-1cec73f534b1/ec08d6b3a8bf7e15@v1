# 03 - Provider Integration Deep-Dive

> **Reading Time:** 75 minutes
> **Prerequisites:** [02-data-layer.md](./02-data-layer.md)
> **Next:** [04-payment-flow.md](./04-payment-flow.md)

---

## Table of Contents
1. [Provider Adapter Architecture](#provider-adapter-architecture)
2. [Factory Pattern for Adapter Selection](#factory-pattern-for-adapter-selection)
3. [Decision Tree Routing](#decision-tree-routing)
4. [Provider Implementations](#provider-implementations)
5. [Webhook Handling](#webhook-handling)
6. [Provider Configuration](#provider-configuration)
7. [Error Handling & Retry Logic](#error-handling--retry-logic)

---

## Provider Adapter Architecture

### Base Adapter Pattern
**File:** `v2/workflow/create/providers/IPaymentProviderAdapter.java`

```java
public abstract class IPaymentProviderAdapter<T, R> implements SelfReferencingBean {
    protected final PaymentProviderKey paymentProviderKey;  // e.g., CASHFREE, CYBERSOURCE
    private final InstrumentType instrumentType;            // e.g., CARD, UPI_APPS
    private final OrderType orderType;                      // e.g., PAY, REFUND

    // Core lifecycle methods
    public abstract ProviderPaymentResponse createPaymentAttempt(context, customerEntity);
    protected abstract Object syncPaymentAttemptWithProviderId(paymentAttemptEntity);
    protected abstract ProviderRefundCreateResponse createRefund(refundAttemptEntity, context);
    protected abstract R getAuthConfig(providerAccountEntity);
}
```

### Provider Response Structure

```java
@Data @Builder
public class ProviderPaymentResponse {
    private Object providerResponseObject;     // Raw provider response
    private String providerReferenceId;        // Provider's transaction ID
    private String gatewayReferenceId;         // Gateway ID
    private String providerStatus;             // Raw status ("SUCCESS")
    private PaymentAttemptStatus status;       // Mapped internal status
    private ProviderRequestStatus providerRequestStatus;  // REQUEST_SUCCESS, RETRY_ABLE_FAILURE
    private ProviderError providerError;       // Error details if failed
}
```

### Adapter Inheritance Diagram

```
IPaymentProviderAdapter<T, R>
    │
    ├── CashfreeProviderAdapter
    │       ├── CashfreeCardProviderAdapter
    │       ├── CashfreeNetBankingProviderAdapter
    │       ├── CashfreeUPIProviderAdapter
    │       └── CashfreeUPIAppsProviderAdapter
    │
    ├── I3DSPaymentProviderAdapter
    │       └── CybersourceProviderAdapter
    │               ├── CybersourceCardProviderAdapter
    │               └── CybersourceEMandateProviderAdapter
    │
    ├── PayuProviderAdapter
    │       └── PayuCardProviderAdapter
    │
    ├── PineLabsEdgeProviderAdapter
    │
    ├── CredPointsProviderAdapter
    │
    └── AuthTokenNativeProviderAdapter
```

---

## Factory Pattern for Adapter Selection

### PaymentProviderFactory
**File:** `v2/workflow/create/providers/PaymentProviderFactory.java`

```java
@Component
public class PaymentProviderFactory {
    // Multi-dimensional lookup: OrderType + ProviderKey + InstrumentType → Adapter
    private Map<PaymentWorkflowKey, IPaymentProviderAdapter<?, ?>> paymentProviderMap;

    // Secondary lookup: OrderType + ProviderKey → First adapter
    private Table<OrderType, PaymentProviderKey, IPaymentProviderAdapter<?, ?>> paymentProviderByKey;

    // 3DS variant support
    private ThreeDSType threeDSType;  // 3DS1 vs 3DS2

    public IPaymentProviderAdapter<?, ?> findPaymentProviderAdapter(
            OrderType orderType,
            PaymentProviderKey providerKey,
            InstrumentType instrumentType,
            ThreeDSType threeDSType) {

        PaymentWorkflowKey key = new PaymentWorkflowKey(
            orderType, providerKey, instrumentType, threeDSType);

        return paymentProviderMap.get(key);
    }
}
```

### PaymentWorkflowKey Structure

```java
@Value
public class PaymentWorkflowKey {
    OrderType orderType;           // PAY, REFUND
    PaymentProviderKey providerKey; // CASHFREE, CYBERSOURCE, etc.
    InstrumentType instrumentType;  // CARD, UPI_APPS, NET_BANKING
    ThreeDSType threeDSType;        // THREE_DS_1, THREE_DS_2, NONE
}
```

---

## Decision Tree Routing

### Router Strategy Pattern
**File:** `planner/providerdecider/ProviderDeciderRouter.java`

```java
@Service
public class ProviderDeciderRouter {
    public ProviderRoutingDecisionResult resolve(PaymentAttemptCreateContext context) {
        // Priority 1: LCM routing (if instrument supported)
        if (isInstrumentTypeSupportedInLCM(clientId, instrumentType)) {
            return providerDeciderViaLCM.decideProvider(context);
        }

        // Priority 2: Decision Tree routing
        if (isDecisionTreeEnabled) {
            return providerDeciderV2.decideProvider(context);
        }

        throw Error.provider_routing_failed.getBuilder().build();
    }
}
```

### Routing Flow Diagram

```
Request
    │
    ▼
┌─────────────────────────────┐
│   ProviderDeciderRouter     │
└─────────────────────────────┘
    │
    ├── Is LCM supported for instrument?
    │       │
    │       YES ──► ProviderDeciderViaLCM
    │                   │
    │                   └── Call LCM service for terminal resolution
    │
    NO
    │
    ▼
┌─────────────────────────────┐
│   ProviderDeciderV2         │
│   (Decision Tree Routing)   │
└─────────────────────────────┘
    │
    ├── Fetch cached Decision Tree
    ├── Build DT Context from request
    ├── Execute tree rules
    ├── Apply dynamic routing (Narad)
    │
    ▼
┌─────────────────────────────┐
│  ProviderRoutingDecisionResult │
│  ├── providerKey             │
│  ├── providerAccountEntity   │
│  ├── decisionTreeId          │
│  └── routingMetadata         │
└─────────────────────────────┘
```

### Decision Tree Caching
**File:** `cache/DecisionTreeObjectCache.java`

```java
@Component
public class DecisionTreeObjectCache extends AbstractDPManagedCache {

    @DPCache(cacheName = "decision_tree_object_cache")
    private LoadingCache<Long, DecisionTreeWithWorkflow> cache;

    @Override
    public void buildCache() {
        cache = DPCacheBuilder.getBuilder()
            .refreshAfterWrite(
                generateRandomCacheRefreshInterval(180),  // 180-190 min
                TimeUnit.MINUTES)
            .build(this::loadDecisionTree);
    }

    private DecisionTreeWithWorkflow loadDecisionTree(Long treeId) {
        // Load JSON, parse rules, build workflow
    }
}
```

### Decision Tree Factors

| Factor | Description |
|--------|-------------|
| Client ID | Which merchant/client |
| Instrument Type | Card, UPI, NetBanking |
| Card Brand | Visa, Mastercard, RuPay |
| Card BIN | First 6-8 digits |
| Card Type | Credit, Debit |
| Amount | Transaction amount |
| Currency | INR, USD |
| Customer Attributes | VIP, risk score |
| Provider Health | Uptime, success rate |

---

## Provider Implementations

### Directory Structure

```
v2/workflow/create/providers/
├── IPaymentProviderAdapter.java          # Base abstract class
├── I3DSPaymentProviderAdapter.java       # 3DS base class
├── PaymentProviderFactory.java           # Factory
│
├── CashfreeProviderAdapter.java          # Cashfree base
├── CashfreeCardProviderAdapter.java
├── CashfreeNetBankingProviderAdapter.java
├── CashfreeUPIProviderAdapter.java
├── CashfreeUPIAppsProviderAdapter.java
│
├── cybersource/
│   ├── CybersourceProviderAdapter.java   # Cybersource base (3DS)
│   ├── CybersourceRequestBuilder.java
│   └── CybersourceAuthorizeRequestBuilder.java
│
├── PayuProviderAdapter.java
├── PayuCardProviderAdapter.java
│
├── PineLabsEdgeProviderAdapter.java
├── CredPointsProviderAdapter.java
├── RewardPointsProviderAdapter.java
└── AuthTokenNativeProviderAdapter.java
```

### Supported Providers

| Provider | Payment Types | Key Features |
|----------|---------------|--------------|
| **Cashfree** | Cards, UPI, NetBanking | Two-phase order+payment |
| **Cybersource** | Cards, 3DS, E-Mandates | 3DS1/3DS2, step-up auth |
| **PayU** | Cards, NetBanking | Hash-based auth |
| **Pine Labs** | Multiple modes | Edge integration |
| **Razorpay** | All types | Via webhooks |
| **Juspay** | Orchestration | Gateway aggregator |
| **ICICI UPI** | UPI | Direct bank integration |
| **Axis UPI** | UPI | Direct bank integration |
| **YBL UPI** | UPI | Yes Bank |
| **RBL UPI** | UPI | RBL Bank |
| **Digio** | E-Mandates | eNACH registration |
| **Cred Points** | Rewards | Point redemption |

### Cashfree Adapter Example
**File:** `v2/workflow/create/providers/CashfreeProviderAdapter.java`

```java
@Component
public abstract class CashfreeProviderAdapter
        extends IPaymentProviderAdapter<String, CashfreeAuthConfig> {

    @Override
    public ProviderPaymentResponse createPaymentAttempt(
            PaymentAttemptCreateContext context,
            CustomerEntity customer) {

        CashfreeAuthConfig authConfig = getAuthConfig(context.getProviderAccountEntity());

        // Phase 1: Create Cashfree Order
        Pair<BaseResponse<CreateOrderResponse>, ProviderError> orderResponse =
            createCFOrder(context, authConfig);

        if (orderResponse.getRight() != null) {
            return buildErrorResponse(orderResponse.getRight());
        }

        // Phase 2: Create Cashfree Payment
        Pair<BaseResponse<CreatePaymentResponse>, ProviderError> paymentResponse =
            createCFPayment(context, orderResponse.getLeft().getResponse(), authConfig);

        return mapToProviderPaymentResponse(paymentResponse);
    }

    protected abstract Pair<BaseResponse<CreatePaymentResponse>, ProviderError>
        createCFPayment(context, orderResponse, authConfig);
}
```

### Cybersource Adapter (3DS Support)
**File:** `v2/workflow/create/providers/cybersource/CybersourceProviderAdapter.java`

```java
@Component
public abstract class CybersourceProviderAdapter
        extends I3DSPaymentProviderAdapter<String, AuthConfig> {

    // Status code mappings
    private static final List<String> FAILED_STATUSES = Arrays.asList(
        "101", "102", "104", "150", "200", "201", "202", "203",
        "204", "205", "207", "208", "209", "210", "211", "221",
        "222", "230", "231", "232", "233", "234", "236", "240",
        "250", "475", "476", "481", "520", "700", "701", "702",
        "703", "704", "750", "751", "752", "777"
    );

    private static final List<String> PROCESSING_STATUSES = Arrays.asList(
        "110", "475", "480"
    );

    @Override
    public ProviderPaymentResponse createPaymentAttempt(context, customer) {
        // Build authorization request
        CreatePaymentRequest request = cybersourceRequestBuilder
            .buildAuthorizationRequest(context, customer);

        // Execute API call
        PtsV2PaymentsPost201Response response = apiClient.createPayment(request);

        // Handle 3DS if required
        if (requires3DS(response)) {
            return handle3DSResponse(response, context);
        }

        return mapToProviderPaymentResponse(response);
    }

    // 3DS2 redirection flow
    protected void createRedirectionHtml(response, paymentAttemptEntity) {
        AuthenticationInfo authInfo = response.getConsumerAuthenticationInformation();

        if (authInfo.getSpecificationVersion().startsWith("2")) {
            // 3DS2 flow with step-up URL
            String html = authenticationService.createAuthenticationPageFor3ds2(
                authInfo.getStepUpUrl(),
                authInfo.getAccessToken(),
                paymentAttemptEntity.getExternalId());

            saveRedirectionDetail(paymentAttemptEntity, html);
        }
    }
}
```

---

## Webhook Handling

### Webhook Architecture

```
Provider sends webhook
         │
         ▼
┌─────────────────────────────────────┐
│   /webhooks/v2/{provider}           │
│   Provider-Specific Controller       │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│   Signature Verification            │
│   (Provider-specific)               │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│   WebhookService                    │
│   ├── Find PaymentAttempt           │
│   ├── Audit webhook data            │
│   └── Sync status with provider     │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│   State Machine Events              │
│   ├── PaymentStateMachine           │
│   └── OrderStateMachine             │
└─────────────────────────────────────┘
```

### Webhook Controllers

| Endpoint | Controller | Provider |
|----------|------------|----------|
| `/webhooks/v2/cashfree` | CashfreeWebhookController | Cashfree |
| `/webhooks/v2/razorpay` | RazorpayWebhookController | Razorpay |
| `/webhooks/v2/payu` | PayuWebhookController | PayU |
| `/webhooks/v2/cybersource` | CybersourceWebhookController | Cybersource |
| `/webhooks/v2/juspay` | JuspayWebhookController | Juspay |
| `/webhooks/v2/ybl` | YBLWebhookController | Yes Bank UPI |
| `/webhooks/v2/icici` | ICICIWebhookController | ICICI UPI |
| `/webhooks/v2/rbl-upi` | RBLUpiWebhookController | RBL UPI |
| `/webhooks/v2/digio` | DigioWebhookController | Digio |

### Cashfree Webhook Example
**File:** `controller/v2/CashfreeWebhookController.java`

```java
@RestController
@RequestMapping("/webhooks/v2/cashfree")
public class CashfreeWebhookController {

    @PostMapping
    public void onWebhookReceive(@RequestBody CashfreeWebhook webhookRequest) {
        switch (webhookRequest.getType()) {
            case PAYMENT_SUCCESS_WEBHOOK:
            case PAYMENT_FAILED_WEBHOOK:
                processPaymentWebhook(webhookRequest);
                break;

            case REFUND_STATUS_WEBHOOK:
                processRefundWebhook(webhookRequest);
                break;
        }
    }

    private void processPaymentWebhook(CashfreeWebhook webhook) {
        PaymentWebhookData data = webhook.getData();
        String providerRefId = data.getCfPaymentId();

        // 1. Fetch payment attempt by provider reference
        PaymentAttemptV2Entity attempt = paymentAttemptFetchWorkflow
            .fetchByProviderReferenceId(providerRefId);

        // 2. Audit webhook data
        auditService.auditProviderData(
            webhook,
            attempt.getId(),
            AuditType.WEBHOOK);

        // 3. Sync status (triggers state machine)
        cashfreeProviderAdapter.syncPaymentAttemptWithWebhook(
            attempt,
            webhook);
    }
}
```

### Idempotency Handling

```java
// In base adapter - only process if status changed
public void syncPaymentAttemptWithProvider(PaymentAttemptV2Entity entity) {
    String previousStatus = entity.getProviderStatus();

    Object providerResponse = syncPaymentAttemptWithProviderId(entity);

    // Only audit and trigger events if status actually changed
    if (!Objects.equals(previousStatus, entity.getProviderStatus())) {
        auditService.auditProviderData(providerResponse, entity.getId(), SYNC);
        publishStatusChangeEvent(entity);
    }
}
```

---

## Provider Configuration

### ProviderAccountEntity
**File:** `entity/ProviderAccountEntity.java`

```java
@Entity @Table(name = "provider_accounts")
public class ProviderAccountEntity extends BaseEntity {

    @ManyToOne
    @JoinColumn(name = "payment_provider_id")
    private PaymentProviderEntity paymentProvider;

    @Column(name = "provider_account_id")
    private String providerAccountId;     // e.g., "ACC_123456"

    @Lob
    @Column(name = "access_token")
    private byte[] accessToken;           // Encrypted credentials

    @Column(name = "endpoint")
    private String endpoint;              // Provider API endpoint

    @Column(name = "is_prod")
    private Boolean isProd;               // Production vs Sandbox

    @Column(name = "active")
    private Boolean active;

    @Column(name = "additional_config")
    private String additionalConfig;      // JSON configuration

    @Column(name = "provider_mid")
    private String providerMid;           // Merchant ID at provider

    @Column(name = "settlement_category")
    private String settlementCategory;    // Settlement routing
}
```

### PaymentProviderEntity
**File:** `entity/PaymentProviderEntity.java`

```java
@Entity @Table(name = "payment_providers")
public class PaymentProviderEntity extends BaseEntity {

    @Column(name = "name")
    private String name;                  // "Cashfree", "Cybersource"

    @Enumerated(EnumType.STRING)
    @Column(name = "key")
    private PaymentProviderKey key;       // CASHFREE, CYBERSOURCE

    @Column(name = "active")
    private Boolean active;

    @Convert(converter = SupportedInstrumentTypesConverter.class)
    @Column(name = "supported_instrument_types")
    private List<InstrumentType> supportedInstrumentTypes;
}
```

### Provider-Specific Configurations

```java
// Cashfree Configuration
@Data
public class CashfreeProviderAccountConfiguration {
    private String apiClientId;
    private String apiVersion;
    private ShortCircuitConfiguration shortCircuitConfiguration;
}

// Cybersource Configuration
@Data
public class CybersourceProviderAccountConfiguration {
    private String apiKey;
    private String merchantId;
    private Boolean enableRetries = false;
    private Boolean enableCaptureWithAuth = true;
    private Boolean enable3DS2 = true;
    private Boolean enableRedirectionFlow = false;
    private Integer timeout = 30000;
}

// PayU Configuration
@Data
public class PayuProviderAccountConfiguration {
    private String merchantKey;
    private String merchantSalt;
    private String hashVersion;
}
```

### Client-Provider Mapping
**File:** `entity/ClientPaymentProviderConfigEntity.java`

```java
@Entity @Table(name = "client_payment_provider_config")
public class ClientPaymentProviderConfigEntity extends BaseEntity {

    @ManyToOne
    @JoinColumn(name = "client_id")
    private ClientEntity client;

    @ManyToOne
    @JoinColumn(name = "payment_provider_id")
    private PaymentProviderEntity paymentProvider;

    @Column(name = "provider_config")
    private String providerConfig;  // JSON - client-specific overrides

    @Column(name = "active")
    private Boolean active;
}
```

---

## Error Handling & Retry Logic

### Error Classification

```java
public enum ProviderRequestStatus {
    REQUEST_SUCCESS,          // Payment processed successfully
    RETRY_ABLE_FAILURE,       // Timeout, rate limit - can retry
    NON_RETRY_ABLE_FAILURE    // Invalid request - cannot retry
}
```

### Provider Error Structure

```java
@Data @Builder
public class ProviderError {
    private String message;           // User-friendly message
    private String code;              // Provider error code
    private Object providerResponse;  // Raw error response
    private Boolean retryable;        // Retry classification
}
```

### Status Code Mapping (Cybersource)

| Category | Codes | Meaning |
|----------|-------|---------|
| **Success** | 100 | Approved |
| **Processing** | 110, 475, 480 | Pending, Timeout |
| **Decline** | 200-236 | Various declines |
| **System Error** | 150, 250, 520 | Internal errors |
| **Authentication** | 475, 476 | 3DS issues |

### Retry Pattern

```java
public ProviderPaymentResponse executePaymentAttempt(
        PaymentAttemptCreateContext context,
        BiFunction<PaymentAttemptCreateContext, ProviderCustomer,
                   ProviderPaymentResponse> pilotMethod,
        FlowType flowType) {
    try {
        return pilotMethod.apply(context, providerCustomer);

    } catch (RateLimitException rle) {
        // Retryable - provider rate limited us
        return ProviderPaymentResponse.builder()
            .providerRequestStatus(RETRY_ABLE_FAILURE)
            .providerError(ProviderError.builder()
                .message("Rate limited, please retry")
                .retryable(true)
                .build())
            .build();

    } catch (SocketTimeoutException ste) {
        // Retryable - network timeout
        return ProviderPaymentResponse.builder()
            .providerRequestStatus(RETRY_ABLE_FAILURE)
            .status(PaymentAttemptStatus.PROCESSING)
            .build();

    } catch (AppException ae) {
        // Non-retryable - validation error
        return ProviderPaymentResponse.builder()
            .providerRequestStatus(NON_RETRY_ABLE_FAILURE)
            .providerError(ProviderError.builder()
                .message(ae.getMessage())
                .retryable(false)
                .build())
            .build();
    }
}
```

### Circuit Breaker Configuration

```java
@Data
public class ShortCircuitConfiguration {
    private Boolean enabled = false;
    private Integer failureThreshold = 5;     // Failures before opening
    private Integer successThreshold = 3;      // Successes to close
    private Long waitDurationMs = 60000;       // Wait before half-open
    private Integer permittedCalls = 10;       // Calls in half-open state
}
```

---

## Key Provider Integration Files

### Core Architecture
1. `v2/workflow/create/providers/IPaymentProviderAdapter.java` - Base adapter
2. `v2/workflow/create/providers/PaymentProviderFactory.java` - Factory
3. `planner/providerdecider/ProviderDeciderRouter.java` - Routing strategy

### Decision Tree
1. `planner/providerdecider/ProviderDeciderV2.java` - DT workflow
2. `planner/providerdecider/ProviderDeciderViaLCM.java` - LCM routing
3. `cache/DecisionTreeObjectCache.java` - DT caching

### Webhooks
1. `controller/WebhookController.java` - Generic webhook endpoint
2. `controller/v2/CashfreeWebhookController.java` - Cashfree webhooks
3. `service/WebhookService.java` - Webhook processing

### Provider Implementations
1. `v2/workflow/create/providers/CashfreeProviderAdapter.java`
2. `v2/workflow/create/providers/cybersource/CybersourceProviderAdapter.java`
3. `v2/workflow/create/providers/PayuProviderAdapter.java`

### Configuration
1. `entity/ProviderAccountEntity.java` - Provider credentials
2. `entity/PaymentProviderEntity.java` - Provider definition
3. `entity/ClientPaymentProviderConfigEntity.java` - Client-provider mapping

---

## Checkpoint

After completing this section:
- [ ] Understand adapter pattern and factory selection
- [ ] Know how decision tree routing works
- [ ] Understand webhook processing flow
- [ ] Know error classification and retry patterns
- [ ] Proceed to [04-payment-flow.md](./04-payment-flow.md)

---

*Next: [04 - Payment Flow](./04-payment-flow.md)*
